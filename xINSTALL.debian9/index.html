



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="MISP Project - Install Guides">
      
      
        <link rel="canonical" href="https://www.misp-project.org/xINSTALL.debian9/">
      
      
        <meta name="author" content="MISP Project">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Debian stable - MISP Install Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#installation-instructions" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.misp-project.org/" title="MISP Install Documentation" class="md-header-nav__button md-logo">
          
            <img src="../img/misp.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              MISP Install Documentation
            </span>
            <span class="md-header-nav__topic">
              Debian stable
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/MISP/MISP" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MISP/MISP
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.misp-project.org/" title="MISP Install Documentation" class="md-nav__button md-logo">
      
        <img src="../img/misp.png" width="48" height="48">
      
    </a>
    MISP Install Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/MISP/MISP" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MISP/MISP
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Install Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Install Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.ubuntu1804/" title="Ubuntu 18.04" class="md-nav__link">
      Ubuntu 18.04
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.kali/" title="Kali Linux" class="md-nav__link">
      Kali Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.rhel7/" title="RHEL7/CentOS7" class="md-nav__link">
      RHEL7/CentOS7
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.rhel8/" title="RHEL8" class="md-nav__link">
      RHEL8
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      xInstall Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        xInstall Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL/" title="Warning" class="md-nav__link">
      Warning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.centos6/" title="Centos 6" class="md-nav__link">
      Centos 6
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Debian stable
      </label>
    
    <a href="./" title="Debian stable" class="md-nav__link md-nav__link--active">
      Debian stable
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#for-debian-99-stretch" title="for Debian 9.9 "stretch"" class="md-nav__link">
    for Debian 9.9 "stretch"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-misp-debian-stable-install-status" title="0/ MISP debian stable install - Status" class="md-nav__link">
    0/ MISP debian stable install - Status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-minimal-debian-install" title="1/ Minimal Debian install" class="md-nav__link">
    1/ Minimal Debian install
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-a-minimal-debian-9-stretch-server-system-with-the-software" title="Install a minimal Debian 9 "stretch" server system with the software:" class="md-nav__link">
    Install a minimal Debian 9 "stretch" server system with the software:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-configuration-variables" title="MISP configuration variables" class="md-nav__link">
    MISP configuration variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-etckeeper-and-sudo-optional" title="install etckeeper and sudo (optional)" class="md-nav__link">
    install etckeeper and sudo (optional)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="add the misp user to staff and www-data (mandatory)" class="md-nav__link">
    add the misp user to staff and www-data (mandatory)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-interface-name-salvage-optional" title="Network Interface Name salvage (optional)" class="md-nav__link">
    Network Interface Name salvage (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-your-system-is-up2date" title="Make sure your system is up2date" class="md-nav__link">
    Make sure your system is up2date
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-postfix-there-will-be-some-questions-optional" title="install postfix, there will be some questions. (optional)" class="md-nav__link">
    install postfix, there will be some questions. (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-install-lamp-dependencies" title="2/ Install LAMP &amp; dependencies" class="md-nav__link">
    2/ Install LAMP &amp; dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-all-the-dependencies-some-might-already-be-installed" title="Install all the dependencies (some might already be installed)" class="md-nav__link">
    Install all the dependencies (some might already be installed)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-all-changes" title="Apply all changes" class="md-nav__link">
    Apply all changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-misp-code" title="3/ MISP code" class="md-nav__link">
    3/ MISP code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cakephp" title="4/ CakePHP" class="md-nav__link">
    4/ CakePHP
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cakephp-is-included-as-a-submodule-of-misp" title="CakePHP is included as a submodule of MISP." class="md-nav__link">
    CakePHP is included as a submodule of MISP.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-set-the-permissions" title="5/ Set the permissions" class="md-nav__link">
    5/ Set the permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-create-a-database-and-user" title="6/ Create a database and user" class="md-nav__link">
    6/ Create a database and user
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enter-the-mysql-shell" title="Enter the mysql shell" class="md-nav__link">
    Enter the mysql shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copypaste" title="copy/paste:" class="md-nav__link">
    copy/paste:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#import-the-empty-misp-database-from-mysqlsql" title="Import the empty MISP database from MYSQL.sql" class="md-nav__link">
    Import the empty MISP database from MYSQL.sql
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-apache-configuration" title="7/ Apache configuration" class="md-nav__link">
    7/ Apache configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-log-rotation" title="8/ Log rotation" class="md-nav__link">
    8/ Log rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-misp-configuration" title="9/ MISP configuration" class="md-nav__link">
    9/ MISP configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialize-misp-configuration-and-set-some-defaults" title="Initialize MISP configuration and set some defaults" class="md-nav__link">
    Initialize MISP configuration and set some defaults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-misp-modules-optional" title="Install misp-modules (optional)" class="md-nav__link">
    Install misp-modules (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-actions" title="Recommended actions" class="md-nav__link">
    Recommended actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-commands" title="MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following commands" class="md-nav__link">
    MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-has-a-feature-for-publishing-events-to-kafka-to-enable-it-simply-run-the-following-commands" title="MISP has a feature for publishing events to Kafka. To enable it, simply run the following commands" class="md-nav__link">
    MISP has a feature for publishing events to Kafka. To enable it, simply run the following commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard" title="MISP Dashboard" class="md-nav__link">
    MISP Dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-viper-framework-with-a-virtualenv" title="Install viper framework (with a virtualenv)" class="md-nav__link">
    Install viper framework (with a virtualenv)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#experimental-ssdeep-correlations" title="Experimental ssdeep correlations" class="md-nav__link">
    Experimental ssdeep correlations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-ssdeep" title="installing ssdeep" class="md-nav__link">
    installing ssdeep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mail-to-misp" title="Install mail to misp" class="md-nav__link">
    Install mail to misp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrading-all-of-the-above" title="Upgrading all of the above" class="md-nav__link">
    Upgrading all of the above
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-core" title="MISP core" class="md-nav__link">
    MISP core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dependencies" title="MISP Dependencies" class="md-nav__link">
    MISP Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtualenv" title="virtualenv" class="md-nav__link">
    virtualenv
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-modules" title="misp-modules" class="md-nav__link">
    misp-modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyzmq" title="pyzmq" class="md-nav__link">
    pyzmq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard_1" title="misp-dashboard" class="md-nav__link">
    misp-dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viper" title="viper" class="md-nav__link">
    viper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mail-to-misp" title="mail-to-misp" class="md-nav__link">
    mail-to-misp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.debian_testing/" title="Debian testing" class="md-nav__link">
      Debian testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.ubuntu1804.with.webmin/" title="Ubuntu 18.04 \w webmin" class="md-nav__link">
      Ubuntu 18.04 \w webmin
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.tsurugi/" title="Tsurugi Linux" class="md-nav__link">
      Tsurugi Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.OpenBSD/" title="OpenBSD 6.5" class="md-nav__link">
      OpenBSD 6.5
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Config Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Config Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.elasticsearch-logging/" title="Elastic Search Logging" class="md-nav__link">
      Elastic Search Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.s3-attachments/" title="Amazon S3 attachments" class="md-nav__link">
      Amazon S3 attachments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.SMIME/" title="S/MIME" class="md-nav__link">
      S/MIME
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../UPDATE/" title="Update MISP" class="md-nav__link">
      Update MISP
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../UPGRADE/" title="Upgrading MISP" class="md-nav__link">
      Upgrading MISP
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Old guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Old guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/old-2_3to2_4-UPGRADE/" title="2.3 to 2.4 upgrade" class="md-nav__link">
      2.3 to 2.4 upgrade
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/INSTALL.ubuntu1604/" title="Ubuntu 16.04" class="md-nav__link">
      Ubuntu 16.04
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/xINSTALL.FreeBSD/" title="FreeBSD" class="md-nav__link">
      FreeBSD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Changelog/" title="MISP Release Notes" class="md-nav__link">
      MISP Release Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#for-debian-99-stretch" title="for Debian 9.9 "stretch"" class="md-nav__link">
    for Debian 9.9 "stretch"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-misp-debian-stable-install-status" title="0/ MISP debian stable install - Status" class="md-nav__link">
    0/ MISP debian stable install - Status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-minimal-debian-install" title="1/ Minimal Debian install" class="md-nav__link">
    1/ Minimal Debian install
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-a-minimal-debian-9-stretch-server-system-with-the-software" title="Install a minimal Debian 9 "stretch" server system with the software:" class="md-nav__link">
    Install a minimal Debian 9 "stretch" server system with the software:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-configuration-variables" title="MISP configuration variables" class="md-nav__link">
    MISP configuration variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-etckeeper-and-sudo-optional" title="install etckeeper and sudo (optional)" class="md-nav__link">
    install etckeeper and sudo (optional)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="add the misp user to staff and www-data (mandatory)" class="md-nav__link">
    add the misp user to staff and www-data (mandatory)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-interface-name-salvage-optional" title="Network Interface Name salvage (optional)" class="md-nav__link">
    Network Interface Name salvage (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-your-system-is-up2date" title="Make sure your system is up2date" class="md-nav__link">
    Make sure your system is up2date
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-postfix-there-will-be-some-questions-optional" title="install postfix, there will be some questions. (optional)" class="md-nav__link">
    install postfix, there will be some questions. (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-install-lamp-dependencies" title="2/ Install LAMP &amp; dependencies" class="md-nav__link">
    2/ Install LAMP &amp; dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-all-the-dependencies-some-might-already-be-installed" title="Install all the dependencies (some might already be installed)" class="md-nav__link">
    Install all the dependencies (some might already be installed)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-all-changes" title="Apply all changes" class="md-nav__link">
    Apply all changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-misp-code" title="3/ MISP code" class="md-nav__link">
    3/ MISP code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cakephp" title="4/ CakePHP" class="md-nav__link">
    4/ CakePHP
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cakephp-is-included-as-a-submodule-of-misp" title="CakePHP is included as a submodule of MISP." class="md-nav__link">
    CakePHP is included as a submodule of MISP.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-set-the-permissions" title="5/ Set the permissions" class="md-nav__link">
    5/ Set the permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-create-a-database-and-user" title="6/ Create a database and user" class="md-nav__link">
    6/ Create a database and user
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enter-the-mysql-shell" title="Enter the mysql shell" class="md-nav__link">
    Enter the mysql shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copypaste" title="copy/paste:" class="md-nav__link">
    copy/paste:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#import-the-empty-misp-database-from-mysqlsql" title="Import the empty MISP database from MYSQL.sql" class="md-nav__link">
    Import the empty MISP database from MYSQL.sql
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-apache-configuration" title="7/ Apache configuration" class="md-nav__link">
    7/ Apache configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-log-rotation" title="8/ Log rotation" class="md-nav__link">
    8/ Log rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-misp-configuration" title="9/ MISP configuration" class="md-nav__link">
    9/ MISP configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialize-misp-configuration-and-set-some-defaults" title="Initialize MISP configuration and set some defaults" class="md-nav__link">
    Initialize MISP configuration and set some defaults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-misp-modules-optional" title="Install misp-modules (optional)" class="md-nav__link">
    Install misp-modules (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-actions" title="Recommended actions" class="md-nav__link">
    Recommended actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-commands" title="MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following commands" class="md-nav__link">
    MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-has-a-feature-for-publishing-events-to-kafka-to-enable-it-simply-run-the-following-commands" title="MISP has a feature for publishing events to Kafka. To enable it, simply run the following commands" class="md-nav__link">
    MISP has a feature for publishing events to Kafka. To enable it, simply run the following commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard" title="MISP Dashboard" class="md-nav__link">
    MISP Dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-viper-framework-with-a-virtualenv" title="Install viper framework (with a virtualenv)" class="md-nav__link">
    Install viper framework (with a virtualenv)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#experimental-ssdeep-correlations" title="Experimental ssdeep correlations" class="md-nav__link">
    Experimental ssdeep correlations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-ssdeep" title="installing ssdeep" class="md-nav__link">
    installing ssdeep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mail-to-misp" title="Install mail to misp" class="md-nav__link">
    Install mail to misp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrading-all-of-the-above" title="Upgrading all of the above" class="md-nav__link">
    Upgrading all of the above
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-core" title="MISP core" class="md-nav__link">
    MISP core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dependencies" title="MISP Dependencies" class="md-nav__link">
    MISP Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtualenv" title="virtualenv" class="md-nav__link">
    virtualenv
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-modules" title="misp-modules" class="md-nav__link">
    misp-modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyzmq" title="pyzmq" class="md-nav__link">
    pyzmq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard_1" title="misp-dashboard" class="md-nav__link">
    misp-dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viper" title="viper" class="md-nav__link">
    viper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mail-to-misp" title="mail-to-misp" class="md-nav__link">
    mail-to-misp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="installation-instructions">INSTALLATION INSTRUCTIONS<a class="headerlink" href="#installation-instructions" title="Permanent link">&para;</a></h1>
<h2 id="for-debian-99-stretch">for Debian 9.9 "stretch"<a class="headerlink" href="#for-debian-99-stretch" title="Permanent link">&para;</a></h2>
<h3 id="0-misp-debian-stable-install-status">0/ MISP debian stable install - Status<a class="headerlink" href="#0-misp-debian-stable-install-status" title="Permanent link">&para;</a></h3>
<hr />
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Maintained and tested by @SteveClement on 20190425</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This install document is <strong>NOT</strong> working as expected. There are Python issues as we "only" have python 3.5 but need at least python 3.6</p>
</div>
<h3 id="1-minimal-debian-install">1/ Minimal Debian install<a class="headerlink" href="#1-minimal-debian-install" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="install-a-minimal-debian-9-stretch-server-system-with-the-software">Install a minimal Debian 9 "stretch" server system with the software:<a class="headerlink" href="#install-a-minimal-debian-9-stretch-server-system-with-the-software" title="Permanent link">&para;</a></h4>
<ul>
<li>OpenSSH server</li>
<li>This guide assumes a user name of 'misp' with sudo working</li>
</ul>
<h4 id="misp-configuration-variables">MISP configuration variables<a class="headerlink" href="#misp-configuration-variables" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_global-vars.sh&gt;</span>
<span class="c1"># $ eval &quot;$(curl -fsSL https://raw.githubusercontent.com/MISP/MISP/2.4/docs/generic/globalVariables.md | grep -v \`\`\`)&quot;</span>
<span class="c1"># $ MISPvars</span>
MISPvars <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting generic </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> variables shared by all flavours&quot;</span> <span class="m">2</span>&gt; /dev/null
  <span class="c1"># Local non-root MISP user</span>
  <span class="nv">MISP_USER</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">MISP_PASSWORD</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>

  <span class="c1"># The web server user</span>
  <span class="c1"># RHEL/CentOS</span>
  <span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;/etc/redhat-release&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WWW_USER</span><span class="o">=</span><span class="s1">&#39;apache&#39;</span>
  <span class="c1"># Debian flavoured</span>
  <span class="k">elif</span> <span class="o">[[</span> -f <span class="s2">&quot;/etc/debian_version&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WWW_USER</span><span class="o">=</span><span class="s2">&quot;www-data&quot;</span>
  <span class="c1"># OpenBSD</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="k">$(</span>uname -s<span class="k">)</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;OpenBSD&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WWW_USER</span><span class="o">=</span><span class="s2">&quot;www&quot;</span>
  <span class="k">else</span>
  <span class="c1"># I am feeling lucky</span>
    <span class="nv">WWW_USER</span><span class="o">=</span><span class="s2">&quot;www-data&quot;</span>
  <span class="k">fi</span>

  <span class="c1"># MISP configuration variables</span>
  <span class="nv">PATH_TO_MISP</span><span class="o">=</span><span class="s1">&#39;/var/www/MISP&#39;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$FQDN</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">FQDN</span><span class="o">=</span><span class="s2">&quot;misp.local&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MISP_BASEURL</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s1">&#39;&quot;&quot;&#39;</span>
  <span class="k">fi</span>

  <span class="nv">MISP_LIVE</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>

  <span class="c1"># Database configuration</span>
  <span class="nv">DBHOST</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span>
  <span class="nv">DBNAME</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">DBUSER_ADMIN</span><span class="o">=</span><span class="s1">&#39;root&#39;</span>
  <span class="nv">DBPASSWORD_ADMIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="nv">DBUSER_MISP</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">DBPASSWORD_MISP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>

  <span class="c1"># OpenSSL configuration</span>
  <span class="nv">OPENSSL_CN</span><span class="o">=</span><span class="nv">$FQDN</span>
  <span class="nv">OPENSSL_C</span><span class="o">=</span><span class="s1">&#39;LU&#39;</span>
  <span class="nv">OPENSSL_ST</span><span class="o">=</span><span class="s1">&#39;State&#39;</span>
  <span class="nv">OPENSSL_L</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span>
  <span class="nv">OPENSSL_O</span><span class="o">=</span><span class="s1">&#39;Organization&#39;</span>
  <span class="nv">OPENSSL_OU</span><span class="o">=</span><span class="s1">&#39;Organizational Unit&#39;</span>
  <span class="nv">OPENSSL_EMAILADDRESS</span><span class="o">=</span><span class="s2">&quot;info@</span><span class="nv">$FQDN</span><span class="s2">&quot;</span>

  <span class="c1"># GPG configuration</span>
  <span class="nv">GPG_REAL_NAME</span><span class="o">=</span><span class="s1">&#39;Autogenerated Key&#39;</span>
  <span class="nv">GPG_COMMENT</span><span class="o">=</span><span class="s1">&#39;WARNING: MISP AutoGenerated Key consider this Key VOID!&#39;</span>
  <span class="nv">GPG_EMAIL_ADDRESS</span><span class="o">=</span><span class="s1">&#39;admin@admin.test&#39;</span>
  <span class="nv">GPG_KEY_LENGTH</span><span class="o">=</span><span class="s1">&#39;2048&#39;</span>
  <span class="nv">GPG_PASSPHRASE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>

  <span class="c1"># debug alias to make sure people are not confused when blindly copy pasting blobs of code</span>
  <span class="nb">alias</span> <span class="nv">debug</span><span class="o">=</span><span class="s2">&quot;echo -e&quot;</span>

  <span class="c1"># checkAptLock alias to make sure people are not confused when blindly copy pasting blobs of code</span>
  <span class="nb">alias</span> <span class="nv">checkAptLock</span><span class="o">=</span><span class="s2">&quot;echo &#39;Function used in Installer to make sure apt is not locked&#39;&quot;</span>

  <span class="c1"># php.ini configuration</span>
  <span class="nv">upload_max_filesize</span><span class="o">=</span>50M
  <span class="nv">post_max_size</span><span class="o">=</span>50M
  <span class="nv">max_execution_time</span><span class="o">=</span><span class="m">300</span>
  <span class="nv">memory_limit</span><span class="o">=</span>512M

  <span class="nv">CAKE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/Console/cake&quot;</span>

  <span class="c1"># sudo config to run $LUSER commands</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="k">$(</span>groups <span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span> <span class="p">|</span>grep -o <span class="s1">&#39;staff&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;staff&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">SUDO_USER</span><span class="o">=</span><span class="s2">&quot;sudo -H -u </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> -g staff&quot;</span>
  <span class="k">else</span>
    <span class="nv">SUDO_USER</span><span class="o">=</span><span class="s2">&quot;sudo -H -u </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
  <span class="nv">SUDO_WWW</span><span class="o">=</span><span class="s2">&quot;sudo -H -u </span><span class="si">${</span><span class="nv">WWW_USER</span><span class="si">}</span><span class="s2"> &quot;</span>

  <span class="nb">echo</span> <span class="s2">&quot;The following DB Passwords were generated...&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Admin (</span><span class="si">${</span><span class="nv">DBUSER_ADMIN</span><span class="si">}</span><span class="s2">) DB Password: </span><span class="si">${</span><span class="nv">DBPASSWORD_ADMIN</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;User  (</span><span class="si">${</span><span class="nv">DBUSER_MISP</span><span class="si">}</span><span class="s2">) DB Password: </span><span class="si">${</span><span class="nv">DBPASSWORD_MISP</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_global-vars.sh&gt;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nv">PHP_ETC_BASE</span><span class="o">=</span>/etc/php/7.0
<span class="nv">PHP_INI</span><span class="o">=</span><span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/apache2/php.ini
</pre></div>

<h4 id="install-etckeeper-and-sudo-optional">install etckeeper and sudo (optional)<a class="headerlink" href="#install-etckeeper-and-sudo-optional" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_sudoKeeper.sh&gt;</span>
<span class="c1"># check if sudo is installed</span>
checkSudoKeeper <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Checking for sudo and installing etckeeper&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> ! -f <span class="k">$(</span>which sudo<span class="k">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to install etckeeper&quot;</span>
    su -c <span class="s2">&quot;apt install etckeeper -y&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to install sudo&quot;</span>
    su -c <span class="s2">&quot;apt install sudo -y&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to add </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> to sudo group&quot;</span>
    su -c <span class="s2">&quot;adduser </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> sudo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;We added </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> to group sudo and now we need to log out and in again.&quot;</span>
    <span class="nb">exit</span>
  <span class="k">else</span>
    sudo apt update
    sudo apt install etckeeper -y
  <span class="k">fi</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_sudoKeeper.sh&gt;</span>
</pre></div>

<h5 id="add-the-misp-user-to-staff-and-www-data-mandatory">add the misp user to staff and www-data (mandatory)<a class="headerlink" href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin add-user.sh&gt;</span>
<span class="c1">## FIXME: This function is a duplicate included in: # &lt;snippet-begin 0_support-functions.sh&gt;</span>
<span class="c1"># check is /usr/local/src is RW by misp user</span>
checkUsrLocalSrc <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> -e /usr/local/src <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WRITEABLE</span><span class="o">=</span><span class="k">$(</span>sudo -H -u <span class="nv">$MISP_USER</span> touch /usr/local/src <span class="m">2</span>&gt; /dev/null <span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$WRITEABLE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Good, /usr/local/src exists and is writeable as </span><span class="nv">$MISP_USER</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="c1"># TODO: The below might be shorter, more elegant and more modern</span>
      <span class="c1">#[[ -n $KALI ]] || [[ -n $UNATTENDED ]] &amp;&amp; echo &quot;Just do it&quot; </span>
      sudo chmod <span class="m">2775</span> /usr/local/src
      sudo chown root:staff /usr/local/src
    <span class="k">fi</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;/usr/local/src does not exist, creating.&quot;</span>
    mkdir -p /usr/local/src
    sudo chmod <span class="m">2775</span> /usr/local/src
    <span class="c1"># TODO: Better handling /usr/local/src permissions</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="k">$(</span>cat /etc/group <span class="p">|</span>grep staff &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      sudo chown root:staff /usr/local/src
    <span class="k">fi</span>
  <span class="k">fi</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end add-user.sh&gt;</span>
</pre></div>

<h4 id="network-interface-name-salvage-optional">Network Interface Name salvage (optional)<a class="headerlink" href="#network-interface-name-salvage-optional" title="Permanent link">&para;</a></h4>
<p>This will bring back 'ethX' e.g: eth0</p>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-end interfaces.sh&gt;</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;net.ifnames=0 biosdevname=0&quot;</span>
<span class="nv">DEFAULT_GRUB</span><span class="o">=</span>/etc/default/grub

<span class="nb">echo</span> <span class="s2">&quot;--- Using old style name (ethX) for interfaces&quot;</span>
<span class="c1">#for key in GRUB_CMDLINE_LINUX</span>
<span class="c1">#do</span>
<span class="c1">#    sudo sed -i &quot;s/^\($key\)=.*/\1=\&quot;$(eval echo \${$key})\&quot;/&quot; $DEFAULT_GRUB</span>
<span class="c1">#done</span>
sed  -r  <span class="s1">&#39;s/^(GRUB_CMDLINE_LINUX=).*/\1\&quot;net\.ifnames=0\ biosdevname=0\&quot;/&#39;</span> /etc/default/grub <span class="p">|</span> sudo tee /etc/default/grub &gt; /dev/null

<span class="c1"># install ifupdown since ubuntu 18.04</span>
sudo apt-get update
sudo apt-get install -y ifupdown

<span class="c1"># enable eth0</span>
<span class="nb">echo</span> <span class="s2">&quot;--- Configuring eth0&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;# The primary network interface</span>
<span class="s2">auto eth0</span>
<span class="s2">iface eth0 inet dhcp&quot;</span> <span class="p">|</span> sudo tee /etc/network/interfaces
sudo grub-mkconfig -o /boot/grub/grub.cfg
sudo update-grub  &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># &lt;snippet-end interfaces.sh&gt;</span>
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>On recent Ubuntu install Netplan is default and you need to change the Network name.
<div class="codehilite"><pre><span></span>sudo sed -i &quot;s/enp0s3/eth0/&quot; /etc/netplan/50-cloud-init.yaml
</pre></div>
OR on Ubuntu 19.04 (yay for changing this every 5 commits... #n00bs)
<div class="codehilite"><pre><span></span>sudo sed -i &quot;s/enp0s3/eth0/&quot; /etc/netplan/01-netcfg.yaml
</pre></div></p>
</div>
<h4 id="make-sure-your-system-is-up2date">Make sure your system is up2date<a class="headerlink" href="#make-sure-your-system-is-up2date" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo apt update
sudo apt -y dist-upgrade
</pre></div>

<h4 id="install-postfix-there-will-be-some-questions-optional">install postfix, there will be some questions. (optional)<a class="headerlink" href="#install-postfix-there-will-be-some-questions-optional" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># Postfix Configuration: Satellite system</span>
sudo apt install -y postfix
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1"># change the relay server later with:</span>
sudo postconf -e <span class="s1">&#39;relayhost = example.com&#39;</span>
sudo postfix reload
</pre></div>

<h3 id="2-install-lamp-dependencies">2/ Install LAMP &amp; dependencies<a class="headerlink" href="#2-install-lamp-dependencies" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="install-all-the-dependencies-some-might-already-be-installed">Install all the dependencies (some might already be installed)<a class="headerlink" href="#install-all-the-dependencies-some-might-already-be-installed" title="Permanent link">&para;</a></h4>
<p>You need to update python3.5 to python3.7 for <a href="https://github.com/MISP/PyMISP">PyMISP</a> to work properly.</p>
<p>FIXME: The below breaks redis-server and mariadb-server</p>
<div class="codehilite"><pre><span></span><span class="c1"># Manual Python3.7.3 install</span>
sudo apt update
sudo apt install make build-essential libssl-dev zlib1g-dev libbz2-dev <span class="se">\</span>
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev <span class="se">\</span>
xz-utils tk-dev libffi-dev liblzma-dev -qqy
mkdir -p code <span class="p">;</span> <span class="nb">cd</span> code <span class="p">;</span> wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tar.xz <span class="p">;</span> tar xfvJ Python-3.7.3.tar.xz <span class="p">;</span> <span class="nb">cd</span> Python-3.7.3 <span class="p">;</span> ./configure --enable-optimizations <span class="p">;</span> make -j8 <span class="p">;</span> sudo make altinstall
sudo update-alternatives --install /usr/bin/python python /usr/local/bin/python3.7 <span class="m">50</span>
sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 <span class="m">40</span>
sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.5 <span class="m">30</span>

sudo apt install virtualenv -qqy
</pre></div>

<div class="codehilite"><pre><span></span>sudo apt install <span class="se">\</span>
curl gcc git gnupg-agent make openssl redis-server vim zip libyara-dev <span class="se">\</span>
apache2 apache2-doc apache2-utils <span class="se">\</span>
libpq5 libjpeg-dev libfuzzy-dev ruby asciidoctor <span class="se">\</span>
jq ntp ntpdate imagemagick tesseract-ocr <span class="se">\</span>
libxml2-dev libxslt1-dev zlib1g-dev <span class="se">\</span>
net-tools -qqy

sudo apt install libapache2-mod-php php php-cli php-mbstring php-dev php-json php-xml php-mysql php-opcache php-readline php-redis php-gnupg php-gd -qqy

sudo apt install <span class="se">\</span>
mariadb-client <span class="se">\</span>
mariadb-server -qqy

<span class="c1"># Just a quick test if mysql-server restarts without problems</span>
sudo /etc/init.d/mysql restart

<span class="c1"># Start haveged to get more entropy (optional)</span>
sudo apt install haveged -qqy
sudo service haveged start

sudo apt install expect -qqy

<span class="c1"># Add your credentials if needed, if sudo has NOPASS, comment out the relevant lines</span>
<span class="nv">pw</span><span class="o">=</span><span class="s2">&quot;Password1234&quot;</span>

expect -f - <span class="s">&lt;&lt;-EOF</span>
<span class="s">  set timeout 10</span>

<span class="s">  spawn sudo mysql_secure_installation</span>
<span class="s">  expect &quot;*?assword*&quot;</span>
<span class="s">  send -- &quot;$pw\r&quot;</span>
<span class="s">  expect &quot;Enter current password for root (enter for none):&quot;</span>
<span class="s">  send -- &quot;\r&quot;</span>
<span class="s">  expect &quot;Set root password?&quot;</span>
<span class="s">  send -- &quot;y\r&quot;</span>
<span class="s">  expect &quot;New password:&quot;</span>
<span class="s">  send -- &quot;${DBPASSWORD_ADMIN}\r&quot;</span>
<span class="s">  expect &quot;Re-enter new password:&quot;</span>
<span class="s">  send -- &quot;${DBPASSWORD_ADMIN}\r&quot;</span>
<span class="s">  expect &quot;Remove anonymous users?&quot;</span>
<span class="s">  send -- &quot;y\r&quot;</span>
<span class="s">  expect &quot;Disallow root login remotely?&quot;</span>
<span class="s">  send -- &quot;y\r&quot;</span>
<span class="s">  expect &quot;Remove test database and access to it?&quot;</span>
<span class="s">  send -- &quot;y\r&quot;</span>
<span class="s">  expect &quot;Reload privilege tables now?&quot;</span>
<span class="s">  send -- &quot;y\r&quot;</span>
<span class="s">  expect eof</span>
<span class="s">EOF</span>
sudo apt purge -qqy expect <span class="p">;</span> sudo apt autoremove -qqy

<span class="c1"># Enable modules, settings, and default of SSL in Apache</span>
sudo a2dismod status
sudo a2enmod ssl rewrite headers
sudo a2dissite <span class="m">000</span>-default
sudo a2ensite default-ssl
</pre></div>

<h4 id="apply-all-changes">Apply all changes<a class="headerlink" href="#apply-all-changes" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo systemctl restart apache2
</pre></div>

<h3 id="3-misp-code">3/ MISP code<a class="headerlink" href="#3-misp-code" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># Download MISP using git in the /var/www/ directory.</span>
sudo mkdir <span class="nv">$PATH_TO_MISP</span>
sudo chown <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> <span class="nv">$PATH_TO_MISP</span>
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>
<span class="nv">$SUDO_WWW</span> git clone https://github.com/MISP/MISP.git <span class="nv">$PATH_TO_MISP</span>
<span class="nv">$SUDO_WWW</span> git submodule update --init --recursive
<span class="c1"># Make git ignore filesystem permission differences for submodules</span>
<span class="nv">$SUDO_WWW</span> git submodule foreach --recursive git config core.filemode <span class="nb">false</span>

<span class="c1"># Make git ignore filesystem permission differences</span>
<span class="nv">$SUDO_WWW</span> git config core.filemode <span class="nb">false</span>

<span class="c1"># Create a python3 virtualenv</span>
<span class="nv">$SUDO_WWW</span> virtualenv -p python3.7 <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv

<span class="c1"># make pip happy</span>
sudo mkdir /var/www/.cache/
sudo chown <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> /var/www/.cache

<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts
<span class="nv">$SUDO_WWW</span> git clone https://github.com/CybOXProject/python-cybox.git
<span class="nv">$SUDO_WWW</span> git clone https://github.com/STIXProject/python-stix.git
<span class="nv">$SUDO_WWW</span> git clone https://github.com/MAECProject/python-maec.git
<span class="c1"># install mixbox to accommodate the new STIX dependencies:</span>
<span class="nv">$SUDO_WWW</span> git clone https://github.com/CybOXProject/mixbox.git
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/mixbox
<span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-cybox
<span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-stix
<span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-maec
<span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .

<span class="c1"># install PyMISP</span>
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/PyMISP
<span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .

<span class="c1"># Install Crypt_GPG and Console_CommandLine</span>
sudo pear install <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/dependencies/Console_CommandLine/package.xml
sudo pear install <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/dependencies/Crypt_GPG/package.xml
</pre></div>

<h3 id="4-cakephp">4/ CakePHP<a class="headerlink" href="#4-cakephp" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="cakephp-is-included-as-a-submodule-of-misp">CakePHP is included as a submodule of MISP.<a class="headerlink" href="#cakephp-is-included-as-a-submodule-of-misp" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># Install CakeResque along with its dependencies if you intend to use the built in background jobs:</span>
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app
<span class="c1"># Make composer cache happy</span>
sudo mkdir /var/www/.composer <span class="p">;</span> sudo chown <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> /var/www/.composer
<span class="c1"># Update composer.phar</span>
<span class="c1"># $SUDO_WWW php -r &quot;copy(&#39;https://getcomposer.org/installer&#39;, &#39;composer-setup.php&#39;);&quot;</span>
<span class="c1"># $SUDO_WWW php -r &quot;if (hash_file(&#39;SHA384&#39;, &#39;composer-setup.php&#39;) === &#39;48e3236262b34d30969dca3c37281b3b4bbe3221bda826ac6a9a62d6444cdb0dcd0615698a5cbe587c3f0fe57a54d8f5&#39;) { echo &#39;Installer verified&#39;; } else { echo &#39;Installer corrupt&#39;; unlink(&#39;composer-setup.php&#39;); } echo PHP_EOL;&quot;</span>
<span class="c1"># $SUDO_WWW php composer-setup.php</span>
<span class="c1"># $SUDO_WWW php -r &quot;unlink(&#39;composer-setup.php&#39;);&quot;</span>
<span class="nv">$SUDO_WWW</span> php composer.phar require kamisama/cake-resque:4.1.2
<span class="nv">$SUDO_WWW</span> php composer.phar config vendor-dir Vendor
<span class="nv">$SUDO_WWW</span> php composer.phar install

<span class="c1"># Enable CakeResque with php-redis</span>
sudo phpenmod redis
sudo phpenmod gnupg

<span class="c1"># To use the scheduler worker for scheduled tasks, do the following:</span>
<span class="nv">$SUDO_WWW</span> cp -fa <span class="nv">$PATH_TO_MISP</span>/INSTALL/setup/config.php <span class="nv">$PATH_TO_MISP</span>/app/Plugin/CakeResque/Config/config.php
</pre></div>

<h3 id="5-set-the-permissions">5/ Set the permissions<a class="headerlink" href="#5-set-the-permissions" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># Check if the permissions are set correctly using the following commands:</span>
sudo chown -R <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> <span class="nv">$PATH_TO_MISP</span>
sudo chmod -R <span class="m">750</span> <span class="nv">$PATH_TO_MISP</span>
sudo chmod -R g+ws <span class="nv">$PATH_TO_MISP</span>/app/tmp
sudo chmod -R g+ws <span class="nv">$PATH_TO_MISP</span>/app/files
sudo chmod -R g+ws <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/tmp
</pre></div>

<h3 id="6-create-a-database-and-user">6/ Create a database and user<a class="headerlink" href="#6-create-a-database-and-user" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="enter-the-mysql-shell">Enter the mysql shell<a class="headerlink" href="#enter-the-mysql-shell" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo mysql -u root -p
</pre></div>

<div class="codehilite"><pre><span></span>MariaDB [(none)]&gt; create database misp;
MariaDB [(none)]&gt; grant usage on *.* to misp@localhost identified by &#39;XXXXdbpasswordhereXXXXX&#39;;
MariaDB [(none)]&gt; grant all privileges on misp.* to misp@localhost;
MariaDB [(none)]&gt; flush privileges;
MariaDB [(none)]&gt; exit
</pre></div>

<h4 id="copypaste">copy/paste:<a class="headerlink" href="#copypaste" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;create database </span><span class="nv">$DBNAME</span><span class="s2">;&quot;</span>
sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;grant usage on *.* to </span><span class="nv">$DBNAME</span><span class="s2">@localhost identified by &#39;</span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&#39;;&quot;</span>
sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;grant all privileges on </span><span class="nv">$DBNAME</span><span class="s2">.* to &#39;</span><span class="nv">$DBUSER_MISP</span><span class="s2">&#39;@&#39;localhost&#39;;&quot;</span>
sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;flush privileges;&quot;</span>
</pre></div>

<h4 id="import-the-empty-misp-database-from-mysqlsql">Import the empty MISP database from MYSQL.sql<a class="headerlink" href="#import-the-empty-misp-database-from-mysqlsql" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="nv">$SUDO_WWW</span> cat <span class="nv">$PATH_TO_MISP</span>/INSTALL/MYSQL.sql <span class="p">|</span> mysql -u <span class="nv">$DBUSER_MISP</span> -p<span class="nv">$DBPASSWORD_MISP</span> <span class="nv">$DBNAME</span>
</pre></div>

<h3 id="7-apache-configuration">7/ Apache configuration<a class="headerlink" href="#7-apache-configuration" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># Now configure your Apache webserver with the DocumentRoot $PATH_TO_MISP/app/webroot/</span>

<span class="c1"># If the apache version is 2.4:</span>
sudo cp <span class="nv">$PATH_TO_MISP</span>/INSTALL/apache.24.misp.ssl /etc/apache2/sites-available/misp-ssl.conf

<span class="c1"># Be aware that the configuration files for apache 2.4 and up have changed.</span>
<span class="c1"># The configuration file has to have the .conf extension in the sites-available directory</span>
<span class="c1"># For more information, visit http://httpd.apache.org/docs/2.4/upgrading.html</span>

<span class="c1"># If a valid SSL certificate is not already created for the server, create a self-signed certificate:</span>
sudo openssl req -newkey rsa:4096 -days <span class="m">365</span> -nodes -x509 <span class="se">\</span>
-subj <span class="s2">&quot;/C=</span><span class="si">${</span><span class="nv">OPENSSL_C</span><span class="si">}</span><span class="s2">/ST=</span><span class="si">${</span><span class="nv">OPENSSL_ST</span><span class="si">}</span><span class="s2">/L=</span><span class="si">${</span><span class="nv">OPENSSL_L</span><span class="si">}</span><span class="s2">/O=</span><span class="si">${</span><span class="nv">OPENSSL_O</span><span class="si">}</span><span class="s2">/OU=</span><span class="si">${</span><span class="nv">OPENSSL_OU</span><span class="si">}</span><span class="s2">/CN=</span><span class="si">${</span><span class="nv">OPENSSL_CN</span><span class="si">}</span><span class="s2">/emailAddress=</span><span class="si">${</span><span class="nv">OPENSSL_EMAILADDRESS</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
-keyout /etc/ssl/private/misp.local.key -out /etc/ssl/private/misp.local.crt

<span class="c1"># Otherwise, copy the SSLCertificateFile, SSLCertificateKeyFile, and SSLCertificateChainFile to /etc/ssl/private/. (Modify path and config to fit your environment)</span>
</pre></div>

<div class="codehilite"><pre><span></span>============================================= Begin sample working SSL config for MISP
&lt;VirtualHost _default_:80&gt;
        ServerAdmin admin@&lt;your.FQDN.here&gt;
        ServerName &lt;your.FQDN.here&gt;

        Redirect permanent / https://&lt;your.FQDN.here&gt;

        LogLevel warn
        ErrorLog /var/log/apache2/misp.local_error.log
        CustomLog /var/log/apache2/misp.local_access.log combined
        ServerSignature Off
&lt;/VirtualHost&gt;

&lt;VirtualHost _default_:443&gt;
        ServerAdmin admin@&lt;your.FQDN.here&gt;
        ServerName &lt;your.FQDN.here&gt;
        DocumentRoot $PATH_TO_MISP/app/webroot
        &lt;Directory $PATH_TO_MISP/app/webroot&gt;
                Options -Indexes
                AllowOverride all
                Require all granted
                Order allow,deny
                allow from all
        &lt;/Directory&gt;

        SSLEngine On
        SSLCertificateFile /etc/ssl/private/misp.local.crt
        SSLCertificateKeyFile /etc/ssl/private/misp.local.key
#        SSLCertificateChainFile /etc/ssl/private/misp-chain.crt

        LogLevel warn
        ErrorLog /var/log/apache2/misp.local_error.log
        CustomLog /var/log/apache2/misp.local_access.log combined
        ServerSignature Off
&lt;/VirtualHost&gt;
============================================= End sample working SSL config for MISP
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1"># activate new vhost</span>
sudo a2dissite default-ssl
sudo a2ensite misp-ssl

<span class="c1"># Recommended: Change some PHP settings in /etc/php/7.3/apache2/php.ini</span>
<span class="c1"># max_execution_time = 300</span>
<span class="c1"># memory_limit = 512M</span>
<span class="c1"># upload_max_filesize = 50M</span>
<span class="c1"># post_max_size = 50M</span>
<span class="k">for</span> key in upload_max_filesize post_max_size max_execution_time max_input_time memory_limit
<span class="k">do</span>
    sudo sed -i <span class="s2">&quot;s/^\(</span><span class="nv">$key</span><span class="s2">\).*/\1 = </span><span class="k">$(</span><span class="nb">eval</span> <span class="nb">echo</span> <span class="se">\$</span><span class="o">{</span><span class="nv">$key</span><span class="o">}</span><span class="k">)</span><span class="s2">/&quot;</span> <span class="nv">$PHP_INI</span>
<span class="k">done</span>

<span class="c1"># Restart apache</span>
sudo systemctl restart apache2
</pre></div>

<h3 id="8-log-rotation">8/ Log rotation<a class="headerlink" href="#8-log-rotation" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># MISP saves the stdout and stderr of its workers in $PATH_TO_MISP/app/tmp/logs</span>
<span class="c1"># To rotate these logs install the supplied logrotate script:</span>

sudo cp <span class="nv">$PATH_TO_MISP</span>/INSTALL/misp.logrotate /etc/logrotate.d/misp
sudo chmod <span class="m">0640</span> /etc/logrotate.d/misp
</pre></div>

<h3 id="9-misp-configuration">9/ MISP configuration<a class="headerlink" href="#9-misp-configuration" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># There are 4 sample configuration files in $PATH_TO_MISP/app/Config that need to be copied</span>
<span class="nv">$SUDO_WWW</span> cp -a <span class="nv">$PATH_TO_MISP</span>/app/Config/bootstrap.default.php <span class="nv">$PATH_TO_MISP</span>/app/Config/bootstrap.php
<span class="nv">$SUDO_WWW</span> cp -a <span class="nv">$PATH_TO_MISP</span>/app/Config/database.default.php <span class="nv">$PATH_TO_MISP</span>/app/Config/database.php
<span class="nv">$SUDO_WWW</span> cp -a <span class="nv">$PATH_TO_MISP</span>/app/Config/core.default.php <span class="nv">$PATH_TO_MISP</span>/app/Config/core.php
<span class="nv">$SUDO_WWW</span> cp -a <span class="nv">$PATH_TO_MISP</span>/app/Config/config.default.php <span class="nv">$PATH_TO_MISP</span>/app/Config/config.php


<span class="nb">echo</span> <span class="s2">&quot;&lt;?php</span>
<span class="s2">class DATABASE_CONFIG {</span>
<span class="s2">        public \$default = array(</span>
<span class="s2">                &#39;datasource&#39; =&gt; &#39;Database/Mysql&#39;,</span>
<span class="s2">                //&#39;datasource&#39; =&gt; &#39;Database/Postgres&#39;,</span>
<span class="s2">                &#39;persistent&#39; =&gt; false,</span>
<span class="s2">                &#39;host&#39; =&gt; &#39;</span><span class="nv">$DBHOST</span><span class="s2">&#39;,</span>
<span class="s2">                &#39;login&#39; =&gt; &#39;</span><span class="nv">$DBUSER_MISP</span><span class="s2">&#39;,</span>
<span class="s2">                &#39;port&#39; =&gt; 3306, // MySQL &amp; MariaDB</span>
<span class="s2">                //&#39;port&#39; =&gt; 5432, // PostgreSQL</span>
<span class="s2">                &#39;password&#39; =&gt; &#39;</span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&#39;,</span>
<span class="s2">                &#39;database&#39; =&gt; &#39;</span><span class="nv">$DBNAME</span><span class="s2">&#39;,</span>
<span class="s2">                &#39;prefix&#39; =&gt; &#39;&#39;,</span>
<span class="s2">                &#39;encoding&#39; =&gt; &#39;utf8&#39;,</span>
<span class="s2">        );</span>
<span class="s2">}&quot;</span> <span class="p">|</span> <span class="nv">$SUDO_WWW</span> tee <span class="nv">$PATH_TO_MISP</span>/app/Config/database.php

<span class="c1"># and make sure the file permissions are still OK</span>
sudo chown -R <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> <span class="nv">$PATH_TO_MISP</span>/app/Config
sudo chmod -R <span class="m">750</span> <span class="nv">$PATH_TO_MISP</span>/app/Config

<span class="c1"># Generate a GPG encryption key.</span>

cat &gt;/tmp/gen-key-script <span class="s">&lt;&lt;EOF</span>
<span class="s">    %echo Generating a default key</span>
<span class="s">    Key-Type: default</span>
<span class="s">    Key-Length: $GPG_KEY_LENGTH</span>
<span class="s">    Subkey-Type: default</span>
<span class="s">    Name-Real: $GPG_REAL_NAME</span>
<span class="s">    Name-Comment: $GPG_COMMENT</span>
<span class="s">    Name-Email: $GPG_EMAIL_ADDRESS</span>
<span class="s">    Expire-Date: 0</span>
<span class="s">    Passphrase: $GPG_PASSPHRASE</span>
<span class="s">    # Do a commit here, so that we can later print &quot;done&quot;</span>
<span class="s">    %commit</span>
<span class="s">    %echo done</span>
<span class="s">EOF</span>

<span class="nv">$SUDO_WWW</span> gpg --homedir <span class="nv">$PATH_TO_MISP</span>/.gnupg --batch --gen-key /tmp/gen-key-script
<span class="c1"># The email address should match the one set in the config.php / set in the configuration menu in the administration menu configuration file</span>

<span class="c1"># And export the public key to the webroot</span>
<span class="nv">$SUDO_WWW</span> sh -c <span class="s2">&quot;gpg --homedir </span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg --export --armor </span><span class="nv">$GPG_EMAIL_ADDRESS</span><span class="s2">&quot;</span> <span class="p">|</span> <span class="nv">$SUDO_WWW</span> tee <span class="nv">$PATH_TO_MISP</span>/app/webroot/gpg.asc

<span class="c1"># To make the background workers start on boot</span>
sudo chmod +x <span class="nv">$PATH_TO_MISP</span>/app/Console/worker/start.sh

<span class="nb">echo</span> <span class="s2">&quot;[Unit]</span>
<span class="s2">Description=MISP&#39;s background workers</span>
<span class="s2">After=rh-mariadb102-mariadb.service rh-redis32-redis.service rh-php72-php-fpm.service</span>

<span class="s2">[Service]</span>
<span class="s2">Type=forking</span>
<span class="s2">User=</span><span class="nv">$WWW_USER</span><span class="s2"></span>
<span class="s2">Group=</span><span class="nv">$WWW_USER</span><span class="s2"></span>
<span class="s2">ExecStart=</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/Console/worker/start.sh</span>
<span class="s2">Restart=always</span>
<span class="s2">RestartSec=10</span>

<span class="s2">[Install]</span>
<span class="s2">WantedBy=multi-user.target&quot;</span> <span class="p">|</span>sudo tee /etc/systemd/system/misp-workers.service
sudo systemctl daemon-reload
sudo systemctl <span class="nb">enable</span> --now misp-workers.service

<span class="k">if</span> <span class="o">[</span> ! -e /etc/rc.local <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s1">&#39;#!/bin/sh -e&#39;</span> <span class="p">|</span> sudo tee -a /etc/rc.local
    <span class="nb">echo</span> <span class="s1">&#39;exit 0&#39;</span> <span class="p">|</span> sudo tee -a /etc/rc.local
    sudo chmod u+x /etc/rc.local
<span class="k">fi</span>
</pre></div>

<h4 id="initialize-misp-configuration-and-set-some-defaults">Initialize MISP configuration and set some defaults<a class="headerlink" href="#initialize-misp-configuration-and-set-some-defaults" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_core-cake.sh&gt;</span>
<span class="c1"># Core cake commands to tweak MISP and aleviate some of the configuration pains</span>
<span class="c1"># The $RUN_PHP is ONLY set on RHEL/CentOS installs and can thus be ignored</span>
<span class="c1"># This file is NOT an excuse to NOT read the settings and familiarize ourselves with them ;)</span>

coreCAKE <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Running core Cake commands to set sane defaults for </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># IF you have logged in prior to running this, it will fail but the fail is NON-blocking</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> userInit -q

  <span class="c1"># This makes sure all Database upgrades are done, without logging in.</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateDatabase

  <span class="c1"># The default install is Python &gt;=3.6 in a virtualenv, setting accordingly</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.python_bin&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span><span class="s2">/venv/bin/python&quot;</span>

  <span class="c1"># Set default role</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> setDefaultRole <span class="m">3</span>

  <span class="c1"># Tune global time outs</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.autoRegenerate&quot;</span> <span class="m">0</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.timeout&quot;</span> <span class="m">600</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.cookieTimeout&quot;</span> <span class="m">3600</span>

  <span class="c1"># Change base url, either with this CLI command or in the UI</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Baseurl <span class="nv">$MISP_BASEURL</span>
  <span class="c1"># example: &#39;baseurl&#39; =&gt; &#39;https://&lt;your.FQDN.here&gt;&#39;,</span>
  <span class="c1"># alternatively, you can leave this field empty if you would like to use relative pathing in MISP</span>
  <span class="c1"># &#39;baseurl&#39; =&gt; &#39;&#39;,</span>
  <span class="c1"># The base url of the application (in the format https://www.mymispinstance.com) as visible externally/by other MISPs.</span>
  <span class="c1"># MISP will encode this URL in sharing groups when including itself. If this value is not set, the baseurl is used as a fallback.</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.external_baseurl&quot;</span> <span class="nv">$MISP_BASEURL</span>

  <span class="c1"># Enable GnuPG</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.email&quot;</span> <span class="s2">&quot;</span><span class="nv">$GPG_EMAIL_ADDRESS</span><span class="s2">&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.homedir&quot;</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.password&quot;</span> <span class="s2">&quot;</span><span class="nv">$GPG_PASSPHRASE</span><span class="s2">&quot;</span>
  <span class="c1"># FIXME: what if we have not gpg binary but a gpg2 one?</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.binary&quot;</span> <span class="s2">&quot;</span><span class="k">$(</span>which gpg<span class="k">)</span><span class="s2">&quot;</span>

  <span class="c1"># Enable installer org and tune some configurables</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.host_org_id&quot;</span> <span class="m">1</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.email&quot;</span> <span class="s2">&quot;info@admin.test&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disable_emailing&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.contact&quot;</span> <span class="s2">&quot;info@admin.test&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disablerestalert&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.showCorrelationsOnIndex&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.default_event_tag_collection&quot;</span> <span class="m">0</span>

  <span class="c1"># Provisional Cortex tunes</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_enable&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_port&quot;</span> <span class="m">9000</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_timeout&quot;</span> <span class="m">120</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_authkey&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_verify_peer&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_verify_host&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_allow_self_signed&quot;</span> <span class="nb">true</span>

  <span class="c1"># Various plugin sightings settings</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_policy&quot;</span> <span class="m">0</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_anonymise&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_range&quot;</span> <span class="m">365</span>

  <span class="c1"># Plugin CustomAuth tuneable</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.CustomAuth_disable_logout&quot;</span> <span class="nb">false</span>

  <span class="c1"># RPZ Plugin settings</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_policy&quot;</span> <span class="s2">&quot;DROP&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_walled_garden&quot;</span> <span class="s2">&quot;127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_serial&quot;</span> <span class="s2">&quot;\$date00&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_refresh&quot;</span> <span class="s2">&quot;2h&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_retry&quot;</span> <span class="s2">&quot;30m&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_expiry&quot;</span> <span class="s2">&quot;30d&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_minimum_ttl&quot;</span> <span class="s2">&quot;1h&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ttl&quot;</span> <span class="s2">&quot;1w&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ns&quot;</span> <span class="s2">&quot;localhost.&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ns_alt&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_email&quot;</span> <span class="s2">&quot;root.localhost&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less RED</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.language&quot;</span> <span class="s2">&quot;eng&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.proposals_block_attributes&quot;</span> <span class="nb">false</span>

  <span class="c1"># Redis block</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_host&quot;</span> <span class="s2">&quot;127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_port&quot;</span> <span class="m">6379</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_database&quot;</span> <span class="m">13</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_password&quot;</span> <span class="s2">&quot;&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less YELLOW</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.ssdeep_correlation_threshold&quot;</span> <span class="m">40</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.extended_alert_subject&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.default_event_threat_level&quot;</span> <span class="m">4</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.newUserText&quot;</span> <span class="s2">&quot;Dear new MISP user,\\n\\nWe would hereby like to welcome you to the \$org MISP community.\\n\\n Use the credentials below to log into MISP at \$misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: \$username\\nPassword: \$password\\n\\nIf you have any questions, don&#39;t hesitate to contact us at: \$contact.\\n\\nBest regards,\\nYour \$org MISP support team&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.passwordResetText&quot;</span> <span class="s2">&quot;Dear MISP user,\\n\\nA password reset has been triggered for your account. Use the below provided temporary password to log into MISP at \$misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: \$username\\nYour temporary password: \$password\\n\\nIf you have any questions, don&#39;t hesitate to contact us at: \$contact.\\n\\nBest regards,\\nYour \$org MISP support team&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.enableEventBlacklisting&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.enableOrgBlacklisting&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.log_client_ip&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.log_auth&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disableUserSelfManagement&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_event_alert&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_event_alert_tag&quot;</span> <span class="s2">&quot;no-alerts=\&quot;true\&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_old_event_alert&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_old_event_alert_age&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.incoming_tags_disabled_by_default&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.maintenance_message&quot;</span> <span class="s2">&quot;Great things are happening! MISP is undergoing maintenance, but will return shortly. You can contact the administration at \$email.&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.footermidleft&quot;</span> <span class="s2">&quot;This is an initial install&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.footermidright&quot;</span> <span class="s2">&quot;Please configure and harden accordingly&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.welcome_text_top&quot;</span> <span class="s2">&quot;Initial Install, please configure&quot;</span>
  <span class="c1"># TODO: Make sure $FLAVOUR is correct</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.welcome_text_bottom&quot;</span> <span class="s2">&quot;Welcome to MISP on </span><span class="nv">$FLAVOUR</span><span class="s2">, change this message in MISP Settings&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.attachments_dir&quot;</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/files&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.download_attachments_on_load&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.title_text&quot;</span> <span class="s2">&quot;MISP&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.terms_download&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.showorgalternate&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.event_view_filter_fields&quot;</span> <span class="s2">&quot;id, uuid, value, comment, type, category, Tag.name&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less GREEN</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Security.password_policy_length&quot;</span> <span class="m">12</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Security.password_policy_complexity&quot;</span> <span class="s1">&#39;/^((?=.*\d)|(?=.*\W+))(?![\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/&#39;</span>

  <span class="c1"># Set MISP Live</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Live <span class="nv">$MISP_LIVE</span>
<span class="o">}</span>

<span class="c1"># This updates Galaxies, ObjectTemplates, Warninglists, Noticelists, Templates</span>
updateGOWNT <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># AUTH_KEY Place holder in case we need to **curl** somehing in the future</span>
  <span class="c1"># </span>
  <span class="c1"># AUTH_KEY=$(mysql -u $DBUSER_MISP -p$DBPASSWORD_MISP misp -e &quot;SELECT authkey FROM users;&quot; | tail -1)</span>
  <span class="c1"># RHEL/CentOS</span>
  <span class="c1"># AUTH_KEY=$(scl enable rh-mariadb102 &quot;mysql -u $DBUSER_MISP -p$DBPASSWORD_MISP misp -e &#39;SELECT authkey FROM users;&#39; | tail -1&quot;)</span>
  <span class="c1">#</span>

  debug <span class="s2">&quot;Updating Galaxies, ObjectTemplates, Warninglists, Noticelists and Templates&quot;</span>
  <span class="c1"># Update the galaxies</span>
  <span class="c1"># TODO: Fix updateGalaxies</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateGalaxies
  <span class="c1"># Updating the taxonomies</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateTaxonomies
  <span class="c1"># Updating the warning lists</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateWarningLists
  <span class="c1"># Updating the notice lists</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateNoticeLists
  <span class="c1"># Updating the object templates</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$RUN_PHP</span> -- <span class="nv">$CAKE</span> Admin updateObjectTemplates <span class="s2">&quot;1337&quot;</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_core-cake.sh&gt;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1"># Add the following lines before the last line (exit 0). Make sure that you replace $WWW_USER with your apache user:</span>
sudo sed -i -e <span class="s1">&#39;$i \echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled\n&#39;</span> /etc/rc.local
sudo sed -i -e <span class="s1">&#39;$i \echo 1024 &gt; /proc/sys/net/core/somaxconn\n&#39;</span> /etc/rc.local
sudo sed -i -e <span class="s1">&#39;$i \sysctl vm.overcommit_memory=1\n&#39;</span> /etc/rc.local
</pre></div>

<h4 id="install-misp-modules-optional">Install misp-modules (optional)<a class="headerlink" href="#install-misp-modules-optional" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 3_misp-modules.sh&gt;</span>
<span class="c1"># Main MISP Modules install function</span>
mispmodules <span class="o">()</span> <span class="o">{</span>
  <span class="nb">cd</span> /usr/local/src/
  <span class="c1">## TODO: checkUsrLocalSrc in main doc</span>
  debug <span class="s2">&quot;Cloning misp-modules&quot;</span>
  <span class="nv">$SUDO_USER</span> git clone https://github.com/MISP/misp-modules.git
  <span class="nb">cd</span> misp-modules
  <span class="c1"># some misp-modules dependencies</span>
  sudo apt install libpq5 libjpeg-dev tesseract-ocr libpoppler-cpp-dev imagemagick libopencv-dev zbar-tools libzbar0 libzbar-dev libfuzzy-dev -y
  <span class="c1"># If you build an egg, the user you build it as need write permissions in the CWD</span>
  sudo chgrp <span class="nv">$WWW_USER</span> .
  sudo chmod g+w .
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -I -r REQUIREMENTS
  sudo chgrp staff .
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -I .
  <span class="c1">## sudo gem install asciidoctor-pdf --pre</span>

  <span class="c1"># Start misp-modules as a service</span>
  sudo cp etc/systemd/system/misp-modules.service /etc/systemd/system/
  sudo systemctl daemon-reload
  sudo systemctl <span class="nb">enable</span> --now misp-modules

  <span class="c1"># Sleep 9 seconds to give misp-modules a chance to spawn</span>
  sleep <span class="m">9</span>

  <span class="c1"># Enable Enrichment, set better timeouts</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_hover_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_hover_timeout&quot;</span> <span class="m">150</span>
  <span class="c1"># TODO:&quot;Investigate why the next one fails&quot;</span>
  <span class="c1">#$SUDO_WWW $CAKE Admin setSetting &quot;Plugin.Enrichment_asn_history_enabled&quot; true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_cve_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_dns_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_btc_steroids_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_ipasn_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_yara_syntax_validator_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_yara_query_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_pdf_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_docx_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_xlsx_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_pptx_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_ods_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_odt_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_port&quot;</span> <span class="m">6666</span>

  <span class="c1"># Enable Import modules, set better timeout</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_port&quot;</span> <span class="m">6666</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_ocr_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_mispjson_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_openiocimport_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_threatanalyzer_import_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_csvimport_enabled&quot;</span> <span class="nb">true</span>

  <span class="c1"># Enable Export modules, set better timeout</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_port&quot;</span> <span class="m">6666</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_pdfexport_enabled&quot;</span> <span class="nb">true</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 3_misp-modules.sh&gt;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;Admin (root) DB Password: </span><span class="nv">$DBPASSWORD_ADMIN</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;User  (misp) DB Password: </span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&quot;</span>
</pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you have installed the recommended Python 3 virtualenv to the recommended place of <strong>${PATH_TO_MISP}/venv</strong> set the following MISP configurable
<div class="codehilite"><pre><span></span>sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.python_bin&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span><span class="s2">/venv/bin/python&quot;</span>
</pre></div>
or on CentOS
<div class="codehilite"><pre><span></span>sudo -u apache <span class="nv">$RUN_PHP</span> <span class="s2">&quot;</span><span class="nv">$CAKE</span><span class="s2"> Admin setSetting &quot;</span>MISP.python_bin<span class="s2">&quot; &quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/python<span class="s2">&quot;&quot;</span>
</pre></div></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure that the STIX libraries and GnuPG work as intended, if not, refer to the relevant sections in the install guide you are currently reading.</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Now log in using the webinterface: http://misp/users/login<br />
The default user/pass = <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#100;&#109;&#105;&#110;&#64;&#97;&#100;&#109;&#105;&#110;&#46;&#116;&#101;&#115;&#116;">&#97;&#100;&#109;&#105;&#110;&#64;&#97;&#100;&#109;&#105;&#110;&#46;&#116;&#101;&#115;&#116;</a>/admin<br />
Using the server settings tool in the admin interface (Administration -&gt; Server Settings), set MISP up to your preference.<br />
It is especially vital that no critical issues remain!<br />
Don't forget to change the email, password and authentication key after installation.<br />
Once done, have a look at the diagnostics.</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If any of the directories that MISP uses to store files is not writeable to the apache user, change the permissions<br />
you can do this by running the following commands:
<div class="codehilite"><pre><span></span>chmod -R <span class="m">750</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/&lt;directory path with an indicated issue&gt;
<span class="c1"># /!\ Depending on your OS replace www-data with apache or www or whatever user is the web server user.</span>
chown -R www-data:www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/&lt;directory path with an indicated issue&gt;
</pre></div></p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If anything goes wrong, make sure that you check MISP's logs for errors:
<div class="codehilite"><pre><span></span># ${PATH_TO_MISP}/app/tmp/logs/error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-worker-error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-scheduler-error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-2018-10-25.log //where the actual date is the current date
</pre></div></p>
</div>
<h3 id="recommended-actions">Recommended actions<a class="headerlink" href="#recommended-actions" title="Permanent link">&para;</a></h3>
<hr />
<ul>
<li>
<p>By default CakePHP exposes its name and version in email headers. Apply a patch to remove this behavior.</p>
</li>
<li>
<p>You should really harden your OS</p>
</li>
<li>You should really harden the configuration of Apache</li>
<li>You should really harden the configuration of MySQL</li>
<li>Keep your software up2date (MISP, CakePHP and everything else)</li>
<li>Log and audit</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can add the following to your shell startup rc scripts to have the <em>cake</em> and <em>viper-cli</em> commands in your $PATH
<div class="codehilite"><pre><span></span><span class="c1"># set PATH so it includes viper if it exists</span>
<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;/usr/local/src/viper&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/usr/local/src/viper&quot;</span>
<span class="k">fi</span>

<span class="c1"># set PATH so it includes viper if it exists</span>
<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;/var/www/MISP/app/Console&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/var/www/MISP/app/Console&quot;</span>
<span class="k">fi</span>
</pre></div></p>
</div>
<h4 id="misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-commands">MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following commands<a class="headerlink" href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-commands" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install pyzmq
</pre></div>

<h4 id="misp-has-a-feature-for-publishing-events-to-kafka-to-enable-it-simply-run-the-following-commands">MISP has a feature for publishing events to Kafka. To enable it, simply run the following commands<a class="headerlink" href="#misp-has-a-feature-for-publishing-events-to-kafka-to-enable-it-simply-run-the-following-commands" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo apt install librdkafka-dev php-dev
sudo pecl channel-update pecl.php.net
sudo pecl install rdkafka
<span class="nb">echo</span> <span class="s2">&quot;extension=rdkafka.so&quot;</span> <span class="p">|</span> sudo tee <span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/mods-available/rdkafka.ini
sudo phpenmod rdkafka
sudo service apache2 restart
</pre></div>

<h4 id="misp-dashboard">MISP Dashboard<a class="headerlink" href="#misp-dashboard" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 4_misp-dashboard.sh&gt;</span>
<span class="c1"># Main MISP Dashboard install function</span>
mispDashboard <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Install misp-dashboard&quot;</span>
  <span class="c1"># Install pyzmq to main MISP venv</span>
  debug <span class="s2">&quot;Installing PyZMQ&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install pyzmq
  <span class="nb">cd</span> /var/www
  sudo mkdir misp-dashboard
  sudo chown <span class="nv">$WWW_USER</span>:<span class="nv">$WWW_USER</span> misp-dashboard

  <span class="nv">$SUDO_WWW</span> git clone https://github.com/MISP/misp-dashboard.git
  <span class="nb">cd</span> misp-dashboard
  sudo -H /var/www/misp-dashboard/install_dependencies.sh
  sudo sed -i <span class="s2">&quot;s/^host\ =\ localhost/host\ =\ 0.0.0.0/g&quot;</span> /var/www/misp-dashboard/config/config.cfg
  sudo sed -i <span class="s1">&#39;/Listen 80/a Listen 0.0.0.0:8001&#39;</span> /etc/apache2/ports.conf
  sudo apt install libapache2-mod-wsgi-py3 net-tools -y
  <span class="nb">echo</span> <span class="s2">&quot;&lt;VirtualHost *:8001&gt;</span>
<span class="s2">      ServerAdmin admin@misp.local</span>
<span class="s2">      ServerName misp.local</span>

<span class="s2">      DocumentRoot /var/www/misp-dashboard</span>

<span class="s2">      WSGIDaemonProcess misp-dashboard \</span>
<span class="s2">         user=misp group=misp \</span>
<span class="s2">         python-home=/var/www/misp-dashboard/DASHENV \</span>
<span class="s2">         processes=1 \</span>
<span class="s2">         threads=15 \</span>
<span class="s2">         maximum-requests=5000 \</span>
<span class="s2">         listen-backlog=100 \</span>
<span class="s2">         queue-timeout=45 \</span>
<span class="s2">         socket-timeout=60 \</span>
<span class="s2">         connect-timeout=15 \</span>
<span class="s2">         request-timeout=60 \</span>
<span class="s2">         inactivity-timeout=0 \</span>
<span class="s2">         deadlock-timeout=60 \</span>
<span class="s2">         graceful-timeout=15 \</span>
<span class="s2">         eviction-timeout=0 \</span>
<span class="s2">         shutdown-timeout=5 \</span>
<span class="s2">         send-buffer-size=0 \</span>
<span class="s2">         receive-buffer-size=0 \</span>
<span class="s2">         header-buffer-size=0 \</span>
<span class="s2">         response-buffer-size=0 \</span>
<span class="s2">         server-metrics=Off</span>

<span class="s2">      WSGIScriptAlias / /var/www/misp-dashboard/misp-dashboard.wsgi</span>

<span class="s2">      &lt;Directory /var/www/misp-dashboard&gt;</span>
<span class="s2">          WSGIProcessGroup misp-dashboard</span>
<span class="s2">          WSGIApplicationGroup %{GLOBAL}</span>
<span class="s2">          Require all granted</span>
<span class="s2">      &lt;/Directory&gt;</span>

<span class="s2">      LogLevel info</span>
<span class="s2">      ErrorLog /var/log/apache2/misp-dashboard.local_error.log</span>
<span class="s2">      CustomLog /var/log/apache2/misp-dashboard.local_access.log combined</span>
<span class="s2">      ServerSignature Off</span>
<span class="s2">  &lt;/VirtualHost&gt;&quot;</span> <span class="p">|</span> sudo tee /etc/apache2/sites-available/misp-dashboard.conf

  <span class="c1"># Enable misp-dashboard in apache and reload</span>
  sudo a2ensite misp-dashboard
  sudo systemctl restart apache2

  <span class="c1"># Needs to be started after apache2 is reloaded so the port status check works</span>
  <span class="nv">$SUDO_WWW</span> bash /var/www/misp-dashboard/start_all.sh

  <span class="c1"># Add misp-dashboard to rc.local to start on boot.</span>
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u www-data bash /var/www/misp-dashboard/start_all.sh &gt; /tmp/misp-dashboard_rc.local.log\n&#39;</span> /etc/rc.local
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 4_misp-dashboard.sh&gt;</span>

<span class="c1"># &lt;snippet-begin 4_misp-dashboard-cake.sh&gt;</span>
dashboardCAKE <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># Enable ZeroMQ for misp-dashboard</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_event_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_object_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_object_reference_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_attribute_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_sighting_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_user_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_organisation_notifications_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_port&quot;</span> <span class="m">50000</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_host&quot;</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_port&quot;</span> <span class="m">6379</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_database&quot;</span> <span class="m">1</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_namespace&quot;</span> <span class="s2">&quot;mispq&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_include_attachments&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_tag_notifications_enable&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_audit_notifications_enable&quot;</span> <span class="nb">false</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 4_misp-dashboard-cake.sh&gt;</span>
</pre></div>

<h4 id="install-viper-framework-with-a-virtualenv">Install viper framework (with a virtualenv)<a class="headerlink" href="#install-viper-framework-with-a-virtualenv" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 6_viper.sh&gt;</span>
<span class="c1"># Main Viper install function</span>
viper <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing Viper dependencies&quot;</span>
  <span class="nb">cd</span> /usr/local/src/
  sudo apt-get install <span class="se">\</span>
    libssl-dev swig python3-ssdeep p7zip-full unrar-free sqlite python3-pyclamd exiftool radare2 <span class="se">\</span>
    python3-magic python3-sqlalchemy python3-prettytable libffi-dev libfreetype6-dev libpng-dev -qy
  <span class="nb">echo</span> <span class="s2">&quot;Cloning Viper&quot;</span>
  <span class="nv">$SUDO_USER</span> git clone https://github.com/viper-framework/viper.git
  sudo chown -R <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_USER</span> viper
  <span class="nb">cd</span> viper
  <span class="nb">echo</span> <span class="s2">&quot;Creating virtualenv&quot;</span>
  <span class="nv">$SUDO_USER</span> virtualenv -p python3 venv
  <span class="nb">echo</span> <span class="s2">&quot;Submodule update&quot;</span>
  <span class="c1"># TODO: Check for current user install permissions</span>
  <span class="nv">$SUDO_USER</span> git submodule update --init --recursive
  <span class="c1">##$SUDO git submodule update --init --recursive</span>
  <span class="nb">echo</span> <span class="s2">&quot;Pip install deps&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install SQLAlchemy PrettyTable python-magic
  <span class="nb">echo</span> <span class="s2">&quot;pip install scrapy&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install scrapy
  <span class="nb">echo</span> <span class="s2">&quot;install lief&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install https://github.com/lief-project/packages/raw/lief-master-latest/pylief-0.9.0.dev.zip
  <span class="nb">echo</span> <span class="s2">&quot;pip install reqs&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install -r requirements.txt
  <span class="nv">$SUDO_USER</span> sed -i <span class="s1">&#39;1 s/^.*$/\#!\/usr\/local\/src\/viper\/venv\/bin\/python/&#39;</span> viper-cli
  <span class="nv">$SUDO_USER</span> sed -i <span class="s1">&#39;1 s/^.*$/\#!\/usr\/local\/src\/viper\/venv\/bin\/python/&#39;</span> viper-web
  <span class="nb">echo</span> <span class="s2">&quot;Launching viper-cli&quot;</span>
  <span class="nv">$SUDO_USER</span> /usr/local/src/viper/viper-cli -h &gt; /dev/null
  <span class="nb">echo</span> <span class="s2">&quot;Launching viper-web&quot;</span>
  <span class="nv">$SUDO_USER</span> /usr/local/src/viper/viper-web -p <span class="m">8888</span> -H <span class="m">0</span>.0.0.0 <span class="p">&amp;</span>
  <span class="nb">echo</span> <span class="s1">&#39;PATH=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/local/src/viper:/var/www/MISP/app/Console&quot;&#39;</span> <span class="p">|</span>sudo tee /etc/environment
  <span class="nb">echo</span> <span class="s2">&quot;. /etc/environment&quot;</span> &gt;&gt; /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/.profile

  <span class="c1"># TODO: Perms, MISP_USER_HOME, nasty hack cuz Kali on R00t</span>
  <span class="k">if</span> <span class="o">[</span> -f /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/.viper/viper.conf <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">VIPER_HOME</span><span class="o">=</span><span class="s2">&quot;/home/</span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">/.viper&quot;</span>
  <span class="k">else</span>
    <span class="nv">VIPER_HOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.viper&quot;</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> <span class="s2">&quot;Setting misp_url/misp_key&quot;</span>
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_url\ =/misp_url\ =\ http:\/\/localhost/g&quot;</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/viper.conf
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_key\ =/misp_key\ =\ </span><span class="nv">$AUTH_KEY</span><span class="s2">/g&quot;</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/viper.conf
  <span class="c1"># Reset admin password to: admin/Password1234</span>
  <span class="nb">echo</span> <span class="s2">&quot;Fixing admin.db with default password&quot;</span>
  <span class="nv">VIPER_COUNT</span><span class="o">=</span><span class="m">0</span>
  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>sudo sqlite3 <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/admin.db <span class="s1">&#39;UPDATE auth_user SET password=&quot;pbkdf2_sha256$100000$iXgEJh8hz7Cf$vfdDAwLX8tko1t0M1TLTtGlxERkNnltUnMhbv56wK/U=&quot;&#39;</span><span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span><span class="s2">&quot;</span> -ne <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="c1"># FIXME This might lead to a race condition, the while loop is sub-par</span>
    sudo chown <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_USER</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/admin.db
    <span class="nb">echo</span> <span class="s2">&quot;Updating viper-web admin password, giving process time to start-up, sleeping 5, 4, 3,&quot;</span>
    sleep <span class="m">6</span>
    <span class="nv">VIPER_COUNT</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$VIPER_COUNT</span>+1<span class="o">]</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$VIPER_COUNT</span><span class="s2">&quot;</span> &gt; <span class="s1">&#39;10&#39;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Something is wrong with updating viper. Continuing without db update.&quot;</span>
      <span class="nb">break</span>
    <span class="k">fi</span>
  <span class="k">done</span>

  <span class="c1"># Add viper-web to rc.local to be started on boot</span>
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u misp /usr/local/src/viper/viper-web -p 8888 -H 0.0.0.0 &gt; /tmp/viper-web_rc.local.log &amp;\n&#39;</span> /etc/rc.local
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 6_viper.sh&gt;</span>
</pre></div>

<h4 id="experimental-ssdeep-correlations">Experimental ssdeep correlations<a class="headerlink" href="#experimental-ssdeep-correlations" title="Permanent link">&para;</a></h4>
<h5 id="installing-ssdeep">installing ssdeep<a class="headerlink" href="#installing-ssdeep" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 6_ssdeep.sh&gt;</span>
ssdeep <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Install ssdeep 2.14.1&quot;</span>
  <span class="nb">cd</span> /usr/local/src
  <span class="nv">$SUDO_USER</span> wget https://github.com/ssdeep-project/ssdeep/releases/download/release-2.14.1/ssdeep-2.14.1.tar.gz
  <span class="nv">$SUDO_USER</span> tar zxvf ssdeep-2.14.1.tar.gz
  <span class="nb">cd</span> ssdeep-2.14.1
  <span class="nv">$SUDO_USER</span> ./configure --datadir<span class="o">=</span>/usr --prefix<span class="o">=</span>/usr --localstatedir<span class="o">=</span>/var --sysconfdir<span class="o">=</span>/etc
  <span class="nv">$SUDO_USER</span> make
  sudo make install

  <span class="c1">#installing ssdeep_php</span>
  sudo pecl channel-update pecl.php.net
  sudo pecl install ssdeep

  <span class="c1"># You should add &quot;extension=ssdeep.so&quot; to mods-available - Check /etc/php for your current version</span>
  <span class="nb">echo</span> <span class="s2">&quot;extension=ssdeep.so&quot;</span> <span class="p">|</span> sudo tee <span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/mods-available/ssdeep.ini
  sudo phpenmod ssdeep
  sudo service apache2 restart
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 6_ssdeep.sh&gt;</span>
</pre></div>

<h4 id="install-mail-to-misp">Install mail to misp<a class="headerlink" href="#install-mail-to-misp" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 5_mail_to_misp.sh&gt;</span>
<span class="c1"># Main mail2misp install function</span>
mail2misp <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing Mail2</span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">cd</span> /usr/local/src/
  sudo apt-get install cmake libcaca-dev liblua5.3-dev -y
  <span class="nv">$SUDO_USER</span> git clone https://github.com/MISP/mail_to_misp.git
  <span class="nv">$SUDO_USER</span> git clone git://github.com/stricaud/faup.git faup
  <span class="nv">$SUDO_USER</span> git clone git://github.com/stricaud/gtcaca.git gtcaca
  sudo chown -R <span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>:<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span> faup mail_to_misp gtcaca
  <span class="nb">cd</span> gtcaca
  <span class="nv">$SUDO_USER</span> mkdir -p build
  <span class="nb">cd</span> build
  <span class="nv">$SUDO_USER</span> cmake .. <span class="o">&amp;&amp;</span> <span class="nv">$SUDO_USER</span> make
  sudo make install
  <span class="nb">cd</span> ../../faup
  <span class="nv">$SUDO_USER</span> mkdir -p build
  <span class="nb">cd</span> build
  <span class="nv">$SUDO_USER</span> cmake .. <span class="o">&amp;&amp;</span> <span class="nv">$SUDO_USER</span> make
  sudo make install
  sudo ldconfig
  <span class="nb">cd</span> ../../mail_to_misp
  <span class="nv">$SUDO_USER</span> virtualenv -p python3 venv
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install https://github.com/lief-project/packages/raw/lief-master-latest/pylief-0.9.0.dev.zip
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install -r requirements.txt
  <span class="nv">$SUDO_USER</span> cp mail_to_misp_config.py-example mail_to_misp_config.py
  <span class="c1">##$SUDO cp mail_to_misp_config.py-example mail_to_misp_config.py</span>
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_url\ =\ &#39;YOUR_MISP_URL&#39;/misp_url\ =\ &#39;https:\/\/localhost&#39;/g&quot;</span> /usr/local/src/mail_to_misp/mail_to_misp_config.py
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_key\ =\ &#39;YOUR_KEY_HERE&#39;/misp_key\ =\ &#39;</span><span class="si">${</span><span class="nv">AUTH_KEY</span><span class="si">}</span><span class="s2">&#39;/g&quot;</span> /usr/local/src/mail_to_misp/mail_to_misp_config.py
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 5_mail_to_misp.sh&gt;</span>
</pre></div>

<h4 id="upgrading-all-of-the-above">Upgrading all of the above<a class="headerlink" href="#upgrading-all-of-the-above" title="Permanent link">&para;</a></h4>
<hr />
<h5 id="misp-core">MISP core<a class="headerlink" href="#misp-core" title="Permanent link">&para;</a></h5>
<p>Also refer to this <a href="../UPDATE/">UPDATE section</a> which might partially overlap on the information below.</p>
<p>There are 2 ways to upgrade MISP.
The preferred way is to go into the Web UI "Server Settings &amp; Maintenance" -&gt; "Diagnostics" and click "Update MISP".</p>
<p>If this fails most likely permissions are the reason.</p>
<p>More details can be found in <a href="https://www.circl.lu/doc/misp/faq/#update-misp-fails">MISP Book</a> to resolve the issue.</p>
<p>To fix permissions refer to <a href="https://misp.github.io/MISP/INSTALL.ubuntu1804/#5-set-the-permissions">the install guide</a>.</p>
<p>Another way is to open a shell on your MISP instance and go to the main MISP directory and pull the latest code:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /var/www/MISP
sudo -H -u www-data git pull origin <span class="m">2</span>.4
sudo -H -u www-data git submodule update --init --recursive
</pre></div>

<p>If the above fails, your permissons might be wrong. <a href="https://misp.github.io/MISP/INSTALL.ubuntu1804/#5-set-the-permissions">Click here for the fix the permissions guide</a>.</p>
<h5 id="misp-dependencies">MISP Dependencies<a class="headerlink" href="#misp-dependencies" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><span class="c1"># MISP configuration variables</span>
<span class="nv">PATH_TO_MISP</span><span class="o">=</span><span class="s1">&#39;/var/www/MISP&#39;</span>
<span class="nv">CAKE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/Console/cake&quot;</span>
</pre></div>

<h6 id="virtualenv">virtualenv<a class="headerlink" href="#virtualenv" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span>sudo -H -u www-data virtualenv -p python3 <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-cybox
sudo -u www-data git pull
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-stix
sudo -u www-data git pull
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-maec
sudo -u www-data git pull
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
<span class="c1"># install STIX2.0 library to support STIX 2.0 export:</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/cti-python-stix2
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -I -U .

<span class="c1"># install mixbox to accommodate the new STIX dependencies:</span>
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/mixbox
sudo -u www-data git pull
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
<span class="c1"># install PyMISP</span>
<span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/PyMISP
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
</pre></div>

<h6 id="misp-modules">misp-modules<a class="headerlink" href="#misp-modules" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/src/misp-modules
git pull
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U -I -r REQUIREMENTS
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U .
sudo gem update asciidoctor-pdf --pre
<span class="c1"># install additional dependencies for extended object generation and extraction</span>
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U maec lief python-magic pathlib
sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U git+https://github.com/kbandla/pydeep.git
</pre></div>

<h6 id="pyzmq">pyzmq<a class="headerlink" href="#pyzmq" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span>sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -U pyzmq
</pre></div>

<h6 id="misp-dashboard_1">misp-dashboard<a class="headerlink" href="#misp-dashboard_1" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /var/www/misp-dashboard
sudo -H -u www-data git pull
sudo -H /var/www/misp-dashboard/install_dependencies.sh
</pre></div>

<h6 id="viper">viper<a class="headerlink" href="#viper" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/src/viper
git pull
virtualenv -p python3.6 venv
git submodule update --init --recursive
./venv/bin/pip install -U scrapy
./venv/bin/pip install -U -r requirements.txt
/usr/local/src/viper/viper-cli -h
</pre></div>

<h6 id="mail-to-misp">mail-to-misp<a class="headerlink" href="#mail-to-misp" title="Permanent link">&para;</a></h6>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/src/faup
git pull
make clean
rm -r build <span class="p">;</span> mkdir build
<span class="nb">cd</span> build
cmake .. <span class="o">&amp;&amp;</span> make
sudo make install
sudo ldconfig
<span class="nb">cd</span> /usr/local/src/mail_to_misp
git pull
virtualenv -p python3.6 venv
./venv/bin/pip install -U -r requirements.txt
diff -u mail_to_misp_config.py-example mail_to_misp_config.py
</pre></div>

<h1 id="hardening-a-base-system">Hardening a base system<a class="headerlink" href="#hardening-a-base-system" title="Permanent link">&para;</a></h1>
<h2 id="intro">Intro<a class="headerlink" href="#intro" title="Permanent link">&para;</a></h2>
<p>MISP is a web-based <strong>information sharing platform</strong>, by design it is kept rather simple and hardening can be done by following the common best practices.</p>
<p>Bare in mind that neither the MISP documentation efforts or the core MISP project can give you the ultimate guide on how to harden your system.
This is not the purpose of the MISP Project but the purpose and care of those individuals and organizations deploying MISP Instances.</p>
<p>Nevertheless here is a very rough <strong>food for thoughts</strong> bulletpoint list for you to consider, and a list of some hardening ressources below.</p>
<ul>
<li>Are we using SSL by default? (Especially when syncing over the internet and exposing the API)</li>
<li>How to we access the machine remotely? Via ssh? What is the path to get there? Does a <a href="https://en.wikipedia.org/wiki/Bastion_host">bastion host</a> make sense?</li>
<li>Is the machine shared with other user accounts? Do I need to care about useri-land security due to this sharing?</li>
<li>Is the instance deployed in the "<strong>cloud</strong>"? Is it a VPS? AWS? docker? ansible? kubernetes? whateverCloudContainterMagicIsFancibleNow?</li>
<li>Do we need to encrypt the partitions where some data is stored?</li>
<li>Are we redundant in case one MISP instance might fail?</li>
<li>Is the database server and any other servers running on the machine bound to <strong>localhost</strong>? Do we need to expose because our setup is more complex?</li>
<li>Do we have enough storage? What about <a href="https://misp-project.org/MISP-sizer/">MISP and size estimation</a> anyways?</li>
<li>Do we care about BIOS updates?</li>
<li>Do we care about physical access to the servers? (Disabling USB ports etc...)</li>
<li>Is any fancy management engine  la <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">IME</a> in use?</li>
</ul>
<h2 id="apache">Apache<a class="headerlink" href="#apache" title="Permanent link">&para;</a></h2>
<p>To make Apache less verbose in terms of sending banners, the belo might help.</p>
<div class="codehilite"><pre><span></span>diff --git a/apache2/conf-available/security.conf b/apache2/conf-available/security.conf
index f9f69d4..2e8fd78 100644
--- a/apache2/conf-available/security.conf
+++ b/apache2/conf-available/security.conf
@@ -22,7 +22,7 @@
 # Set to one of:  Full | OS | Minimal | Minor | Major | Prod
 # where Full conveys the most information, and Prod the least.
 #ServerTokens Minimal
-ServerTokens OS
+ServerTokens Prod
 #ServerTokens Full

 #
@@ -33,7 +33,7 @@ ServerTokens OS
 # Set to &quot;EMail&quot; to also include a mailto: link to the ServerAdmin.
 # Set to one of:  On | Off | EMail
 #ServerSignature Off
-ServerSignature On
+ServerSignature Off

 #
 # Allow TRACE method
</pre></div>

<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<p><a href="https://www.ncsc.nl/english/current-topics/factsheets/it-security-guidelines-for-transport-layer-security-tls.html">IT Security Guidelines for TLS by NCSC.nl</a></p>
<p><a href="https://weakdh.org/sysadmin.html">Weak Diffie-Hellman and the Logjam Attack</a></p>
<p><a href="https://wiki.debian.org/Hardening">Debian Wiki Hardening</a></p>
<p><a href="https://wiki.centos.org/HowTos/OS_Protection">CentOS Hardening</a></p>
<p><a href="https://www.cyberciti.biz/tips/linux-security.html">Some Linux hardening tips</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../xINSTALL.centos6/" title="Centos 6" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Centos 6
              </span>
            </div>
          </a>
        
        
          <a href="../xINSTALL.debian_testing/" title="Debian testing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Debian testing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 MISP Project
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://www.misp-project.org/" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/MISP" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/MISPProject" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>