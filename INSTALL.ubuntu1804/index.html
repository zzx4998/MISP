



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="MISP Project - Install Guides">
      
      
        <link rel="canonical" href="https://www.misp-project.org/INSTALL.ubuntu1804/">
      
      
        <meta name="author" content="MISP Project">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Ubuntu 18.04 - MISP Install Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#installation-instructions" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.misp-project.org/" title="MISP Install Documentation" class="md-header-nav__button md-logo">
          
            <img src="../img/misp.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              MISP Install Documentation
            </span>
            <span class="md-header-nav__topic">
              Ubuntu 18.04
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/MISP/MISP" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MISP/MISP
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.misp-project.org/" title="MISP Install Documentation" class="md-nav__button md-logo">
      
        <img src="../img/misp.png" width="48" height="48">
      
    </a>
    MISP Install Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/MISP/MISP" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MISP/MISP
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Install Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Install Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Ubuntu 18.04
      </label>
    
    <a href="./" title="Ubuntu 18.04" class="md-nav__link md-nav__link--active">
      Ubuntu 18.04
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#for-ubuntu-18041-server" title="for Ubuntu 18.04.1-server" class="md-nav__link">
    for Ubuntu 18.04.1-server
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-1-installer-and-manual-install-instructions" title="-1/ Installer and Manual install instructions" class="md-nav__link">
    -1/ Installer and Manual install instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-minimal-ubuntu-install" title="1/ Minimal Ubuntu install" class="md-nav__link">
    1/ Minimal Ubuntu install
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-a-minimal-ubuntu-1804-server-system-with-the-software" title="Install a minimal Ubuntu 18.04-server system with the software:" class="md-nav__link">
    Install a minimal Ubuntu 18.04-server system with the software:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-your-system-is-up2date" title="Make sure your system is up2date" class="md-nav__link">
    Make sure your system is up2date
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-etckeeper-and-sudo-optional" title="install etckeeper and sudo (optional)" class="md-nav__link">
    install etckeeper and sudo (optional)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="add the misp user to staff and www-data (mandatory)" class="md-nav__link">
    add the misp user to staff and www-data (mandatory)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-interface-name-salvage-optional" title="Network Interface Name salvage (optional)" class="md-nav__link">
    Network Interface Name salvage (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-postfix-there-will-be-some-questions" title="install postfix, there will be some questions." class="md-nav__link">
    install postfix, there will be some questions.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-configuration-variables" title="MISP configuration variables" class="md-nav__link">
    MISP configuration variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-install-lamp-dependencies" title="2/ Install LAMP &amp; dependencies" class="md-nav__link">
    2/ Install LAMP &amp; dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-misp-code" title="3/ MISP code" class="md-nav__link">
    3/ MISP code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cakephp" title="4/ CakePHP" class="md-nav__link">
    4/ CakePHP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-set-the-permissions" title="5/ Set the permissions" class="md-nav__link">
    5/ Set the permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-create-a-database-and-user" title="6/ Create a database and user" class="md-nav__link">
    6/ Create a database and user
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-db-user-and-import-empty-misp-db" title="Set-up DB, User and import empty MISP DB" class="md-nav__link">
    Set-up DB, User and import empty MISP DB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-apache-configuration" title="7/ Apache configuration" class="md-nav__link">
    7/ Apache configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache-version-24-config" title="Apache version 2.4 config:" class="md-nav__link">
    Apache version 2.4 config:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-log-rotation" title="8/ Log rotation" class="md-nav__link">
    8/ Log rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-misp-configuration" title="9/ MISP configuration" class="md-nav__link">
    9/ MISP configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialize-misp-configuration-and-set-some-defaults" title="Initialize MISP configuration and set some defaults" class="md-nav__link">
    Initialize MISP configuration and set some defaults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-misp-modules-optional" title="Install misp-modules (optional)" class="md-nav__link">
    Install misp-modules (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-actions" title="Recommended actions" class="md-nav__link">
    Recommended actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-features" title="Optional features" class="md-nav__link">
    Optional features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-command" title="MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following command" class="md-nav__link">
    MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard" title="MISP Dashboard" class="md-nav__link">
    MISP Dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-viper-framework-with-a-virtualenv" title="Install viper framework (with a virtualenv)" class="md-nav__link">
    Install viper framework (with a virtualenv)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#experimental-ssdeep-correlations" title="Experimental ssdeep correlations" class="md-nav__link">
    Experimental ssdeep correlations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-ssdeep" title="installing ssdeep" class="md-nav__link">
    installing ssdeep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mail-to-misp" title="Install mail to misp" class="md-nav__link">
    Install mail to misp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.kali/" title="Kali Linux" class="md-nav__link">
      Kali Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALL.rhel7/" title="Redhat Enterprise Linux 7" class="md-nav__link">
      Redhat Enterprise Linux 7
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      xInstall Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        xInstall Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL/" title="Warning" class="md-nav__link">
      Warning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.centos6/" title="Centos 6" class="md-nav__link">
      Centos 6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.centos7/" title="Centos 7" class="md-nav__link">
      Centos 7
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.debian9/" title="Debian stable" class="md-nav__link">
      Debian stable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.debian_testing/" title="Debian testing" class="md-nav__link">
      Debian testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.debian9-postgresql/" title="Debian 9 \w postgresql" class="md-nav__link">
      Debian 9 \w postgresql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.ubuntu1804.with.webmin/" title="Ubuntu 18.04 \w webmin" class="md-nav__link">
      Ubuntu 18.04 \w webmin
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.tsurugi/" title="Tsurugi Linux" class="md-nav__link">
      Tsurugi Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.OpenBSD/" title="OpenBSD 6.4" class="md-nav__link">
      OpenBSD 6.4
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xINSTALL.rhel7/" title="Redhat Enterprise Linux 7.6 (BETA)" class="md-nav__link">
      Redhat Enterprise Linux 7.6 (BETA)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Config Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Config Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.elasticsearch-logging/" title="Elastic Search Logging" class="md-nav__link">
      Elastic Search Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.s3-attachments/" title="Amazon S3 attachments" class="md-nav__link">
      Amazon S3 attachments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../CONFIG.SMIME/" title="S/MIME" class="md-nav__link">
      S/MIME
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../UPDATE/" title="Update MISP" class="md-nav__link">
      Update MISP
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../UPGRADE/" title="Upgrading MISP" class="md-nav__link">
      Upgrading MISP
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Old guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Old guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/old-2_3to2_4-UPGRADE/" title="2.3 to 2.4 upgrade" class="md-nav__link">
      2.3 to 2.4 upgrade
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/INSTALL.ubuntu1604/" title="Ubuntu 16.04" class="md-nav__link">
      Ubuntu 16.04
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../archive/xINSTALL.FreeBSD/" title="FreeBSD" class="md-nav__link">
      FreeBSD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Changelog/" title="MISP Release Notes" class="md-nav__link">
      MISP Release Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#for-ubuntu-18041-server" title="for Ubuntu 18.04.1-server" class="md-nav__link">
    for Ubuntu 18.04.1-server
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-1-installer-and-manual-install-instructions" title="-1/ Installer and Manual install instructions" class="md-nav__link">
    -1/ Installer and Manual install instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-minimal-ubuntu-install" title="1/ Minimal Ubuntu install" class="md-nav__link">
    1/ Minimal Ubuntu install
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-a-minimal-ubuntu-1804-server-system-with-the-software" title="Install a minimal Ubuntu 18.04-server system with the software:" class="md-nav__link">
    Install a minimal Ubuntu 18.04-server system with the software:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-your-system-is-up2date" title="Make sure your system is up2date" class="md-nav__link">
    Make sure your system is up2date
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-etckeeper-and-sudo-optional" title="install etckeeper and sudo (optional)" class="md-nav__link">
    install etckeeper and sudo (optional)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="add the misp user to staff and www-data (mandatory)" class="md-nav__link">
    add the misp user to staff and www-data (mandatory)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-interface-name-salvage-optional" title="Network Interface Name salvage (optional)" class="md-nav__link">
    Network Interface Name salvage (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-postfix-there-will-be-some-questions" title="install postfix, there will be some questions." class="md-nav__link">
    install postfix, there will be some questions.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-configuration-variables" title="MISP configuration variables" class="md-nav__link">
    MISP configuration variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-install-lamp-dependencies" title="2/ Install LAMP &amp; dependencies" class="md-nav__link">
    2/ Install LAMP &amp; dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-misp-code" title="3/ MISP code" class="md-nav__link">
    3/ MISP code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cakephp" title="4/ CakePHP" class="md-nav__link">
    4/ CakePHP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-set-the-permissions" title="5/ Set the permissions" class="md-nav__link">
    5/ Set the permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-create-a-database-and-user" title="6/ Create a database and user" class="md-nav__link">
    6/ Create a database and user
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-db-user-and-import-empty-misp-db" title="Set-up DB, User and import empty MISP DB" class="md-nav__link">
    Set-up DB, User and import empty MISP DB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-apache-configuration" title="7/ Apache configuration" class="md-nav__link">
    7/ Apache configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache-version-24-config" title="Apache version 2.4 config:" class="md-nav__link">
    Apache version 2.4 config:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-log-rotation" title="8/ Log rotation" class="md-nav__link">
    8/ Log rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-misp-configuration" title="9/ MISP configuration" class="md-nav__link">
    9/ MISP configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialize-misp-configuration-and-set-some-defaults" title="Initialize MISP configuration and set some defaults" class="md-nav__link">
    Initialize MISP configuration and set some defaults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-misp-modules-optional" title="Install misp-modules (optional)" class="md-nav__link">
    Install misp-modules (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-actions" title="Recommended actions" class="md-nav__link">
    Recommended actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-features" title="Optional features" class="md-nav__link">
    Optional features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-command" title="MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following command" class="md-nav__link">
    MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misp-dashboard" title="MISP Dashboard" class="md-nav__link">
    MISP Dashboard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-viper-framework-with-a-virtualenv" title="Install viper framework (with a virtualenv)" class="md-nav__link">
    Install viper framework (with a virtualenv)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#experimental-ssdeep-correlations" title="Experimental ssdeep correlations" class="md-nav__link">
    Experimental ssdeep correlations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-ssdeep" title="installing ssdeep" class="md-nav__link">
    installing ssdeep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mail-to-misp" title="Install mail to misp" class="md-nav__link">
    Install mail to misp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="installation-instructions">INSTALLATION INSTRUCTIONS<a class="headerlink" href="#installation-instructions" title="Permanent link">&para;</a></h1>
<h2 id="for-ubuntu-18041-server">for Ubuntu 18.04.1-server<a class="headerlink" href="#for-ubuntu-18041-server" title="Permanent link">&para;</a></h2>
<h3 id="-1-installer-and-manual-install-instructions">-1/ Installer and Manual install instructions<a class="headerlink" href="#-1-installer-and-manual-install-instructions" title="Permanent link">&para;</a></h3>
<p>Make sure you are reading the parsed version of this Document. When in doubt <a href="https://misp.github.io/MISP/INSTALL.ubuntu1804/">click here</a>.</p>
<p>To install MISP on a fresh Ubuntu install all you need to do is:</p>
<div class="codehilite"><pre><span></span><span class="c1"># Please check the installer options first to make the best choice for your install</span>
curl -fsSL https://raw.githubusercontent.com/MISP/MISP/2.4/INSTALL/INSTALL.debian.sh <span class="p">|</span> bash -s

<span class="c1"># This will install MISP Core and misp-modules (recommended)</span>
curl -fsSL https://raw.githubusercontent.com/MISP/MISP/2.4/INSTALL/INSTALL.debian.sh <span class="p">|</span> bash -s -- -c -M
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Installer tested working by <a href="https://twitter.com/SteveClement">@SteveClement</a> on 20190212 (works with <strong>Ubuntu 18.10</strong> too)</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>This document also serves as a source for the <a href="https://github.com/MISP/MISP/blob/2.4/INSTALL/INSTALL.debian.sh">INSTALL-misp.sh</a> script.
Which explains why you will see the use of shell <em>functions</em> in various steps.
Henceforth the document will also follow a more logical flow. In the sense that all the dependencies are installed first then config files are generated, etc...</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If the next line is <code>[!generic/core.md!]()</code> <a href="https://misp.github.io/MISP/INSTALL.ubuntu1804/">click here</a>.</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Maintained and tested by the MISP core team.<br />
Enjoy installing MISP. For any issues see <a href="https://github.com/MISP/MISP/issues">here</a></p>
</div>
<h3 id="1-minimal-ubuntu-install">1/ Minimal Ubuntu install<a class="headerlink" href="#1-minimal-ubuntu-install" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="install-a-minimal-ubuntu-1804-server-system-with-the-software">Install a minimal Ubuntu 18.04-server system with the software:<a class="headerlink" href="#install-a-minimal-ubuntu-1804-server-system-with-the-software" title="Permanent link">&para;</a></h4>
<ul>
<li>OpenSSH server</li>
<li>This guide assumes a user name of 'misp' with sudo working</li>
</ul>
<h4 id="make-sure-your-system-is-up2date">Make sure your system is up2date<a class="headerlink" href="#make-sure-your-system-is-up2date" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_apt-upgrade.sh&gt;</span>
aptUpgrade <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Upgrading system&quot;</span>
  checkAptLock
  sudo apt-get update
  sudo apt-get upgrade -qy
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_apt-upgrade.sh&gt;</span>
</pre></div>

<h4 id="install-etckeeper-and-sudo-optional">install etckeeper and sudo (optional)<a class="headerlink" href="#install-etckeeper-and-sudo-optional" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_sudoKeeper.sh&gt;</span>
<span class="c1"># check if sudo is installed</span>
checkSudoKeeper <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Checking for sudo and installing etckeeper&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> ! -f <span class="k">$(</span>which sudo<span class="k">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to install etckeeper&quot;</span>
    su -c <span class="s2">&quot;apt install etckeeper -y&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to install sudo&quot;</span>
    su -c <span class="s2">&quot;apt install sudo -y&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please enter your root password below to add </span><span class="nv">$MISP_USER</span><span class="s2"> to sudo group&quot;</span>
    su -c <span class="s2">&quot;adduser </span><span class="nv">$MISP_USER</span><span class="s2"> sudo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;We added </span><span class="nv">$MISP_USER</span><span class="s2"> to group sudo and now we need to log out and in again.&quot;</span>
    <span class="nb">exit</span>
  <span class="k">else</span>
    sudo apt install etckeeper -y
  <span class="k">fi</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_sudoKeeper.sh&gt;</span>
</pre></div>

<h5 id="add-the-misp-user-to-staff-and-www-data-mandatory">add the misp user to staff and www-data (mandatory)<a class="headerlink" href="#add-the-misp-user-to-staff-and-www-data-mandatory" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin add-user.sh&gt;</span>
<span class="c1"># Add the user to the staff group to be able to write to /usr/local/src</span>
<span class="c1"># TODO: Fix this, user misp might not exist</span>
sudo adduser misp staff
sudo adduser misp www-data
<span class="c1"># &lt;snippet-end add-user.sh&gt;</span>
<span class="c1"># Logout and back in to make the group changes take effect.</span>
<span class="nb">logout</span>
</pre></div>

<h4 id="network-interface-name-salvage-optional">Network Interface Name salvage (optional)<a class="headerlink" href="#network-interface-name-salvage-optional" title="Permanent link">&para;</a></h4>
<p>This will bring back 'ethX' e.g: eth0</p>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-end interfaces.sh&gt;</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;net.ifnames=0 biosdevname=0&quot;</span>
<span class="nv">DEFAULT_GRUB</span><span class="o">=</span>/etc/default/grub

<span class="nb">echo</span> <span class="s2">&quot;--- Using old style name (ethX) for interfaces&quot;</span>
<span class="c1">#for key in GRUB_CMDLINE_LINUX</span>
<span class="c1">#do</span>
<span class="c1">#    sudo sed -i &quot;s/^\($key\)=.*/\1=\&quot;$(eval echo \${$key})\&quot;/&quot; $DEFAULT_GRUB</span>
<span class="c1">#done</span>
sed  -r  <span class="s1">&#39;s/^(GRUB_CMDLINE_LINUX=).*/\1\&quot;net\.ifnames=0\ biosdevname=0\&quot;/&#39;</span> /etc/default/grub <span class="p">|</span> sudo tee /etc/default/grub &gt; /dev/null

<span class="c1"># install ifupdown since ubuntu 18.04</span>
sudo apt-get update
sudo apt-get install -y ifupdown

<span class="c1"># enable eth0</span>
<span class="nb">echo</span> <span class="s2">&quot;--- Configuring eth0&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;# The primary network interface</span>
<span class="s2">auto eth0</span>
<span class="s2">iface eth0 inet dhcp&quot;</span> <span class="p">|</span> sudo tee /etc/network/interfaces
sudo grub-mkconfig -o /boot/grub/grub.cfg
sudo update-grub  &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># &lt;snippet-end interfaces.sh&gt;</span>
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>On recent Ubuntu install Netplan is default and you need to change the Network name.
<div class="codehilite"><pre><span></span>sudo sed -i &quot;s/enp0s3/eth0/&quot; /etc/netplan/50-cloud-init.yaml
</pre></div>
OR on Ubuntu 19.04 (yay for changing this every 5 commits... #n00bs)
<div class="codehilite"><pre><span></span>sudo sed -i &quot;s/enp0s3/eth0/&quot; /etc/netplan/01-netcfg.yaml
</pre></div></p>
</div>
<h4 id="install-postfix-there-will-be-some-questions">install postfix, there will be some questions.<a class="headerlink" href="#install-postfix-there-will-be-some-questions" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin postfix.sh&gt;</span>
sudo apt-get install postfix dialog -qy
<span class="c1"># &lt;snippet-end postfix.sh&gt;</span>
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Postfix Configuration: Satellite system<br />
change the relay server later with:
<div class="codehilite"><pre><span></span>sudo postconf -e <span class="s1">&#39;relayhost = example.com&#39;</span>
sudo postfix reload
</pre></div></p>
</div>
<h4 id="misp-configuration-variables">MISP configuration variables<a class="headerlink" href="#misp-configuration-variables" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_global-vars.sh&gt;</span>
MISPvars <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting generic </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> variables shared by all flavours&quot;</span>
  <span class="c1"># Local non-root MISP user</span>
  <span class="nv">MISP_USER</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">MISP_PASSWORD</span><span class="o">=</span><span class="s1">&#39;Password1234&#39;</span>

  <span class="c1"># The web server user</span>
  <span class="nv">WWW_USER</span><span class="o">=</span><span class="s2">&quot;www-data&quot;</span>

  <span class="c1"># MISP configuration variables</span>
  <span class="nv">PATH_TO_MISP</span><span class="o">=</span><span class="s1">&#39;/var/www/MISP&#39;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$FQDN</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">FQDN</span><span class="o">=</span><span class="s2">&quot;misp.local&quot;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MISP_BASEURL</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s1">&#39;&quot;&quot;&#39;</span>
  <span class="k">fi</span>

  <span class="nv">MISP_LIVE</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>

  <span class="c1"># Database configuration</span>
  <span class="nv">DBHOST</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span>
  <span class="nv">DBNAME</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">DBUSER_ADMIN</span><span class="o">=</span><span class="s1">&#39;root&#39;</span>
  <span class="nv">DBPASSWORD_ADMIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="nv">DBUSER_MISP</span><span class="o">=</span><span class="s1">&#39;misp&#39;</span>
  <span class="nv">DBPASSWORD_MISP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl rand -hex <span class="m">32</span><span class="k">)</span><span class="s2">&quot;</span>

  <span class="c1"># OpenSSL configuration</span>
  <span class="nv">OPENSSL_CN</span><span class="o">=</span><span class="nv">$FQDN</span>
  <span class="nv">OPENSSL_C</span><span class="o">=</span><span class="s1">&#39;LU&#39;</span>
  <span class="nv">OPENSSL_ST</span><span class="o">=</span><span class="s1">&#39;State&#39;</span>
  <span class="nv">OPENSSL_L</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span>
  <span class="nv">OPENSSL_O</span><span class="o">=</span><span class="s1">&#39;Organization&#39;</span>
  <span class="nv">OPENSSL_OU</span><span class="o">=</span><span class="s1">&#39;Organizational Unit&#39;</span>
  <span class="nv">OPENSSL_EMAILADDRESS</span><span class="o">=</span><span class="s2">&quot;info@</span><span class="nv">$FQDN</span><span class="s2">&quot;</span>

  <span class="c1"># GPG configuration</span>
  <span class="nv">GPG_REAL_NAME</span><span class="o">=</span><span class="s1">&#39;Autogenerated Key&#39;</span>
  <span class="nv">GPG_COMMENT</span><span class="o">=</span><span class="s1">&#39;WARNING: MISP AutoGenerated Key consider this Key VOID!&#39;</span>
  <span class="nv">GPG_EMAIL_ADDRESS</span><span class="o">=</span><span class="s1">&#39;admin@admin.test&#39;</span>
  <span class="nv">GPG_KEY_LENGTH</span><span class="o">=</span><span class="s1">&#39;2048&#39;</span>
  <span class="nv">GPG_PASSPHRASE</span><span class="o">=</span><span class="s1">&#39;Password1234&#39;</span>

  <span class="c1"># debug alias to make sure people are not confused when blindly copy pasting blobs of code</span>
  <span class="nb">alias</span> <span class="nv">debug</span><span class="o">=</span><span class="s2">&quot;echo -e&quot;</span>

  <span class="c1"># checkAptLock alias to make sure people are not confused when blindly copy pasting blobs of code</span>
  <span class="nb">alias</span> <span class="nv">checkAptLock</span><span class="o">=</span><span class="s2">&quot;echo &#39;Function used in Installer to make sure apt is not locked&#39;&quot;</span>

  <span class="c1"># php.ini configuration</span>
  <span class="nv">upload_max_filesize</span><span class="o">=</span>50M
  <span class="nv">post_max_size</span><span class="o">=</span>50M
  <span class="nv">max_execution_time</span><span class="o">=</span><span class="m">300</span>
  <span class="nv">memory_limit</span><span class="o">=</span>512M

  <span class="nv">CAKE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/Console/cake&quot;</span>

  <span class="c1"># sudo config to run $LUSER commands</span>
  <span class="nv">SUDO_USER</span><span class="o">=</span><span class="s2">&quot;sudo -H -u </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> &quot;</span>
  <span class="nv">SUDO_WWW</span><span class="o">=</span><span class="s2">&quot;sudo -H -u </span><span class="si">${</span><span class="nv">WWW_USER</span><span class="si">}</span><span class="s2"> &quot;</span>

  <span class="nb">echo</span> <span class="s2">&quot;The following DB Passwords were generated...&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Admin (</span><span class="si">${</span><span class="nv">DBUSER_ADMIN</span><span class="si">}</span><span class="s2">) DB Password: </span><span class="si">${</span><span class="nv">DBPASSWORD_ADMIN</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;User  (</span><span class="si">${</span><span class="nv">DBUSER_MISP</span><span class="si">}</span><span class="s2">) DB Password: </span><span class="si">${</span><span class="nv">DBPASSWORD_MISP</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_global-vars.sh&gt;</span>
</pre></div>

<h3 id="2-install-lamp-dependencies">2/ Install LAMP &amp; dependencies<a class="headerlink" href="#2-install-lamp-dependencies" title="Permanent link">&para;</a></h3>
<hr />
<p>Once the system is installed you can perform the following steps.
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_installCoreDeps.sh&gt;</span>
installCoreDeps <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing core dependencies&quot;</span>
  <span class="c1"># Install the dependencies: (some might already be installed)</span>
  sudo apt-get install curl gcc git gpg-agent make python python3 openssl redis-server sudo vim zip virtualenv libfuzzy-dev -qy

  <span class="c1"># Install MariaDB (a MySQL fork/alternative)</span>
  sudo apt-get install mariadb-client mariadb-server -qy

  <span class="c1"># Install Apache2</span>
  sudo apt-get install apache2 apache2-doc apache2-utils -qy

  <span class="c1"># install Mitre&#39;s STIX and its dependencies by running the following commands:</span>
  sudo apt-get install python3-dev python3-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -qy

  sudo apt-get install python3-pip -qy
  sudo apt install expect -qy
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_installCoreDeps.sh&gt;</span>

<span class="c1"># &lt;snippet-begin 0_installDepsPhp72.sh&gt;</span>
<span class="c1"># Install Php 7.2 dependencies</span>
installDepsPhp72 <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing PHP 7.2 dependencies&quot;</span>
  <span class="nv">PHP_ETC_BASE</span><span class="o">=</span>/etc/php/7.2
  <span class="nv">PHP_INI</span><span class="o">=</span><span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/apache2/php.ini
  sudo apt update
  sudo apt install -qy <span class="se">\</span>
  libapache2-mod-php <span class="se">\</span>
  php php-cli <span class="se">\</span>
  php-dev <span class="se">\</span>
  php-json php-xml php-mysql php-opcache php-readline php-mbstring <span class="se">\</span>
  php-redis php-gnupg

  <span class="k">for</span> key in upload_max_filesize post_max_size max_execution_time max_input_time memory_limit
  <span class="k">do</span>
      sudo sed -i <span class="s2">&quot;s/^\(</span><span class="nv">$key</span><span class="s2">\).*/\1 = </span><span class="k">$(</span><span class="nb">eval</span> <span class="nb">echo</span> <span class="se">\$</span><span class="o">{</span><span class="nv">$key</span><span class="o">}</span><span class="k">)</span><span class="s2">/&quot;</span> <span class="nv">$PHP_INI</span>
  <span class="k">done</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_installDepsPhp72.sh&gt;</span>
</pre></div></p>
<h3 id="3-misp-code">3/ MISP code<a class="headerlink" href="#3-misp-code" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 1_mispCoreInstall.sh&gt;</span>
installCore <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> core&quot;</span>
  <span class="c1"># Download MISP using git in the /var/www/ directory.</span>
  sudo mkdir <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  sudo chown www-data:www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  sudo -u www-data git clone https://github.com/MISP/MISP.git <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  sudo -u www-data git submodule update --init --recursive
  <span class="c1"># Make git ignore filesystem permission differences for submodules</span>
  sudo -u www-data git submodule foreach --recursive git config core.filemode <span class="nb">false</span>

  <span class="c1"># Make git ignore filesystem permission differences</span>
  sudo -u www-data git config core.filemode <span class="nb">false</span>

  <span class="c1"># Create a python3 virtualenv</span>
  sudo -u www-data virtualenv -p python3 <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv

  <span class="c1"># make pip happy</span>
  sudo mkdir /var/www/.cache/
  sudo chown www-data:www-data /var/www/.cache

  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/files/scripts
  sudo -H -u www-data git clone https://github.com/CybOXProject/python-cybox.git
  sudo -H -u www-data git clone https://github.com/STIXProject/python-stix.git
  sudo -H -u www-data git clone https://github.com/MAECProject/python-maec.git

  <span class="c1"># install mixbox to accommodate the new STIX dependencies:</span>
  sudo -H -u www-data git clone https://github.com/CybOXProject/mixbox.git
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/files/scripts/mixbox
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/files/scripts/python-cybox
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/files/scripts/python-stix
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
  <span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/python-maec
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .
  <span class="c1"># install STIX2.0 library to support STIX 2.0 export:</span>
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/cti-python-stix2
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .

  <span class="c1"># install PyMISP</span>
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/PyMISP
  sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install .

  <span class="c1"># install pydeep</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install git+https://github.com/kbandla/pydeep.git

  <span class="c1"># install lief</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install https://github.com/lief-project/packages/raw/lief-master-latest/pylief-0.9.0.dev.zip

  <span class="c1"># install python-magic</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install python-magic

  <span class="c1"># Install Crypt_GPG and Console_CommandLine</span>
  sudo pear install <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/dependencies/Console_CommandLine/package.xml
  sudo pear install <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/dependencies/Crypt_GPG/package.xml
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 1_mispCoreInstall.sh&gt;</span>
</pre></div>

<h3 id="4-cakephp">4/ CakePHP<a class="headerlink" href="#4-cakephp" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 1_installCake.sh&gt;</span>
installCake <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing CakePHP&quot;</span>
  <span class="c1"># Once done, install CakeResque along with its dependencies </span>
  <span class="c1"># if you intend to use the built in background jobs:</span>
  <span class="nb">cd</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app
  <span class="c1"># Make composer cache happy</span>
  <span class="c1"># /!\ composer on Ubuntu when invoked with sudo -u doesn&#39;t set $HOME to /var/www but keeps it /home/misp \!/</span>
  sudo mkdir /var/www/.composer <span class="p">;</span> sudo chown www-data:www-data /var/www/.composer
  sudo -H -u www-data php composer.phar require kamisama/cake-resque:4.1.2
  sudo -H -u www-data php composer.phar config vendor-dir Vendor
  sudo -H -u www-data php composer.phar install

  <span class="c1"># Enable CakeResque with php-redis</span>
  sudo phpenmod redis
  sudo phpenmod gnupg

  <span class="c1"># To use the scheduler worker for scheduled tasks, do the following:</span>
  sudo -u www-data cp -fa <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/setup/config.php <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Plugin/CakeResque/Config/config.php

  <span class="c1"># If you have multiple MISP instances on the same system, don&#39;t forget to have a different Redis per MISP instance for the CakeResque workers</span>
  <span class="c1"># The default Redis port can be updated in Plugin/CakeResque/Config/config.php</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 1_installCake.sh&gt;</span>
</pre></div>

<h3 id="5-set-the-permissions">5/ Set the permissions<a class="headerlink" href="#5-set-the-permissions" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_permissions.sh&gt;</span>
<span class="c1"># Main function to fix permissions to something sane</span>
permissions <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting permissions&quot;</span>
  sudo chown -R <span class="si">${</span><span class="nv">WWW_USER</span><span class="si">}</span>:<span class="si">${</span><span class="nv">WWW_USER</span><span class="si">}</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  sudo chmod -R <span class="m">750</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>
  sudo chmod -R g+ws <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/tmp
  sudo chmod -R g+ws <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/files
  sudo chmod -R g+ws <span class="nv">$PATH_TO_MISP</span>/app/files/scripts/tmp
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_permissions.sh&gt;</span>
</pre></div>

<h3 id="6-create-a-database-and-user">6/ Create a database and user<a class="headerlink" href="#6-create-a-database-and-user" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="set-up-db-user-and-import-empty-misp-db">Set-up DB, User and import empty MISP DB<a class="headerlink" href="#set-up-db-user-and-import-empty-misp-db" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 1_prepareDB.sh&gt;</span>
prepareDB <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting up database&quot;</span>
  <span class="c1"># Add your credentials if needed, if sudo has NOPASS, comment out the relevant lines</span>
  <span class="nv">pw</span><span class="o">=</span><span class="nv">$MISP_PASSWORD</span>

  expect -f - <span class="s">&lt;&lt;-EOF</span>
<span class="s">    set timeout 10</span>

<span class="s">    spawn sudo -k mysql_secure_installation</span>
<span class="s">    expect &quot;*?assword*&quot;</span>
<span class="s">    send -- &quot;$pw\r&quot;</span>
<span class="s">    expect &quot;Enter current password for root (enter for none):&quot;</span>
<span class="s">    send -- &quot;\r&quot;</span>
<span class="s">    expect &quot;Set root password?&quot;</span>
<span class="s">    send -- &quot;y\r&quot;</span>
<span class="s">    expect &quot;New password:&quot;</span>
<span class="s">    send -- &quot;${DBPASSWORD_ADMIN}\r&quot;</span>
<span class="s">    expect &quot;Re-enter new password:&quot;</span>
<span class="s">    send -- &quot;${DBPASSWORD_ADMIN}\r&quot;</span>
<span class="s">    expect &quot;Remove anonymous users?&quot;</span>
<span class="s">    send -- &quot;y\r&quot;</span>
<span class="s">    expect &quot;Disallow root login remotely?&quot;</span>
<span class="s">    send -- &quot;y\r&quot;</span>
<span class="s">    expect &quot;Remove test database and access to it?&quot;</span>
<span class="s">    send -- &quot;y\r&quot;</span>
<span class="s">    expect &quot;Reload privilege tables now?&quot;</span>
<span class="s">    send -- &quot;y\r&quot;</span>
<span class="s">    expect eof</span>
<span class="s">EOF</span>
  sudo apt-get purge -y expect <span class="p">;</span> sudo apt autoremove -qy

  sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;create database </span><span class="nv">$DBNAME</span><span class="s2">;&quot;</span>
  sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;grant usage on *.* to </span><span class="nv">$DBNAME</span><span class="s2">@localhost identified by &#39;</span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&#39;;&quot;</span>
  sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;grant all privileges on </span><span class="nv">$DBNAME</span><span class="s2">.* to &#39;</span><span class="nv">$DBUSER_MISP</span><span class="s2">&#39;@&#39;localhost&#39;;&quot;</span>
  sudo mysql -u <span class="nv">$DBUSER_ADMIN</span> -p<span class="nv">$DBPASSWORD_ADMIN</span> -e <span class="s2">&quot;flush privileges;&quot;</span>
  <span class="c1"># Import the empty MISP database from MYSQL.sql</span>
  sudo -u www-data cat <span class="nv">$PATH_TO_MISP</span>/INSTALL/MYSQL.sql <span class="p">|</span> mysql -u <span class="nv">$DBUSER_MISP</span> -p<span class="nv">$DBPASSWORD_MISP</span> <span class="nv">$DBNAME</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 1_prepareDB.sh&gt;</span>
</pre></div>

<h3 id="7-apache-configuration">7/ Apache configuration<a class="headerlink" href="#7-apache-configuration" title="Permanent link">&para;</a></h3>
<hr />
<p>Now configure your Apache webserver with the DocumentRoot ${PATH_TO_MISP}/app/webroot/</p>
<h4 id="apache-version-24-config">Apache version 2.4 config:<a class="headerlink" href="#apache-version-24-config" title="Permanent link">&para;</a></h4>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Be aware that the configuration files for apache 2.4 and up have changed.
The configuration file has to have the .conf extension in the sites-available directory
For more information, visit <a href="http://httpd.apache.org/docs/2.4/upgrading.html">http://httpd.apache.org/docs/2.4/upgrading.html</a></p>
</div>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 1_apacheConfig.sh&gt;</span>
apacheConfig <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Generating Apache config&quot;</span>
  sudo cp <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/apache.24.misp.ssl /etc/apache2/sites-available/misp-ssl.conf

  <span class="c1"># If a valid SSL certificate is not already created for the server,</span>
  <span class="c1"># create a self-signed certificate:</span>
  sudo openssl req -newkey rsa:4096 -days <span class="m">365</span> -nodes -x509 <span class="se">\</span>
  -subj <span class="s2">&quot;/C=</span><span class="si">${</span><span class="nv">OPENSSL_C</span><span class="si">}</span><span class="s2">/ST=</span><span class="si">${</span><span class="nv">OPENSSL_ST</span><span class="si">}</span><span class="s2">/L=</span><span class="si">${</span><span class="nv">OPENSSL_L</span><span class="si">}</span><span class="s2">/O=</span><span class="si">${</span><span class="nv">OPENSSL_O</span><span class="si">}</span><span class="s2">/OU=</span><span class="si">${</span><span class="nv">OPENSSL_OU</span><span class="si">}</span><span class="s2">/CN=</span><span class="si">${</span><span class="nv">OPENSSL_CN</span><span class="si">}</span><span class="s2">/emailAddress=</span><span class="si">${</span><span class="nv">OPENSSL_EMAILADDRESS</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
  -keyout /etc/ssl/private/misp.local.key -out /etc/ssl/private/misp.local.crt

  <span class="c1"># Enable modules, settings, and default of SSL in Apache</span>
  sudo a2dismod status
  sudo a2enmod ssl
  sudo a2enmod rewrite
  sudo a2enmod headers
  sudo a2dissite <span class="m">000</span>-default
  sudo a2ensite default-ssl

  <span class="c1"># Apply all changes</span>
  sudo systemctl restart apache2
  <span class="c1"># activate new vhost</span>
  sudo a2dissite default-ssl
  sudo a2ensite misp-ssl

  <span class="c1"># Restart apache</span>
  sudo systemctl restart apache2
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 1_apacheConfig.sh&gt;</span>
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Please find a sample conf file for an SSL enabled conf file in-line below (alternatively use one of the samples provided in /var/www/MISP/INSTALL).<br />
Also remember to verify the SSLCertificateChainFile property in your config file.<br />
This is usually commented out for the self-generated certificate in the sample configurations, such as the one pasted below.<br />
Otherwise, copy the SSLCertificateFile, SSLCertificateKeyFile, and SSLCertificateChainFile to /etc/ssl/private/. (Modify path and config to fit your environment)</p>
</div>
<div class="codehilite"><pre><span></span>============================================= Begin sample working SSL config for MISP
&lt;VirtualHost &lt;IP, FQDN, or *&gt;:80&gt;
        ServerName &lt;your.FQDN.here&gt;

        Redirect permanent / https://&lt;your.FQDN.here&gt;

        LogLevel warn
        ErrorLog /var/log/apache2/misp.local_error.log
        CustomLog /var/log/apache2/misp.local_access.log combined
        ServerSignature Off
&lt;/VirtualHost&gt;

&lt;VirtualHost &lt;IP, FQDN, or *&gt;:443&gt;
        ServerAdmin admin@&lt;your.FQDN.here&gt;
        ServerName &lt;your.FQDN.here&gt;
        DocumentRoot /var/www/MISP/app/webroot
        &lt;Directory /var/www/MISP/app/webroot&gt;
                Options -Indexes
                AllowOverride all
                Order allow,deny
                allow from all
        &lt;/Directory&gt;

        SSLEngine On
        SSLCertificateFile /etc/ssl/private/misp.local.crt
        SSLCertificateKeyFile /etc/ssl/private/misp.local.key
#        SSLCertificateChainFile /etc/ssl/private/misp-chain.crt

        LogLevel warn
        ErrorLog /var/log/apache2/misp.local_error.log
        CustomLog /var/log/apache2/misp.local_access.log combined
        ServerSignature Off
&lt;/VirtualHost&gt;
============================================= End sample working SSL config for MISP
</pre></div>

<h3 id="8-log-rotation">8/ Log rotation<a class="headerlink" href="#8-log-rotation" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_logRotation.sh&gt;</span>
logRotation <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># MISP saves the stdout and stderr of its workers in ${PATH_TO_MISP}/app/tmp/logs</span>
  <span class="c1"># To rotate these logs install the supplied logrotate script:</span>
  sudo cp <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/INSTALL/misp.logrotate /etc/logrotate.d/misp
  sudo chmod <span class="m">0640</span> /etc/logrotate.d/misp
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_logRotation.sh&gt;</span>
</pre></div>

<h3 id="9-misp-configuration">9/ MISP configuration<a class="headerlink" href="#9-misp-configuration" title="Permanent link">&para;</a></h3>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_configMISP.sh&gt;</span>
configMISP <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Generating </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> config files&quot;</span>
  <span class="c1"># There are 4 sample configuration files in ${PATH_TO_MISP}/app/Config that need to be copied</span>
  sudo -u www-data cp -a <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/bootstrap.default.php <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/bootstrap.php
  sudo -u www-data cp -a <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/database.default.php <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/database.php
  sudo -u www-data cp -a <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/core.default.php <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/core.php
  sudo -u www-data cp -a <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/config.default.php <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config/config.php

  <span class="nb">echo</span> <span class="s2">&quot;&lt;?php</span>
<span class="s2">  class DATABASE_CONFIG {</span>
<span class="s2">          public \$default = array(</span>
<span class="s2">                  &#39;datasource&#39; =&gt; &#39;Database/Mysql&#39;,</span>
<span class="s2">                  //&#39;datasource&#39; =&gt; &#39;Database/Postgres&#39;,</span>
<span class="s2">                  &#39;persistent&#39; =&gt; false,</span>
<span class="s2">                  &#39;host&#39; =&gt; &#39;</span><span class="nv">$DBHOST</span><span class="s2">&#39;,</span>
<span class="s2">                  &#39;login&#39; =&gt; &#39;</span><span class="nv">$DBUSER_MISP</span><span class="s2">&#39;,</span>
<span class="s2">                  &#39;port&#39; =&gt; 3306, // MySQL &amp; MariaDB</span>
<span class="s2">                  //&#39;port&#39; =&gt; 5432, // PostgreSQL</span>
<span class="s2">                  &#39;password&#39; =&gt; &#39;</span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&#39;,</span>
<span class="s2">                  &#39;database&#39; =&gt; &#39;</span><span class="nv">$DBNAME</span><span class="s2">&#39;,</span>
<span class="s2">                  &#39;prefix&#39; =&gt; &#39;&#39;,</span>
<span class="s2">                  &#39;encoding&#39; =&gt; &#39;utf8&#39;,</span>
<span class="s2">          );</span>
<span class="s2">  }&quot;</span> <span class="p">|</span> sudo -u www-data tee <span class="nv">$PATH_TO_MISP</span>/app/Config/database.php

  <span class="c1"># Important! Change the salt key in ${PATH_TO_MISP}/app/Config/config.php</span>
  <span class="c1"># The salt key must be a string at least 32 bytes long.</span>
  <span class="c1"># The admin user account will be generated on the first login, make sure that the salt is changed before you create that user</span>
  <span class="c1"># If you forget to do this step, and you are still dealing with a fresh installation, just alter the salt,</span>
  <span class="c1"># delete the user from mysql and log in again using the default admin credentials (admin@admin.test / admin)</span>

  <span class="c1"># and make sure the file permissions are still OK</span>
  sudo chown -R www-data:www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config
  sudo chmod -R <span class="m">750</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/app/Config
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_configMISP.sh&gt;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_gnupg.sh&gt;</span>
<span class="c1"># Generate GnuPG key</span>
setupGnuPG <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$PATH_TO_MISP</span>/.gnupg <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># The email address should match the one set in the config.php</span>
    <span class="c1"># set in the configuration menu in the administration menu configuration file</span>
    <span class="nb">echo</span> <span class="s2">&quot;%echo Generating a default key</span>
<span class="s2">      Key-Type: default</span>
<span class="s2">      Key-Length: </span><span class="nv">$GPG_KEY_LENGTH</span><span class="s2"></span>
<span class="s2">      Subkey-Type: default</span>
<span class="s2">      Name-Real: </span><span class="nv">$GPG_REAL_NAME</span><span class="s2"></span>
<span class="s2">      Name-Comment: </span><span class="nv">$GPG_COMMENT</span><span class="s2"></span>
<span class="s2">      Name-Email: </span><span class="nv">$GPG_EMAIL_ADDRESS</span><span class="s2"></span>
<span class="s2">      Expire-Date: 0</span>
<span class="s2">      Passphrase: </span><span class="nv">$GPG_PASSPHRASE</span><span class="s2"></span>
<span class="s2">      # Do a commit here, so that we can later print &quot;</span><span class="k">done</span><span class="s2">&quot;</span>
<span class="s2">      %commit</span>
<span class="s2">    %echo done&quot;</span> &gt; /tmp/gen-key-script

    <span class="nv">$SUDO_WWW</span> gpg --homedir <span class="nv">$PATH_TO_MISP</span>/.gnupg --batch --gen-key /tmp/gen-key-script

    <span class="c1"># Export the public key to the webroot</span>
    <span class="nv">$SUDO_WWW</span> sh -c <span class="s2">&quot;gpg --homedir </span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg --export --armor </span><span class="nv">$GPG_EMAIL_ADDRESS</span><span class="s2">&quot;</span> <span class="p">|</span> <span class="nv">$SUDO_WWW</span> tee <span class="nv">$PATH_TO_MISP</span>/app/webroot/gpg.asc
  <span class="k">fi</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_gnupg.sh&gt;</span>
</pre></div>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If entropy is not high enough, you can install havegd and then start the service
<div class="codehilite"><pre><span></span>sudo apt install haveged -qy
sudo service haveged start
</pre></div></p>
</div>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_backgroundWorkers.sh&gt;</span>
backgroundWorkers <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting up background workers&quot;</span>
  <span class="c1"># To make the background workers start on boot</span>
  sudo chmod +x <span class="nv">$PATH_TO_MISP</span>/app/Console/worker/start.sh
  <span class="k">if</span> <span class="o">[</span> ! -e /etc/rc.local <span class="o">]</span>
  <span class="k">then</span>
      <span class="nb">echo</span> <span class="s1">&#39;#!/bin/sh -e&#39;</span> <span class="p">|</span> sudo tee -a /etc/rc.local
      <span class="nb">echo</span> <span class="s1">&#39;exit 0&#39;</span> <span class="p">|</span> sudo tee -a /etc/rc.local
      sudo chmod u+x /etc/rc.local
  <span class="k">fi</span>

  <span class="c1"># Start the workers</span>
  <span class="nv">$SUDO_WWW</span> bash <span class="nv">$PATH_TO_MISP</span>/app/Console/worker/start.sh

  <span class="c1"># Add the following lines before the last line (exit 0). Make sure that you replace www-data with your apache user:</span>
  sudo sed -i -e <span class="s1">&#39;$i \echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled\n&#39;</span> /etc/rc.local
  sudo sed -i -e <span class="s1">&#39;$i \echo 1024 &gt; /proc/sys/net/core/somaxconn\n&#39;</span> /etc/rc.local
  sudo sed -i -e <span class="s1">&#39;$i \sysctl vm.overcommit_memory=1\n&#39;</span> /etc/rc.local
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u www-data bash ${PATH_TO_MISP}/app/Console/worker/start.sh &gt; /tmp/worker_start_rc.local.log\n&#39;</span> /etc/rc.local
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_backgroundWorkers.sh&gt;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;Admin (root) DB Password: </span><span class="nv">$DBPASSWORD_ADMIN</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;User  (misp) DB Password: </span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&quot;</span>
</pre></div>

<h4 id="initialize-misp-configuration-and-set-some-defaults">Initialize MISP configuration and set some defaults<a class="headerlink" href="#initialize-misp-configuration-and-set-some-defaults" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 2_core-cake.sh&gt;</span>
<span class="c1"># Core cake commands</span>
coreCAKE <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Running core Cake commands to set sane defaults for </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nv">$SUDO_WWW</span> -E <span class="nv">$CAKE</span> userInit -q

  <span class="c1"># This makes sure all Database upgrades are done, without logging in.</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin updateDatabase

  <span class="c1"># Setup some more MISP default via cake CLI</span>

  <span class="c1"># The default install is Python in a virtualenv, setting accordingly</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.python_bin&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span><span class="s2">/venv/bin/python&quot;</span>

  <span class="c1"># Tune global time outs</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.autoRegenerate&quot;</span> <span class="m">0</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.timeout&quot;</span> <span class="m">600</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Session.cookieTimeout&quot;</span> <span class="m">3600</span>

  <span class="c1"># Change base url, either with this CLI command or in the UI</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Baseurl <span class="nv">$MISP_BASEURL</span>
  <span class="c1"># example: &#39;baseurl&#39; =&gt; &#39;https://&lt;your.FQDN.here&gt;&#39;,</span>
  <span class="c1"># alternatively, you can leave this field empty if you would like to use relative pathing in MISP</span>
  <span class="c1"># &#39;baseurl&#39; =&gt; &#39;&#39;,</span>

  <span class="c1"># Enable GnuPG</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.email&quot;</span> <span class="s2">&quot;</span><span class="nv">$GPG_EMAIL_ADDRESS</span><span class="s2">&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.homedir&quot;</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;GnuPG.password&quot;</span> <span class="s2">&quot;</span><span class="nv">$GPG_PASSPHRASE</span><span class="s2">&quot;</span>

  <span class="c1"># Enable installer org and tune some configurables</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.host_org_id&quot;</span> <span class="m">1</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.email&quot;</span> <span class="s2">&quot;info@admin.test&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disable_emailing&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.contact&quot;</span> <span class="s2">&quot;info@admin.test&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disablerestalert&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.showCorrelationsOnIndex&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.default_event_tag_collection&quot;</span> <span class="m">0</span>

  <span class="c1"># Provisional Cortex tunes</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_enable&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_services_port&quot;</span> <span class="m">9000</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_timeout&quot;</span> <span class="m">120</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_authkey&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="c1"># Mysteriously removed?</span>
  <span class="c1">#$SUDO_WWW $CAKE Admin setSetting &quot;Plugin.Cortex_services_timeout&quot; 120</span>
  <span class="c1"># Mysteriously removed?</span>
  <span class="c1">#$SUDO_WWW $CAKE Admin setSetting &quot;Plugin.Cortex_services_authkey&quot; &quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_verify_peer&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_verify_host&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Cortex_ssl_allow_self_signed&quot;</span> <span class="nb">true</span>

  <span class="c1"># Various plugin sightings settings</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_policy&quot;</span> <span class="m">0</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_anonymise&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Sightings_range&quot;</span> <span class="m">365</span>

  <span class="c1"># Plugin CustomAuth tuneable</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.CustomAuth_disable_logout&quot;</span> <span class="nb">false</span>

  <span class="c1"># RPZ Plugin settings</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_policy&quot;</span> <span class="s2">&quot;DROP&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_walled_garden&quot;</span> <span class="s2">&quot;127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_serial&quot;</span> <span class="s2">&quot;\$date00&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_refresh&quot;</span> <span class="s2">&quot;2h&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_retry&quot;</span> <span class="s2">&quot;30m&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_expiry&quot;</span> <span class="s2">&quot;30d&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_minimum_ttl&quot;</span> <span class="s2">&quot;1h&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ttl&quot;</span> <span class="s2">&quot;1w&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ns&quot;</span> <span class="s2">&quot;localhost.&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_ns_alt&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.RPZ_email&quot;</span> <span class="s2">&quot;root.localhost&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less RED</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.language&quot;</span> <span class="s2">&quot;eng&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.proposals_block_attributes&quot;</span> <span class="nb">false</span>

  <span class="c1"># Redis block</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_host&quot;</span> <span class="s2">&quot;127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_port&quot;</span> <span class="m">6379</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_database&quot;</span> <span class="m">13</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.redis_password&quot;</span> <span class="s2">&quot;&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less YELLOW</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.ssdeep_correlation_threshold&quot;</span> <span class="m">40</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.extended_alert_subject&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.default_event_threat_level&quot;</span> <span class="m">4</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.newUserText&quot;</span> <span class="s2">&quot;Dear new MISP user,\\n\\nWe would hereby like to welcome you to the \$org MISP community.\\n\\n Use the credentials below to log into MISP at \$misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: \$username\\nPassword: \$password\\n\\nIf you have any questions, don&#39;t hesitate to contact us at: \$contact.\\n\\nBest regards,\\nYour \$org MISP support team&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.passwordResetText&quot;</span> <span class="s2">&quot;Dear MISP user,\\n\\nA password reset has been triggered for your account. Use the below provided temporary password to log into MISP at \$misp, where you will be prompted to manually change your password to something of your own choice.\\n\\nUsername: \$username\\nYour temporary password: \$password\\n\\nIf you have any questions, don&#39;t hesitate to contact us at: \$contact.\\n\\nBest regards,\\nYour \$org MISP support team&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.enableEventBlacklisting&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.enableOrgBlacklisting&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.log_client_ip&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.log_auth&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.disableUserSelfManagement&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_event_alert&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_event_alert_tag&quot;</span> <span class="s2">&quot;no-alerts=\&quot;true\&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_old_event_alert&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.block_old_event_alert_age&quot;</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.incoming_tags_disabled_by_default&quot;</span> <span class="nb">false</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.footermidleft&quot;</span> <span class="s2">&quot;This is an initial install&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.footermidright&quot;</span> <span class="s2">&quot;Please configure and harden accordingly&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.welcome_text_top&quot;</span> <span class="s2">&quot;Initial Install, please configure&quot;</span>
  <span class="c1"># TODO: Make sure $FLAVOUR is correct</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.welcome_text_bottom&quot;</span> <span class="s2">&quot;Welcome to MISP on </span><span class="nv">$FLAVOUR</span><span class="s2">, change this message in MISP Settings&quot;</span>

  <span class="c1"># Force defaults to make MISP Server Settings less GREEN</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Security.password_policy_length&quot;</span> <span class="m">12</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Security.password_policy_complexity&quot;</span> <span class="s1">&#39;/^((?=.*\d)|(?=.*\W+))(?![\n])(?=.*[A-Z])(?=.*[a-z]).*$|.{16,}/&#39;</span>

  <span class="c1"># Set MISP Live</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Live <span class="nv">$MISP_LIVE</span>
<span class="o">}</span>

<span class="c1"># This updates Galaxies, ObjectTemplates, Warninglists, Noticelists, Templates</span>
updateGOWNT <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Updating Galaxies, ObjectTemplates, Warninglists, Noticelists and Templates&quot;</span>
  <span class="nv">AUTH_KEY</span><span class="o">=</span><span class="k">$(</span>mysql -u <span class="nv">$DBUSER_MISP</span> -p<span class="nv">$DBPASSWORD_MISP</span> misp -e <span class="s2">&quot;SELECT authkey FROM users;&quot;</span> <span class="p">|</span> tail -1<span class="k">)</span>

  <span class="c1"># Update the galaxies</span>
  <span class="c1"># TODO: Fix updateGalaxies</span>
  <span class="c1">##$SUDO_WWW $CAKE Admin updateGalaxies</span>
  curl --header <span class="s2">&quot;Authorization: </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> --header <span class="s2">&quot;Accept: application/json&quot;</span> --header <span class="s2">&quot;Content-Type: application/json&quot;</span> -k -X POST https://127.0.0.1/galaxies/update
  <span class="c1"># Updating the taxonomies</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin updateTaxonomies
  <span class="c1"># Updating the warning lists</span>
  <span class="c1"># TODO: Fix updateWarningLists</span>
  <span class="c1">##$SUDO_WWW $CAKE Admin updateWarningLists</span>
  curl --header <span class="s2">&quot;Authorization: </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> --header <span class="s2">&quot;Accept: application/json&quot;</span> --header <span class="s2">&quot;Content-Type: application/json&quot;</span> -k -X POST https://127.0.0.1/warninglists/update
  <span class="c1"># Updating the notice lists</span>
  <span class="c1">## $SUDO_WWW $CAKE Admin updateNoticeLists</span>
  curl --header <span class="s2">&quot;Authorization: </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> --header <span class="s2">&quot;Accept: application/json&quot;</span> --header <span class="s2">&quot;Content-Type: application/json&quot;</span> -k -X POST https://127.0.0.1/noticelists/update
  <span class="c1"># Updating the object templates</span>
  <span class="c1">##$SUDO_WWW $CAKE Admin updateObjectTemplates</span>
  curl --header <span class="s2">&quot;Authorization: </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> --header <span class="s2">&quot;Accept: application/json&quot;</span> --header <span class="s2">&quot;Content-Type: application/json&quot;</span> -k -X POST https://127.0.0.1/objectTemplates/update
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 2_core-cake.sh&gt;</span>
</pre></div>

<h4 id="install-misp-modules-optional">Install misp-modules (optional)<a class="headerlink" href="#install-misp-modules-optional" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 3_misp-modules.sh&gt;</span>
<span class="c1"># Main MISP Modules install function</span>
mispmodules <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># FIXME:  this is broken, ${PATH_TO_MISP} is litteral</span>
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u www-data /var/www/MISP/venv/bin/misp-modules -l 127.0.0.1 -s &gt; /tmp/misp-modules_rc.local.log &amp;\n&#39;</span> /etc/rc.local
  <span class="nb">cd</span> /usr/local/src/
  <span class="c1">## TODO: checkUsrLocalSrc in main doc</span>
  <span class="nv">$SUDO_USER</span> git clone https://github.com/MISP/misp-modules.git
  <span class="nb">cd</span> misp-modules
  <span class="c1"># some misp-modules dependencies</span>
  sudo apt-get install libpq5 libjpeg-dev libfuzzy-dev -y
  <span class="c1"># If you build an egg, the user you build it as need write permissions in the CWD</span>
  sudo chgrp <span class="nv">$WWW_USER</span> .
  sudo chmod g+w .
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -I -r REQUIREMENTS
  sudo chgrp staff .
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install -I .
  sudo apt install ruby-pygments.rb -y
  sudo gem install asciidoctor-pdf --pre

  <span class="c1"># install additional dependencies for extended object generation and extraction</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install wand yara pathlib
  <span class="c1"># Start misp-modules</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/misp-modules -l <span class="m">127</span>.0.0.1 -s <span class="p">&amp;</span>

  <span class="c1"># Sleep 9 seconds to give misp-modules a chance to spawn</span>
  sleep <span class="m">9</span>

  <span class="c1"># Enable Enrichment, set better timeouts</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_hover_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_hover_timeout&quot;</span> <span class="m">150</span>
  <span class="c1"># TODO:&quot;Investigate why the next one fails&quot;</span>
  <span class="c1">#$SUDO_WWW $CAKE Admin setSetting &quot;Plugin.Enrichment_asn_history_enabled&quot; true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_cve_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_dns_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Enrichment_services_port&quot;</span> <span class="m">6666</span>

  <span class="c1"># Enable Import modules, set better timeout</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_services_port&quot;</span> <span class="m">6666</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_ocr_enabled&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Import_csvimport_enabled&quot;</span> <span class="nb">true</span>

  <span class="c1"># Enable Export modules, set better timeout</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_enable&quot;</span> <span class="nb">true</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_url&quot;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_services_port&quot;</span> <span class="m">6666</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_timeout&quot;</span> <span class="m">300</span>
  <span class="nv">$SUDO_WWW</span> <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.Export_pdfexport_enabled&quot;</span> <span class="nb">true</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 3_misp-modules.sh&gt;</span>
</pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you have installed the recommended Python 3 virtualenv to the recommended place of <strong>${PATH_TO_MISP}/venv</strong> set the following MISP configurable
<div class="codehilite"><pre><span></span>sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;MISP.python_bin&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span><span class="s2">/venv/bin/python&quot;</span>
</pre></div>
or on CentOS
<div class="codehilite"><pre><span></span>sudo <span class="nv">$RUN_PHP</span> <span class="s2">&quot;</span><span class="nv">$CAKE</span><span class="s2"> Admin setSetting &quot;</span>MISP.python_bin<span class="s2">&quot; &quot;</span><span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/python<span class="s2">&quot;&quot;</span>
</pre></div></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure that the STIX libraries and GnuPG work as intended, if not, refer to the relevant sections in the install guide you are currently reading.</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>Now log in using the webinterface: http://misp/users/login<br />
The default user/pass = <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#100;&#109;&#105;&#110;&#64;&#97;&#100;&#109;&#105;&#110;&#46;&#116;&#101;&#115;&#116;">&#97;&#100;&#109;&#105;&#110;&#64;&#97;&#100;&#109;&#105;&#110;&#46;&#116;&#101;&#115;&#116;</a>/admin<br />
Using the server settings tool in the admin interface (Administration -&gt; Server Settings), set MISP up to your preference.<br />
It is especially vital that no critical issues remain!<br />
Don't forget to change the email, password and authentication key after installation.<br />
Once done, have a look at the diagnostics.</p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If any of the directories that MISP uses to store files is not writeable to the apache user, change the permissions<br />
you can do this by running the following commands:
<div class="codehilite"><pre><span></span>chmod -R <span class="m">750</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/&lt;directory path with an indicated issue&gt;
<span class="c1"># /!\ Depending on your OS replace www-data with apache or www or whatever user is the web server user.</span>
chown -R www-data:www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/&lt;directory path with an indicated issue&gt;
</pre></div></p>
</div>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If anything goes wrong, make sure that you check MISP's logs for errors:
<div class="codehilite"><pre><span></span># ${PATH_TO_MISP}/app/tmp/logs/error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-worker-error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-scheduler-error.log
# ${PATH_TO_MISP}/app/tmp/logs/resque-2018-10-25.log //where the actual date is the current date
</pre></div></p>
</div>
<h3 id="recommended-actions">Recommended actions<a class="headerlink" href="#recommended-actions" title="Permanent link">&para;</a></h3>
<hr />
<ul>
<li>
<p>By default CakePHP exposes its name and version in email headers. Apply a patch to remove this behavior.</p>
</li>
<li>
<p>You should really harden your OS</p>
</li>
<li>You should really harden the configuration of Apache</li>
<li>You should really harden the configuration of MySQL</li>
<li>Keep your software up2date (MISP, CakePHP and everything else)</li>
<li>Log and audit</li>
</ul>
<h3 id="optional-features">Optional features<a class="headerlink" href="#optional-features" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-command">MISP has a new pub/sub feature, using ZeroMQ. To enable it, simply run the following command<a class="headerlink" href="#misp-has-a-new-pubsub-feature-using-zeromq-to-enable-it-simply-run-the-following-command" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sudo -H -u www-data <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install pyzmq
</pre></div>

<h4 id="misp-dashboard">MISP Dashboard<a class="headerlink" href="#misp-dashboard" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 4_misp-dashboard.sh&gt;</span>
<span class="c1"># Main MISP Dashboard install function</span>
mispDashboard <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Install misp-dashboard&quot;</span>
  <span class="c1"># Install pyzmq to main MISP venv</span>
  debug <span class="s2">&quot;Installing PyZMQ&quot;</span>
  <span class="nv">$SUDO_WWW</span> <span class="si">${</span><span class="nv">PATH_TO_MISP</span><span class="si">}</span>/venv/bin/pip install pyzmq
  <span class="nb">cd</span> /var/www
  sudo mkdir misp-dashboard
  sudo chown www-data:www-data misp-dashboard

  <span class="nv">$SUDO_WWW</span> git clone https://github.com/MISP/misp-dashboard.git
  <span class="nb">cd</span> misp-dashboard
  sudo -H /var/www/misp-dashboard/install_dependencies.sh
  sudo sed -i <span class="s2">&quot;s/^host\ =\ localhost/host\ =\ 0.0.0.0/g&quot;</span> /var/www/misp-dashboard/config/config.cfg
  sudo sed -i <span class="s1">&#39;/Listen 80/a Listen 0.0.0.0:8001&#39;</span> /etc/apache2/ports.conf
  sudo apt install libapache2-mod-wsgi-py3 -y
  <span class="nb">echo</span> <span class="s2">&quot;&lt;VirtualHost *:8001&gt;</span>
<span class="s2">      ServerAdmin admin@misp.local</span>
<span class="s2">      ServerName misp.local</span>

<span class="s2">      DocumentRoot /var/www/misp-dashboard</span>

<span class="s2">      WSGIDaemonProcess misp-dashboard \</span>
<span class="s2">         user=misp group=misp \</span>
<span class="s2">         python-home=/var/www/misp-dashboard/DASHENV \</span>
<span class="s2">         processes=1 \</span>
<span class="s2">         threads=15 \</span>
<span class="s2">         maximum-requests=5000 \</span>
<span class="s2">         listen-backlog=100 \</span>
<span class="s2">         queue-timeout=45 \</span>
<span class="s2">         socket-timeout=60 \</span>
<span class="s2">         connect-timeout=15 \</span>
<span class="s2">         request-timeout=60 \</span>
<span class="s2">         inactivity-timeout=0 \</span>
<span class="s2">         deadlock-timeout=60 \</span>
<span class="s2">         graceful-timeout=15 \</span>
<span class="s2">         eviction-timeout=0 \</span>
<span class="s2">         shutdown-timeout=5 \</span>
<span class="s2">         send-buffer-size=0 \</span>
<span class="s2">         receive-buffer-size=0 \</span>
<span class="s2">         header-buffer-size=0 \</span>
<span class="s2">         response-buffer-size=0 \</span>
<span class="s2">         server-metrics=Off</span>

<span class="s2">      WSGIScriptAlias / /var/www/misp-dashboard/misp-dashboard.wsgi</span>

<span class="s2">      &lt;Directory /var/www/misp-dashboard&gt;</span>
<span class="s2">          WSGIProcessGroup misp-dashboard</span>
<span class="s2">          WSGIApplicationGroup %{GLOBAL}</span>
<span class="s2">          Require all granted</span>
<span class="s2">      &lt;/Directory&gt;</span>

<span class="s2">      LogLevel info</span>
<span class="s2">      ErrorLog /var/log/apache2/misp-dashboard.local_error.log</span>
<span class="s2">      CustomLog /var/log/apache2/misp-dashboard.local_access.log combined</span>
<span class="s2">      ServerSignature Off</span>
<span class="s2">  &lt;/VirtualHost&gt;&quot;</span> <span class="p">|</span> sudo tee /etc/apache2/sites-available/misp-dashboard.conf

  <span class="c1"># Enable misp-dashboard in apache and reload</span>
  sudo a2ensite misp-dashboard
  sudo systemctl restart apache2

  <span class="c1"># Needs to be started after apache2 is reloaded so the port status check works</span>
  <span class="nv">$SUDO_WWW</span> bash /var/www/misp-dashboard/start_all.sh

  <span class="c1"># Add misp-dashboard to rc.local to start on boot.</span>
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u www-data bash /var/www/misp-dashboard/start_all.sh &gt; /tmp/misp-dashboard_rc.local.log\n&#39;</span> /etc/rc.local
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 4_misp-dashboard.sh&gt;</span>

<span class="c1"># &lt;snippet-begin 4_misp-dashboard-cake.sh&gt;</span>
dashboardCAKE <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># Enable ZeroMQ for misp-dashboard</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_event_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_object_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_object_reference_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_attribute_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_sighting_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_user_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_organisation_notifications_enable&quot;</span> <span class="nb">true</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_port&quot;</span> <span class="m">50000</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_host&quot;</span> <span class="s2">&quot;localhost&quot;</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_port&quot;</span> <span class="m">6379</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_database&quot;</span> <span class="m">1</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_redis_namespace&quot;</span> <span class="s2">&quot;mispq&quot;</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_include_attachments&quot;</span> <span class="nb">false</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_tag_notifications_enable&quot;</span> <span class="nb">false</span>
  sudo -H -u www-data <span class="nv">$CAKE</span> Admin setSetting <span class="s2">&quot;Plugin.ZeroMQ_audit_notifications_enable&quot;</span> <span class="nb">false</span>
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 4_misp-dashboard-cake.sh&gt;</span>
</pre></div>

<h4 id="install-viper-framework-with-a-virtualenv">Install viper framework (with a virtualenv)<a class="headerlink" href="#install-viper-framework-with-a-virtualenv" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 6_viper.sh&gt;</span>
<span class="c1"># Main Viper install function</span>
viper <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing Viper dependencies&quot;</span>
  <span class="nb">cd</span> /usr/local/src/
  sudo apt-get install <span class="se">\</span>
    libssl-dev swig python3-ssdeep p7zip-full unrar-free sqlite python3-pyclamd exiftool radare2 <span class="se">\</span>
    python3-magic python3-sqlalchemy python3-prettytable libffi-dev libfreetype6-dev libpng-dev -qy
  <span class="nb">echo</span> <span class="s2">&quot;Cloning Viper&quot;</span>
  <span class="nv">$SUDO_USER</span> git clone https://github.com/viper-framework/viper.git
  sudo chown -R <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_USER</span> viper
  <span class="nb">cd</span> viper
  <span class="nb">echo</span> <span class="s2">&quot;Creating virtualenv&quot;</span>
  <span class="nv">$SUDO_USER</span> virtualenv -p python3 venv
  <span class="nb">echo</span> <span class="s2">&quot;Submodule update&quot;</span>
  <span class="c1"># TODO: Check for current user install permissions</span>
  <span class="nv">$SUDO_USER</span> git submodule update --init --recursive
  <span class="c1">##$SUDO git submodule update --init --recursive</span>
  <span class="nb">echo</span> <span class="s2">&quot;Pip install deps&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install SQLAlchemy PrettyTable python-magic
  <span class="nb">echo</span> <span class="s2">&quot;pip install scrapy&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install scrapy
  <span class="nb">echo</span> <span class="s2">&quot;install lief&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install https://github.com/lief-project/packages/raw/lief-master-latest/pylief-0.9.0.dev.zip
  <span class="nb">echo</span> <span class="s2">&quot;pip install reqs&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install -r requirements.txt
  <span class="nv">$SUDO_USER</span> sed -i <span class="s1">&#39;1 s/^.*$/\#!\/usr\/local\/src\/viper\/venv\/bin\/python/&#39;</span> viper-cli
  <span class="nv">$SUDO_USER</span> sed -i <span class="s1">&#39;1 s/^.*$/\#!\/usr\/local\/src\/viper\/venv\/bin\/python/&#39;</span> viper-web
  <span class="nb">echo</span> <span class="s2">&quot;pip uninstall yara&quot;</span>
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip uninstall yara -y
  <span class="nb">echo</span> <span class="s2">&quot;Launching viper-cli&quot;</span>
  <span class="c1"># TODO: Perms</span>
  <span class="c1">#$SUDO /usr/local/src/viper/viper-cli -h &gt; /dev/null</span>
  /usr/local/src/viper/viper-cli -h &gt; /dev/null
  <span class="nb">echo</span> <span class="s2">&quot;Launching viper-web&quot;</span>
  <span class="c1"># TODO: Perms</span>
  /usr/local/src/viper/viper-web -p <span class="m">8888</span> -H <span class="m">0</span>.0.0.0 <span class="p">&amp;</span>
  <span class="c1">#$SUDO /usr/local/src/viper/viper-web -p 8888 -H 0.0.0.0 &amp;</span>
  <span class="nb">echo</span> <span class="s1">&#39;PATH=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/local/src/viper:/var/www/MISP/app/Console&quot;&#39;</span> <span class="p">|</span>sudo tee /etc/environment
  <span class="nb">echo</span> <span class="s2">&quot;. /etc/environment&quot;</span> &gt;&gt; /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/.profile

  <span class="c1"># TODO: Perms, MISP_USER_HOME, nasty hack cuz Kali on R00t</span>
  <span class="k">if</span> <span class="o">[</span> -f /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/.viper/viper.conf <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">VIPER_HOME</span><span class="o">=</span><span class="s2">&quot;/home/</span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">/.viper&quot;</span>
  <span class="k">else</span>
    <span class="nv">VIPER_HOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.viper&quot;</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> <span class="s2">&quot;Setting misp_url/misp_key&quot;</span>
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_url\ =/misp_url\ =\ http:\/\/localhost/g&quot;</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/viper.conf
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_key\ =/misp_key\ =\ </span><span class="nv">$AUTH_KEY</span><span class="s2">/g&quot;</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/viper.conf
  <span class="c1"># Reset admin password to: admin/Password1234</span>
  <span class="nb">echo</span> <span class="s2">&quot;Fixing admin.db with default password&quot;</span>
  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>sqlite3 <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/admin.db <span class="s1">&#39;UPDATE auth_user SET password=&quot;pbkdf2_sha256$100000$iXgEJh8hz7Cf$vfdDAwLX8tko1t0M1TLTtGlxERkNnltUnMhbv56wK/U=&quot;&#39;</span><span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span><span class="s2">&quot;</span> -ne <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="c1"># FIXME This might lead to a race condition, the while loop is sub-par</span>
    sudo chown <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_USER</span> <span class="si">${</span><span class="nv">VIPER_HOME</span><span class="si">}</span>/admin.db
    <span class="nb">echo</span> <span class="s2">&quot;Updating viper-web admin password, giving process time to start-up, sleeping 5, 4, 3,&quot;</span>
    sleep <span class="m">6</span>
  <span class="k">done</span>

  <span class="c1"># Add viper-web to rc.local to be started on boot</span>
  sudo sed -i -e <span class="s1">&#39;$i \sudo -u misp /usr/local/src/viper/viper-web -p 8888 -H 0.0.0.0 &gt; /tmp/viper-web_rc.local.log &amp;\n&#39;</span> /etc/rc.local
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 6_viper.sh&gt;</span>
</pre></div>

<h4 id="experimental-ssdeep-correlations">Experimental ssdeep correlations<a class="headerlink" href="#experimental-ssdeep-correlations" title="Permanent link">&para;</a></h4>
<h5 id="installing-ssdeep">installing ssdeep<a class="headerlink" href="#installing-ssdeep" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 6_ssdeep.sh&gt;</span>
ssdeep <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Install ssdeep 2.14.1&quot;</span>
  <span class="nb">cd</span> /usr/local/src
  <span class="nv">$SUDO_USER</span> wget https://github.com/ssdeep-project/ssdeep/releases/download/release-2.14.1/ssdeep-2.14.1.tar.gz
  <span class="nv">$SUDO_USER</span> tar zxvf ssdeep-2.14.1.tar.gz
  <span class="nb">cd</span> ssdeep-2.14.1
  <span class="nv">$SUDO_USER</span> ./configure --datadir<span class="o">=</span>/usr --prefix<span class="o">=</span>/usr --localstatedir<span class="o">=</span>/var --sysconfdir<span class="o">=</span>/etc
  <span class="nv">$SUDO_USER</span> make
  sudo make install

  <span class="c1">#installing ssdeep_php</span>
  sudo pecl install ssdeep

  <span class="c1"># You should add &quot;extension=ssdeep.so&quot; to mods-available - Check /etc/php for your current version</span>
  <span class="nb">echo</span> <span class="s2">&quot;extension=ssdeep.so&quot;</span> <span class="p">|</span> sudo tee <span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/mods-available/ssdeep.ini
  sudo phpenmod ssdeep
  sudo service apache2 restart
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 6_ssdeep.sh&gt;</span>
</pre></div>

<h4 id="install-mail-to-misp">Install mail to misp<a class="headerlink" href="#install-mail-to-misp" title="Permanent link">&para;</a></h4>
<hr />
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 5_mail_to_misp.sh&gt;</span>
<span class="c1"># Main mail2misp install function</span>
mail2misp <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing Mail2</span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">cd</span> /usr/local/src/
  sudo apt-get install cmake libcaca-dev -y
  <span class="nv">$SUDO_USER</span> git clone https://github.com/MISP/mail_to_misp.git
  <span class="nv">$SUDO_USER</span> git clone git://github.com/stricaud/faup.git faup
  sudo chown -R <span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>:<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span> faup mail_to_misp
  <span class="nb">cd</span> faup
  <span class="c1"># TODO Check permissions</span>
  <span class="c1">##$SUDO mkdir -p build</span>
  <span class="nv">$SUDO_USER</span> mkdir -p build
  <span class="nb">cd</span> build
  <span class="nv">$SUDO_USER</span> cmake .. <span class="o">&amp;&amp;</span> <span class="nv">$SUDO_USER</span> make
  <span class="c1">##$SUDO cmake .. &amp;&amp; $SUDO make</span>
  sudo make install
  sudo ldconfig
  <span class="nb">cd</span> ../../mail_to_misp
  <span class="nv">$SUDO_USER</span> virtualenv -p python3 venv
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install https://github.com/lief-project/packages/raw/lief-master-latest/pylief-0.9.0.dev.zip
  <span class="nv">$SUDO_USER</span> ./venv/bin/pip install -r requirements.txt
  <span class="nv">$SUDO_USER</span> cp mail_to_misp_config.py-example mail_to_misp_config.py
  <span class="c1">##$SUDO cp mail_to_misp_config.py-example mail_to_misp_config.py</span>
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_url\ =\ &#39;YOUR_MISP_URL&#39;/misp_url\ =\ &#39;https:\/\/localhost&#39;/g&quot;</span> /usr/local/src/mail_to_misp/mail_to_misp_config.py
  <span class="nv">$SUDO_USER</span> sed -i <span class="s2">&quot;s/^misp_key\ =\ &#39;YOUR_KEY_HERE&#39;/misp_key\ =\ &#39;</span><span class="si">${</span><span class="nv">AUTH_KEY</span><span class="si">}</span><span class="s2">&#39;/g&quot;</span> /usr/local/src/mail_to_misp/mail_to_misp_config.py
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 5_mail_to_misp.sh&gt;</span>
</pre></div>

<h1 id="hardening-a-base-system">Hardening a base system<a class="headerlink" href="#hardening-a-base-system" title="Permanent link">&para;</a></h1>
<h2 id="intro">Intro<a class="headerlink" href="#intro" title="Permanent link">&para;</a></h2>
<p>MISP is a web-based <strong>information sharing platform</strong>, by design it is kept rather simple and hardening can be done by following the common best practices.</p>
<p>Bare in mind that neither the MISP documentation efforts or the core MISP project can give you the ultimate guide on how to harden your system.
This is not the purpose of the MISP Project but the purpose and care of those individuals and organizations deploying MISP Instances.</p>
<p>Nevertheless here is a very rough <strong>food for thoughts</strong> bulletpoint list for you to consider, and a list of some hardening ressources below.</p>
<ul>
<li>Are we using SSL by default? (Especially when syncing over the internet and exposing the API)</li>
<li>How to we access the machine remotely? Via ssh? What is the path to get there? Does a <a href="https://en.wikipedia.org/wiki/Bastion_host">bastion host</a> make sense?</li>
<li>Is the machine shared with other user accounts? Do I need to care about useri-land security due to this sharing?</li>
<li>Is the instance deployed in the "<strong>cloud</strong>"? Is it a VPS? AWS? docker? ansible? kubernetes? whateverCloudContainterMagicIsFancibleNow?</li>
<li>Do we need to encrypt the partitions where some data is stored?</li>
<li>Are we redundant in case one MISP instance might fail?</li>
<li>Is the database server and any other servers running on the machine bound to <strong>localhost</strong>? Do we need to expose because our setup is more complex?</li>
<li>Do we have enough storage? What about <a href="https://misp-project.org/MISP-sizer/">MISP and size estimation</a> anyways?</li>
<li>Do we care about BIOS updates?</li>
<li>Do we care about physical access to the servers? (Disabling USB ports etc...)</li>
<li>Is any fancy management engine  la <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">IME</a> in use?</li>
</ul>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<p><a href="https://wiki.debian.org/Hardening">Debian Wiki Hardening</a></p>
<p><a href="https://wiki.centos.org/HowTos/OS_Protection">CentOS Hardening</a></p>
<p><a href="https://www.cyberciti.biz/tips/linux-security.html">Some Linux hardening tips</a></p>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>If you want to add the misp modules functionality, follow the setup procedure described in misp-modules:<br />
<a href="https://github.com/MISP/misp-modules#how-to-install-and-start-misp-modules">https://github.com/MISP/misp-modules#how-to-install-and-start-misp-modules</a><br />
Then the enrichment, export and import modules can be enabled in MISP via the settings.</p>
</div>
<h1 id="installdebiansh">INSTALL.debian.sh<a class="headerlink" href="#installdebiansh" title="Permanent link">&para;</a></h1>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>The following section is an administrative section that is used by the "<a href="https://raw.githubusercontent.com/MISP/MISP/2.4/INSTALL/INSTALL.debian.sh">INSTALL.debian.sh</a>" script.
Please ignore.</p>
</div>
<div class="codehilite"><pre><span></span><span class="c1"># &lt;snippet-begin 0_support-functions.sh&gt;</span>
<span class="c1"># Leave empty for NO debug messages, if run with set -x or bash -x it will enable DEBUG by default</span>
<span class="nv">DEBUG</span><span class="o">=</span>

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$-</span><span class="s2">&quot;</span> in
  *x*<span class="o">)</span>  <span class="nv">NO_PROGRESS</span><span class="o">=</span><span class="m">1</span><span class="p">;</span> <span class="nv">DEBUG</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
  *<span class="o">)</span>    <span class="nv">NO_PROGRESS</span><span class="o">=</span><span class="m">0</span> <span class="p">;;</span>
<span class="k">esac</span>

<span class="c1">## Function Section ##</span>

<span class="c1">## Usage of this script</span>
usage <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;bash&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WEB_INSTALL</span><span class="o">=</span><span class="m">1</span>
    <span class="nv">SCRIPT_NAME</span><span class="o">=</span><span class="s2">&quot;Web Installer Command&quot;</span>
  <span class="k">else</span>
    <span class="nv">SCRIPT_NAME</span><span class="o">=</span><span class="nv">$0</span>
  <span class="k">fi</span>

  <span class="nb">exec</span> <span class="p">&amp;</span>&gt; /dev/tty
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;Please specify what type of </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> setup you want to install.&quot;</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> -c | Install ONLY </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> Core&quot;</span>                   <span class="c1"># core</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -M | </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> modules&quot;</span>        <span class="c1"># modules</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -D | </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> dashboard&quot;</span>      <span class="c1"># dashboard</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -V | Viper&quot;</span>                            <span class="c1"># viper</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -m | Mail 2 </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>         <span class="c1"># mail2</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -S | Experimental ssdeep correlations&quot;</span> <span class="c1"># ssdeep</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;                -A | Install </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">all</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> of the above&quot;</span> <span class="c1"># all</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;                -C | Only do </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">pre-install checks and exit</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># pre</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;                -u | Do an unattanded Install, no questions asked&quot;</span>      <span class="c1"># UNATTENDED</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HIDDEN</span><span class="si">}</span><span class="s2">       -U | Attempt and upgrade of selected item</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>         <span class="c1"># UPGRADE</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HIDDEN</span><span class="si">}</span><span class="s2">Some parameters want to be hidden: </span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HIDDEN</span><span class="si">}</span><span class="s2">       -f | Force test install on current Ubuntu LTS schim, add -B for 18.04 -&gt; 18.10, or -BB 18.10 -&gt; 19.10)</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># FORCE</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;Options can be combined: </span><span class="si">${</span><span class="nv">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> -c -V -D # Will install Core+Viper+Dashboard&quot;</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;Recommended is either a barebone MISP install (ideal for syncing from other instances) or&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;MISP + modules - </span><span class="si">${</span><span class="nv">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> -c -M&quot;</span>
  space
<span class="o">}</span>

<span class="c1"># Check if element is contained in array</span>
containsElement <span class="o">()</span> <span class="o">{</span>
  <span class="nb">local</span> e <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">shift</span>
  <span class="k">for</span> e<span class="p">;</span> <span class="k">do</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$match</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">0</span><span class="p">;</span> <span class="k">done</span>
  <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

checkOpt <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># checkOpt feature</span>
  containsElement <span class="nv">$1</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">options</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

setOpt <span class="o">()</span> <span class="o">{</span>
  <span class="nv">options</span><span class="o">=()</span>
  <span class="k">for</span> o in <span class="nv">$@</span><span class="p">;</span> <span class="k">do</span> 
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$o</span><span class="s2">&quot;</span> in
      <span class="o">(</span><span class="s2">&quot;-c&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;core&quot;</span><span class="p">;</span> <span class="nv">CORE</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-V&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;viper&quot;</span><span class="p">;</span> <span class="nv">VIPER</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-M&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;modules&quot;</span><span class="p">;</span> <span class="nv">MODULES</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-D&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">;</span> <span class="nv">DASHBOARD</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-m&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;mail2&quot;</span><span class="p">;</span> <span class="nv">MAIL2</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-S&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;ssdeep&quot;</span><span class="p">;</span> <span class="nv">SSDEEP</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-A&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;all&quot;</span><span class="p">;</span> <span class="nv">ALL</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-C&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;pre&quot;</span><span class="p">;</span> <span class="nv">PRE</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-U&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span> <span class="nv">UPGRADE</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-u&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;unattended&quot;</span><span class="p">;</span> <span class="nv">UNATTENDED</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span><span class="s2">&quot;-f&quot;</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;force&quot;</span><span class="p">;</span> <span class="nv">FORCE</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      <span class="o">(</span>*<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$o</span><span class="s2"> is not a valid argument&quot;</span><span class="p">;</span> <span class="nb">exit</span> <span class="m">1</span> <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="c1"># Extract debian flavour</span>
checkFlavour <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="k">$(</span>which lsb_release<span class="k">)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    checkAptLock
    sudo apt install lsb-release dialog -y
  <span class="k">fi</span>

  <span class="nv">FLAVOUR</span><span class="o">=</span><span class="k">$(</span>lsb_release -s -i <span class="p">|</span>tr <span class="o">[</span>A-Z<span class="o">]</span> <span class="o">[</span>a-z<span class="o">]</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">FLAVOUR</span> <span class="o">==</span> <span class="s2">&quot;ubuntu&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">RELEASE</span><span class="o">=</span><span class="k">$(</span>lsb_release -s -r<span class="k">)</span>
    debug <span class="s2">&quot;We detected the following Linux flavour: </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="k">$(</span>tr <span class="s1">&#39;[:lower:]&#39;</span> <span class="s1">&#39;[:upper:]&#39;</span> <span class="o">&lt;&lt;&lt;</span> <span class="si">${</span><span class="nv">FLAVOUR</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span><span class="si">${</span><span class="nv">FLAVOUR</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">RELEASE</span><span class="si">}${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    debug <span class="s2">&quot;We detected the following Linux flavour: </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="k">$(</span>tr <span class="s1">&#39;[:lower:]&#39;</span> <span class="s1">&#39;[:upper:]&#39;</span> <span class="o">&lt;&lt;&lt;</span> <span class="si">${</span><span class="nv">FLAVOUR</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span><span class="si">${</span><span class="nv">FLAVOUR</span><span class="p">:</span><span class="nv">1</span><span class="si">}${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Extract manufacturer</span>
checkManufacturer <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="k">$(</span>which dmidecode<span class="k">)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    checkAptLock
    sudo apt install dmidecode -qy
  <span class="k">fi</span>
  <span class="nv">MANUFACTURER</span><span class="o">=</span><span class="k">$(</span>sudo dmidecode -s system-manufacturer<span class="k">)</span>
  <span class="nb">echo</span> <span class="nv">$MANUFACTURER</span>
<span class="o">}</span>

<span class="c1"># Dynamic horizontal spacer</span>
space <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$NO_PROGRESS</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="c1"># Check terminal width</span>
  <span class="nv">num</span><span class="o">=</span><span class="sb">`</span>tput cols<span class="sb">`</span>
  <span class="k">for</span> i in <span class="sb">`</span>seq <span class="m">1</span> <span class="nv">$num</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;-&quot;</span>
  <span class="k">done</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="o">}</span>

<span class="c1"># Spinner so the user knows something is happening</span>
spin<span class="o">()</span>
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$NO_PROGRESS</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nv">spinner</span><span class="o">=</span><span class="s2">&quot;/|\\-/|\\-&quot;</span>
  <span class="k">while</span> :
  <span class="k">do</span>
    <span class="k">for</span> i in <span class="sb">`</span>seq <span class="m">0</span> <span class="m">7</span><span class="sb">`</span>
    <span class="k">do</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">spinner</span><span class="p">:</span><span class="nv">$i</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="nb">echo</span> -en <span class="s2">&quot;\010&quot;</span>
      sleep <span class="m">0</span>.<span class="nv">$i</span>
    <span class="k">done</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="c1"># Progress bar</span>
progress <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$NO_PROGRESS</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nv">bar</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$progress</span> -ge <span class="m">100</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;#####################################################################################################  (100%)\r&quot;</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nv">progress</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$progress</span>+<span class="nv">$1</span><span class="o">]</span>
  <span class="k">for</span> p in <span class="k">$(</span>seq <span class="m">1</span> <span class="nv">$progress</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">bar</span><span class="o">+=</span><span class="s2">&quot;#&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;</span><span class="nv">$bar</span><span class="s2">  (</span><span class="nv">$p</span><span class="s2">%)\r&quot;</span>
  <span class="k">done</span>
  <span class="nb">echo</span> -ne <span class="s1">&#39;\n&#39;</span>
<span class="o">}</span>

<span class="c1"># Check locale</span>
checkLocale <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Checking Locale&quot;</span>
  <span class="c1"># If locale is missing, generate and install a common UTF-8</span>
  <span class="k">if</span> <span class="o">[</span> ! -f /etc/default/locale <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    checkAptLock
    sudo apt install locales -y
    sudo locale-gen en_US.UTF-8
    sudo update-locale <span class="nv">LC_ALL</span><span class="o">=</span>en_US.UTF-8 <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Simple function to check command exit code</span>
checkFail <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$2</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;iAmError: </span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The last command exited with error code: </span><span class="nv">$2</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="nv">$2</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Check if misp user is present and if run as root</span>
checkID <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Checking if run as root and </span><span class="nv">$MISP_USER</span><span class="s2"> is present&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;This script cannot be run as a root&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="k">$(</span>id <span class="nv">$MISP_USER</span> &gt;/dev/null<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$UNATTENDED</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> 
      <span class="nb">echo</span> <span class="s2">&quot;There is NO user called &#39;</span><span class="nv">$MISP_USER</span><span class="s2">&#39; create a user &#39;</span><span class="nv">$MISP_USER</span><span class="s2">&#39; or continue as </span><span class="nv">$USER</span><span class="s2">? (y/n) &quot;</span>
      <span class="nb">read</span> ANSWER
      <span class="nv">ANSWER</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ANSWER</span> <span class="p">|</span>tr <span class="o">[</span>A-Z<span class="o">]</span> <span class="o">[</span>a-z<span class="o">]</span><span class="k">)</span>
    <span class="k">else</span>
      <span class="nv">ANSWER</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ANSWER</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      sudo useradd -s /bin/bash -m -G adm,cdrom,sudo,dip,plugdev,www-data,staff <span class="nv">$MISP_USER</span>
      <span class="nb">echo</span> <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_PASSWORD</span> <span class="p">|</span> sudo chpasswd
      <span class="nb">echo</span> <span class="s2">&quot;User </span><span class="nv">$MISP_USER</span><span class="s2"> added, password is: </span><span class="nv">$MISP_PASSWORD</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$ANSWER</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Using </span><span class="nv">$USER</span><span class="s2"> as install user, hope that is what you want.&quot;</span>
      <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Adding </span><span class="nv">$USER</span><span class="s2"> to groups www-data and staff</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="nv">MISP_USER</span><span class="o">=</span><span class="nv">$USER</span>
      sudo adduser <span class="nv">$MISP_USER</span> staff
      sudo adduser <span class="nv">$MISP_USER</span> www-data
    <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;yes or no was asked, try again.&quot;</span>
      sudo adduser <span class="nv">$MISP_USER</span> staff
      sudo adduser <span class="nv">$MISP_USER</span> www-data
      <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;User </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> exists, skipping creation&quot;</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Adding </span><span class="nv">$MISP_USER</span><span class="s2"> to groups www-data and staff</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
    sudo adduser <span class="nv">$MISP_USER</span> staff
    sudo adduser <span class="nv">$MISP_USER</span> www-data
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># pre-install check to make sure what we will be installing on, is ready and not a half installed system</span>
preInstall <span class="o">()</span> <span class="o">{</span>
<span class="c1"># preInstall needs to be able to be called before ANY action. Install/Upgrade/AddTool</span>
<span class="c1"># Pre install wants to be the place too where the following is checked and set via ENV_VAR:</span>
<span class="c1"># Check if composer is installed and functioning</span>
<span class="c1"># Check if misp db is installed (API call would confirm that the DB indeed works)</span>
<span class="c1"># Check apache config (Maybe try to talk to the server via api, this would confirm quite a lot)</span>
<span class="c1"># Check if workers are running/installed, maybe kick them if they are not</span>
<span class="c1"># /var/www/MISP/app/Config/[bootstrap,databases,core,config].php exists</span>
<span class="c1"># /var/www/MISP perms are correct (for $SUDO_WWW useage)</span>
<span class="c1">#</span>

  <span class="c1"># Check if $PATH_TO_MISP exists and is writable by $WWW_USER</span>
  <span class="o">[[</span> -d <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">PATH_TO_MISP_EXISTS</span><span class="o">=</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2"> exists&quot;</span>

  <span class="c1"># .git exists and git is working for $WWW_USER</span>
  <span class="o">[[</span> -d <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.git&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">PATH_TO_GIT_EXISTS</span><span class="o">=</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.git exists&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span> <span class="o">&amp;&amp;</span> <span class="nv">$SUDO_WWW</span> git status

  <span class="c1"># .gnupg exists and working correctly</span>
  <span class="o">[[</span> -d <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">PATH_TO_GNUPG_EXISTS</span><span class="o">=</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PATH_TO_MISP</span><span class="s2">/.gnupg exists&quot;</span>


  <span class="c1"># Extract username, password and dbname</span>
  <span class="c1">##cat database.php |grep -v // |grep -e database -e login -e password |tr -d \&#39; |tr -d \ |tr -d , |tr -d \&gt;</span>
  <span class="nv">DBPASSWORD_MISP</span><span class="o">=</span><span class="k">$(</span>cat database.php <span class="p">|</span>grep -v // <span class="p">|</span>grep -e password <span class="p">|</span>tr -d <span class="se">\&#39;</span> <span class="p">|</span>tr -d <span class="se">\ </span><span class="p">|</span>tr -d , <span class="p">|</span>tr -d <span class="se">\&gt;</span> <span class="p">|</span>cut -f <span class="m">2</span> -d<span class="o">=</span><span class="k">)</span>
  <span class="nv">DBUSER_MISP</span><span class="o">=</span><span class="k">$(</span>cat database.php <span class="p">|</span>grep -v // <span class="p">|</span>grep -e login <span class="p">|</span>tr -d <span class="se">\&#39;</span> <span class="p">|</span>tr -d <span class="se">\ </span><span class="p">|</span>tr -d , <span class="p">|</span>tr -d <span class="se">\&gt;</span> <span class="p">|</span>cut -f <span class="m">2</span> -d<span class="o">=</span><span class="k">)</span>
  <span class="nv">DBNAME</span><span class="o">=</span><span class="k">$(</span>cat database.php <span class="p">|</span>grep -v // <span class="p">|</span>grep -e database <span class="p">|</span>tr -d <span class="se">\&#39;</span> <span class="p">|</span>tr -d <span class="se">\ </span><span class="p">|</span>tr -d , <span class="p">|</span>tr -d <span class="se">\&gt;</span> <span class="p">|</span>cut -f <span class="m">2</span> -d<span class="o">=</span><span class="k">)</span>
  <span class="nv">AUTH_KEY</span><span class="o">=</span><span class="k">$(</span>mysql --disable-column-names -B  -u <span class="nv">$DBUSER_MISP</span> -p<span class="s2">&quot;</span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&quot;</span> <span class="nv">$DBNAME</span> -e <span class="s1">&#39;SELECT authkey FROM users WHERE role_id=1 LIMIT 1&#39;</span><span class="k">)</span>

  <span class="c1"># Check if db exists</span>
  <span class="o">[[</span> -d <span class="s2">&quot;/var/lib/mysql/</span><span class="nv">$DBNAME</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">MISP_DB_DIR_EXISTS</span><span class="o">=</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;/var/lib/mysql/</span><span class="nv">$DBNAME</span><span class="s2"> exists&quot;</span>

  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Place-holder, not implemented yet.</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">exit</span>
<span class="o">}</span>

<span class="c1"># Upgrade function</span>
upgrade <span class="o">()</span> <span class="o">{</span>
  <span class="nv">headerJSON</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span>
  <span class="nv">Acc</span><span class="o">=</span><span class="s2">&quot;Accept:&quot;</span>
  <span class="nv">Autho</span><span class="o">=</span><span class="s2">&quot;Authorization:&quot;</span>
  <span class="nv">CT</span><span class="o">=</span><span class="s2">&quot;Content-Type:&quot;</span>
  <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s2">&quot;https://127.0.0.1&quot;</span>
  <span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app <span class="p">;</span> <span class="nv">$SUDO_WWW</span> php composer.phar update <span class="nv">$SUDO_WWW</span> php composer.phar self-update

  <span class="k">for</span> URN in <span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;galaxies warninglists noticelists objectTemplates taxonomies&quot;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    curl --header <span class="s2">&quot;</span><span class="nv">$Autho</span><span class="s2"> </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> --header <span class="s2">&quot;</span><span class="nv">$Acc</span><span class="s2"> </span><span class="nv">$headerJSON</span><span class="s2">&quot;</span> --header <span class="s2">&quot;</span><span class="nv">$CT</span><span class="s2"> </span><span class="nv">$headerJSON</span><span class="s2">&quot;</span> -k -X POST <span class="nv">$MISP_BASEURL</span>/<span class="nv">$URN</span>/update
  <span class="k">done</span>

  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Place-holder, not implemented yet.</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">exit</span>
<span class="o">}</span>

<span class="c1"># check is /usr/local/src is RW by misp user</span>
checkUsrLocalSrc <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> -e /usr/local/src <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">WRITEABLE</span><span class="o">=</span><span class="k">$(</span>sudo -H -u <span class="nv">$MISP_USER</span> touch /usr/local/src <span class="m">2</span>&gt; /dev/null <span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$WRITEABLE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Good, /usr/local/src exists and is writeable as </span><span class="nv">$MISP_USER</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="c1"># TODO: The below might be shorter, more elegant and more modern</span>
      <span class="c1">#[[ -n $KALI ]] || [[ -n $UNATTENDED ]] &amp;&amp; echo &quot;Just do it&quot; </span>
      <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$KALI</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$UNATTENDED</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">ANSWER</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
      <span class="k">else</span>
        space
        <span class="nb">echo</span> <span class="s2">&quot;/usr/local/src need to be writeable by </span><span class="nv">$MISP_USER</span><span class="s2"> for misp-modules, viper etc.&quot;</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;Permission to fix? (y/n) &quot;</span>
        <span class="nb">read</span> ANSWER
        <span class="nv">ANSWER</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ANSWER</span> <span class="p">|</span>tr <span class="o">[</span>A-Z<span class="o">]</span> <span class="o">[</span>a-z<span class="o">]</span><span class="k">)</span>
        space
      <span class="k">fi</span>
      <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ANSWER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        sudo chmod <span class="m">2775</span> /usr/local/src
        sudo chown root:staff /usr/local/src
      <span class="k">fi</span>
    <span class="k">fi</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;/usr/local/src does not exist, creating.&quot;</span>
    mkdir /usr/local/src
    sudo chmod <span class="m">2775</span> /usr/local/src
    sudo chown root:staff /usr/local/src
  <span class="k">fi</span>
<span class="o">}</span>

kaliSpaceSaver <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># Future function in case Kali overlay on LiveCD is full</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Not implement</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Because Kali is l33t we make sure we run as root</span>
kaliOnRootR0ckz <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> <span class="s2">&quot;This script must be run as root&quot;</span>
   <span class="nb">exit</span> <span class="m">1</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="k">$(</span>id <span class="nv">$MISP_USER</span> &gt;/dev/null<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    useradd -s /bin/bash -m -G adm,cdrom,sudo,dip,plugdev,www-data,staff <span class="nv">$MISP_USER</span>
    <span class="nb">echo</span> <span class="nv">$MISP_USER</span>:<span class="nv">$MISP_PASSWORD</span> <span class="p">|</span> chpasswd
  <span class="k">else</span>
    <span class="c1"># TODO: Make sure we consider this further down the road</span>
    <span class="nb">echo</span> <span class="s2">&quot;User </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2"> exists, skipping creation&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

setBaseURL <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Setting Base URL&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>checkManufacturer<span class="k">)</span> !<span class="o">=</span> <span class="s2">&quot;innotek GmbH&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    debug <span class="s2">&quot;We guess that this is a physical machine and cannot possibly guess what the MISP_BASEURL might be.&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$UNATTENDED</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> 
      <span class="nb">echo</span> <span class="s2">&quot;You can now enter your own MISP_BASEURL, if you wish to NOT do that, the MISP_BASEURL will be empty, which will work, but ideally you configure it afterwards.&quot;</span>
      <span class="nb">echo</span> <span class="s2">&quot;Do you want to change it now? (y/n) &quot;</span>
      <span class="nb">read</span> ANSWER
      <span class="nv">ANSWER</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ANSWER</span> <span class="p">|</span>tr <span class="o">[</span>A-Z<span class="o">]</span> <span class="o">[</span>a-z<span class="o">]</span><span class="k">)</span>
      <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ANSWER</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Please enter the Base URL, e.g: &#39;https://example.org&#39;&quot;</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;Enter Base URL: &quot;</span>
        <span class="nb">read</span> MISP_BASEURL
      <span class="k">else</span>
        <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s1">&#39;&quot;&quot;&#39;</span>
      <span class="k">fi</span>
    <span class="k">else</span>
        <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s2">&quot;https://misp.local&quot;</span>
        <span class="c1"># Webserver configuration</span>
        <span class="nv">FQDN</span><span class="o">=</span><span class="s1">&#39;misp.local&#39;</span>
    <span class="k">fi</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$KALI</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s2">&quot;https://misp.local&quot;</span>
    <span class="c1"># Webserver configuration</span>
    <span class="nv">FQDN</span><span class="o">=</span><span class="s1">&#39;misp.local&#39;</span>
  <span class="k">else</span>
    <span class="nv">MISP_BASEURL</span><span class="o">=</span><span class="s1">&#39;https://localhost:8443&#39;</span>
    <span class="c1"># Webserver configuration</span>
    <span class="nv">FQDN</span><span class="o">=</span><span class="s1">&#39;localhost.localdomain&#39;</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Test and install software RNG</span>
installRNG <span class="o">()</span> <span class="o">{</span>
  sudo modprobe tpm-rng <span class="m">2</span>&gt; /dev/null
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
    <span class="nb">echo</span> tpm-rng <span class="p">|</span> sudo tee -a /etc/modules
  <span class="k">fi</span>
  checkAptLock
  sudo apt install -qy rng-tools <span class="c1"># This might fail on TPM grounds, enable the security chip in your BIOS</span>
  sudo service rng-tools start

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
    sudo apt purge -qy rng-tools
    sudo apt install -qy haveged
    sudo /etc/init.d/haveged start
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Kali upgrade</span>
kaliUpgrade <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Running various Kali upgrade tasks&quot;</span>
  sudo apt update
  checkAptLock
  sudo <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt install --only-upgrade bash libc6 -y
  sudo <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt autoremove -y
<span class="o">}</span>

<span class="c1"># Disables sleep</span>
disableSleep <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Disabling sleep etc if run from a Laptop as the install might take some time&quot;</span> &gt; /dev/tty
  gsettings <span class="nb">set</span> org.gnome.settings-daemon.plugins.power sleep-inactive-ac-timeout <span class="m">0</span> <span class="m">2</span>&gt; /dev/null
  gsettings <span class="nb">set</span> org.gnome.settings-daemon.plugins.power sleep-inactive-battery-timeout <span class="m">0</span> <span class="m">2</span>&gt; /dev/null
  gsettings <span class="nb">set</span> org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type nothing <span class="m">2</span>&gt; /dev/null
  gsettings <span class="nb">set</span> org.gnome.desktop.screensaver lock-enabled <span class="nb">false</span> <span class="m">2</span>&gt; /dev/null
  gsettings <span class="nb">set</span> org.gnome.desktop.screensaver idle-activation-enabled <span class="nb">false</span> <span class="m">2</span>&gt; /dev/null

  setterm -blank <span class="m">0</span> -powersave off -powerdown <span class="m">0</span>
  xset s <span class="m">0</span> <span class="m">0</span> <span class="m">2</span>&gt; /dev/null
  xset dpms <span class="m">0</span> <span class="m">0</span> <span class="m">2</span>&gt; /dev/null
  xset dpms force off
  xset s off <span class="m">2</span>&gt; /dev/null
  service sleepd stop
  <span class="nb">kill</span> <span class="k">$(</span>lsof <span class="p">|</span> grep <span class="s1">&#39;sleepd&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
  checkAptLock
<span class="o">}</span>

<span class="c1"># Remove alias if present</span>
<span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span><span class="nb">type</span> -t checkAptLock<span class="k">)</span> <span class="o">==</span> <span class="s2">&quot;alias&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">unalias</span> checkAptLock<span class="p">;</span> <span class="k">fi</span>
<span class="c1"># Simple function to make sure APT is not locked</span>
checkAptLock <span class="o">()</span> <span class="o">{</span>
  <span class="nv">SLEEP</span><span class="o">=</span><span class="m">3</span>
  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DONE</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    sudo apt-get check <span class="m">2</span>&gt; /dev/null &gt; /dev/null <span class="o">&amp;&amp;</span> <span class="nv">DONE</span><span class="o">=</span><span class="m">0</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">apt</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> is maybe </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">locked</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">, waiting </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="nv">$SLEEP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> seconds.&quot;</span> &gt; /dev/tty
    sleep <span class="nv">$SLEEP</span>
    <span class="nv">SLEEP</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$SLEEP</span>+3<span class="o">]</span>
  <span class="k">done</span>
  <span class="nb">unset</span> DONE
<span class="o">}</span>

<span class="c1"># &lt;snippet-begin 0_installDepsPhp73.sh&gt;</span>
<span class="c1"># Install Php 7.3 deps</span>
installDepsPhp73 <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing PHP 7.3 dependencies&quot;</span>
  <span class="nv">PHP_ETC_BASE</span><span class="o">=</span>/etc/php/7.3
  <span class="nv">PHP_INI</span><span class="o">=</span><span class="si">${</span><span class="nv">PHP_ETC_BASE</span><span class="si">}</span>/apache2/php.ini
  sudo apt update
  checkAptLock
  sudo apt install -qy <span class="se">\</span>
  libapache2-mod-php7.3 <span class="se">\</span>
  php7.3 php7.3-cli <span class="se">\</span>
  php7.3-dev <span class="se">\</span>
  php7.3-json php7.3-xml php7.3-mysql php7.3-opcache php7.3-readline php7.3-mbstring <span class="se">\</span>
  php-pear <span class="se">\</span>
  php-redis php-gnupg
<span class="o">}</span>
<span class="c1"># &lt;snippet-end 0_installDepsPhp73.sh&gt;</span>

<span class="c1"># Installing core dependencies</span>
installDeps <span class="o">()</span> <span class="o">{</span>
  debug <span class="s2">&quot;Installing core dependencies&quot;</span>
  checkAptLock
  sudo apt update
  sudo apt install -qy etckeeper
  <span class="c1"># Skip dist-upgrade for now, pulls in 500+ updated packages</span>
  <span class="c1">#sudo apt -y dist-upgrade</span>
  <span class="nv">gitMail</span><span class="o">=</span><span class="k">$(</span>git config --global --get user.email <span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
    git config --global user.email <span class="s2">&quot;root@kali.lan&quot;</span>
  <span class="k">fi</span>
  <span class="nv">gitUser</span><span class="o">=</span><span class="k">$(</span>git config --global --get user.name <span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
    git config --global user.name <span class="s2">&quot;Root User&quot;</span>
  <span class="k">fi</span>

  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$UNATTENDED</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> sudo <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt install -qy postfix <span class="o">||</span> sudo apt install -qy postfix

  sudo apt install -qy <span class="se">\</span>
  curl gcc git gnupg-agent make openssl redis-server neovim zip libyara-dev python3-yara python3-redis python3-zmq <span class="se">\</span>
  mariadb-client <span class="se">\</span>
  mariadb-server <span class="se">\</span>
  apache2 apache2-doc apache2-utils <span class="se">\</span>
  python3-dev python3-pip libpq5 libjpeg-dev libfuzzy-dev ruby asciidoctor <span class="se">\</span>
  libxml2-dev libxslt1-dev zlib1g-dev python3-setuptools expect

  installRNG
<span class="o">}</span>

<span class="c1"># On Kali, the redis start-up script is broken. This tries to fix it.</span>
fixRedis <span class="o">()</span> <span class="o">{</span>
  <span class="c1"># As of 20190124 redis-server init.d scripts are broken and need to be replaced</span>
  sudo mv /etc/init.d/redis-server /etc/init.d/redis-server_<span class="sb">`</span>date +%Y%m%d<span class="sb">`</span>

  <span class="nb">echo</span> <span class="s1">&#39;#! /bin/sh</span>
<span class="s1">### BEGIN INIT INFO</span>
<span class="s1"># Provides:     redis-server</span>
<span class="s1"># Required-Start:   $syslog</span>
<span class="s1"># Required-Stop:    $syslog</span>
<span class="s1"># Should-Start:     $local_fs</span>
<span class="s1"># Should-Stop:      $local_fs</span>
<span class="s1"># Default-Start:    2 3 4 5</span>
<span class="s1"># Default-Stop:     0 1 6</span>
<span class="s1"># Short-Description:    redis-server - Persistent key-value db</span>
<span class="s1"># Description:      redis-server - Persistent key-value db</span>
<span class="s1">### END INIT INFO</span>

<span class="s1">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span>
<span class="s1">DAEMON=/usr/bin/redis-server</span>
<span class="s1">DAEMON_ARGS=/etc/redis/redis.conf</span>
<span class="s1">NAME=redis-server</span>
<span class="s1">DESC=redis-server</span>
<span class="s1">PIDFILE=/var/run/redis.pid</span>

<span class="s1">test -x $DAEMON || exit 0</span>
<span class="s1">test -x $DAEMONBOOTSTRAP || exit 0</span>

<span class="s1">set -e</span>

<span class="s1">case &quot;$1&quot; in</span>
<span class="s1">  start)</span>
<span class="s1">    echo -n &quot;Starting $DESC: &quot;</span>
<span class="s1">    touch $PIDFILE</span>
<span class="s1">    chown redis:redis $PIDFILE</span>
<span class="s1">    if start-stop-daemon --start --quiet --umask 007 --pidfile $PIDFILE --chuid redis:redis --exec $DAEMON -- $DAEMON_ARGS</span>
<span class="s1">    then</span>
<span class="s1">        echo &quot;$NAME.&quot;</span>
<span class="s1">    else</span>
<span class="s1">        echo &quot;failed&quot;</span>
<span class="s1">    fi</span>
<span class="s1">    ;;</span>
<span class="s1">  stop)</span>
<span class="s1">    echo -n &quot;Stopping $DESC: &quot;</span>
<span class="s1">    if start-stop-daemon --stop --retry 10 --quiet --oknodo --pidfile $PIDFILE --exec $DAEMON</span>
<span class="s1">    then</span>
<span class="s1">        echo &quot;$NAME.&quot;</span>
<span class="s1">    else</span>
<span class="s1">        echo &quot;failed&quot;</span>
<span class="s1">    fi</span>
<span class="s1">    rm -f $PIDFILE</span>
<span class="s1">    ;;</span>

<span class="s1">  restart|force-reload)</span>
<span class="s1">    ${0} stop</span>
<span class="s1">    ${0} start</span>
<span class="s1">    ;;</span>
<span class="s1">  *)</span>
<span class="s1">    echo &quot;Usage: /etc/init.d/$NAME {start|stop|restart|force-reload}&quot; &gt;&amp;2</span>
<span class="s1">    exit 1</span>
<span class="s1">    ;;</span>
<span class="s1">esac</span>

<span class="s1">exit 0&#39;</span> <span class="p">|</span> sudo tee /etc/init.d/redis-server
  sudo chmod <span class="m">755</span> /etc/init.d/redis-server
  sudo /etc/init.d/redis-server start
<span class="o">}</span>

<span class="c1"># generate MISP apache conf</span>
genApacheConf <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;&lt;VirtualHost _default_:80&gt;</span>
<span class="s2">          ServerAdmin admin@localhost.lu</span>
<span class="s2">          ServerName misp.local</span>

<span class="s2">          Redirect permanent / https://misp.local</span>

<span class="s2">          LogLevel warn</span>
<span class="s2">          ErrorLog /var/log/apache2/misp.local_error.log</span>
<span class="s2">          CustomLog /var/log/apache2/misp.local_access.log combined</span>
<span class="s2">          ServerSignature Off</span>
<span class="s2">  &lt;/VirtualHost&gt;</span>

<span class="s2">  &lt;VirtualHost _default_:443&gt;</span>
<span class="s2">          ServerAdmin admin@localhost.lu</span>
<span class="s2">          ServerName misp.local</span>
<span class="s2">          DocumentRoot </span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/webroot</span>

<span class="s2">          &lt;Directory </span><span class="nv">$PATH_TO_MISP</span><span class="s2">/app/webroot&gt;</span>
<span class="s2">                  Options -Indexes</span>
<span class="s2">                  AllowOverride all</span>
<span class="s2">                    Require all granted</span>
<span class="s2">                  Order allow,deny</span>
<span class="s2">                  allow from all</span>
<span class="s2">          &lt;/Directory&gt;</span>

<span class="s2">          SSLEngine On</span>
<span class="s2">          SSLCertificateFile /etc/ssl/private/misp.local.crt</span>
<span class="s2">          SSLCertificateKeyFile /etc/ssl/private/misp.local.key</span>
<span class="s2">  #        SSLCertificateChainFile /etc/ssl/private/misp-chain.crt</span>

<span class="s2">          LogLevel warn</span>
<span class="s2">          ErrorLog /var/log/apache2/misp.local_error.log</span>
<span class="s2">          CustomLog /var/log/apache2/misp.local_access.log combined</span>
<span class="s2">          ServerSignature Off</span>
<span class="s2">          Header set X-Content-Type-Options nosniff</span>
<span class="s2">          Header set X-Frame-Options DENY</span>
<span class="s2">  &lt;/VirtualHost&gt;&quot;</span> <span class="p">|</span> tee /etc/apache2/sites-available/misp-ssl.conf
<span class="o">}</span>

<span class="c1"># Add git pull update mechanism to rc.local - TODO: Make this better</span>
gitPullAllRCLOCAL <span class="o">()</span> <span class="o">{</span>
  sed -i -e <span class="s1">&#39;$i \git_dirs=&quot;/usr/local/src/misp-modules/ /var/www/misp-dashboard /usr/local/src/faup /usr/local/src/mail_to_misp /usr/local/src/misp-modules /usr/local/src/viper /var/www/misp-dashboard&quot;\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \for d in $git_dirs; do\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \    echo &quot;Updating ${d}&quot;\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \    cd $d &amp;&amp; sudo git pull &amp;\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \done\n&#39;</span> /etc/rc.local
<span class="o">}</span>

<span class="c1"># Composer on php 7.2 does not need any special treatment the provided phar works well</span>
composer72 <span class="o">()</span> <span class="o">{</span>
  <span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app
  mkdir /var/www/.composer <span class="p">;</span> chown www-data:www-data /var/www/.composer
  <span class="nv">$SUDO_WWW</span> php composer.phar require kamisama/cake-resque:4.1.2
  <span class="nv">$SUDO_WWW</span> php composer.phar config vendor-dir Vendor
  <span class="nv">$SUDO_WWW</span> php composer.phar install
<span class="o">}</span>

<span class="c1"># Composer on php 7.3 needs a recent version of composer.phar</span>
composer73 <span class="o">()</span> <span class="o">{</span>
  <span class="nb">cd</span> <span class="nv">$PATH_TO_MISP</span>/app
  mkdir /var/www/.composer <span class="p">;</span> chown www-data:www-data /var/www/.composer
  <span class="c1"># Update composer.phar</span>
  <span class="c1"># If hash changes, check here: https://getcomposer.org/download/ and replace with the correct one</span>
  <span class="c1"># Current Sum for: v1.8.3</span>
  <span class="nv">SHA384_SUM</span><span class="o">=</span><span class="s1">&#39;48e3236262b34d30969dca3c37281b3b4bbe3221bda826ac6a9a62d6444cdb0dcd0615698a5cbe587c3f0fe57a54d8f5&#39;</span>
  sudo -H -u www-data php -r <span class="s2">&quot;copy(&#39;https://getcomposer.org/installer&#39;, &#39;composer-setup.php&#39;);&quot;</span>
  sudo -H -u www-data php -r <span class="s2">&quot;if (hash_file(&#39;SHA384&#39;, &#39;composer-setup.php&#39;) === &#39;</span><span class="nv">$SHA384_SUM</span><span class="s2">&#39;) { echo &#39;Installer verified&#39;; } else { echo &#39;Installer corrupt&#39;; unlink(&#39;composer-setup.php&#39;); exit(137); } echo PHP_EOL;&quot;</span>
  checkFail <span class="s2">&quot;composer.phar checksum failed, please investigate manually. &quot;</span> <span class="nv">$?</span>
  sudo -H -u www-data php composer-setup.php
  sudo -H -u www-data php -r <span class="s2">&quot;unlink(&#39;composer-setup.php&#39;);&quot;</span>
  <span class="nv">$SUDO_WWW</span> php composer.phar require kamisama/cake-resque:4.1.2
  <span class="nv">$SUDO_WWW</span> php composer.phar config vendor-dir Vendor
  <span class="nv">$SUDO_WWW</span> php composer.phar install
<span class="o">}</span>

<span class="c1"># Enable various core services</span>
enableServices <span class="o">()</span> <span class="o">{</span>
    update-rc.d mysql <span class="nb">enable</span>
    update-rc.d apache2 <span class="nb">enable</span>
    update-rc.d redis-server <span class="nb">enable</span>
<span class="o">}</span>

<span class="c1"># Generate rc.local</span>
genRCLOCAL <span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> ! -e /etc/rc.local <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s1">&#39;#!/bin/sh -e&#39;</span> <span class="p">|</span> tee -a /etc/rc.local
      <span class="nb">echo</span> <span class="s1">&#39;exit 0&#39;</span> <span class="p">|</span> tee -a /etc/rc.local
      chmod u+x /etc/rc.local
  <span class="k">fi</span>

  sed -i -e <span class="s1">&#39;$i \echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \echo 1024 &gt; /proc/sys/net/core/somaxconn\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \sysctl vm.overcommit_memory=1\n&#39;</span> /etc/rc.local
  sed -i -e <span class="s1">&#39;$i \sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\n&#39;</span> /etc/rc.local
<span class="o">}</span>

<span class="c1"># Final function to let the user know what happened</span>
theEnd <span class="o">()</span> <span class="o">{</span>
  space
  <span class="nb">echo</span> <span class="s2">&quot;Admin (root) DB Password: </span><span class="nv">$DBPASSWORD_ADMIN</span><span class="s2">&quot;</span> &gt; /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/mysql.txt
  <span class="nb">echo</span> <span class="s2">&quot;User  (misp) DB Password: </span><span class="nv">$DBPASSWORD_MISP</span><span class="s2">&quot;</span> &gt;&gt; /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/mysql.txt
  <span class="nb">echo</span> <span class="s2">&quot;Authkey: </span><span class="nv">$AUTH_KEY</span><span class="s2">&quot;</span> &gt; /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/MISP-authkey.txt

  clear
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> Installed, access here: </span><span class="si">${</span><span class="nv">MISP_BASEURL</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">&quot;User: admin@admin.test&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Password: admin&quot;</span>
  space
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$DASHBOARD</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> Dashboard, access here: </span><span class="si">${</span><span class="nv">MISP_BASEURL</span><span class="si">}</span><span class="s2">:8001&quot;</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$DASHBOARD</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> space
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">&quot;viper-web installed, access here: </span><span class="si">${</span><span class="nv">MISP_BASEURL</span><span class="si">}</span><span class="s2">:8888&quot;</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">&quot;viper-cli configured with your </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Site Admin Auth Key</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;User: admin&quot;</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Password: Password1234&quot;</span>
  <span class="o">[[</span> -n <span class="nv">$KALI</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$VIPER</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> -n <span class="nv">$ALL</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> space
  <span class="nb">echo</span> -e <span class="s2">&quot;The following files were created and need either </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">protection or removal</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> (</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">shred</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> on the CLI)&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;/home/</span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">/mysql.txt&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Contents:</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  cat /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/mysql.txt
  <span class="nb">echo</span> <span class="s2">&quot;/home/</span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">/MISP-authkey.txt&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Contents:</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
  cat /home/<span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>/MISP-authkey.txt
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;The </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">LOCAL</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2"> system credentials:&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;User: </span><span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Password: </span><span class="si">${</span><span class="nv">MISP_PASSWORD</span><span class="si">}</span><span class="s2"> # Or the password you used of your custom user&quot;</span>
  space
  <span class="nb">echo</span> <span class="s2">&quot;To enable outgoing mails via postfix set a permissive SMTP server for the domains you want to contact:&quot;</span>
  <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">&quot;sudo postconf -e &#39;relayhost = example.com&#39;&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;sudo postfix reload&quot;</span>
  space
  <span class="nb">echo</span> -e <span class="s2">&quot;Enjoy using </span><span class="si">${</span><span class="nv">LBLUE</span><span class="si">}</span><span class="s2">MISP</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">. For any issues see here: https://github.com/MISP/MISP/issues&quot;</span>
  space
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$UNATTENDED</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Unattended install!</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;This means we guessed the Base URL, it might be wrong, please double check.&quot;</span>
    space
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$USER</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$MISP_USER</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    sudo su - <span class="si">${</span><span class="nv">MISP_USER</span><span class="si">}</span>
  <span class="k">fi</span>
<span class="o">}</span>
<span class="c1">## End Function Section Nothing allowed in .md after this line ##</span>
<span class="c1"># &lt;snippet-end 0_support-functions.sh&gt;</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
          <a href="../INSTALL.kali/" title="Kali Linux" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Kali Linux
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 MISP Project
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://www.misp-project.org/" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/MISP" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/MISPProject" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>